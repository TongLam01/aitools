<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek商事合同诊断助手 V1.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        .prose table { border-collapse: collapse; width: 100%; margin: 1.5em 0; border: 1px solid #333; }
        .prose th, .prose td { border: 1px solid #d1d5db; padding: 10px; text-align: left; }
        .prose th { background-color: #f3f4f6; }
        /* 优化阅读行距与间距 */
        .prose { line-height: 1.5; color: #334155; }
        .prose p { margin-bottom: 1.5em; }
        .prose li { margin-bottom: 0.5em; }
        
        .file-upload-zone { border: 2px dashed #cbd5e1; transition: all 0.2s; cursor: pointer; }
        .file-upload-zone:hover { border-color: #10b981; background-color: #f0fdf4; }
        .btn-waiting { background-color: #94a3b8 !important; cursor: not-allowed; opacity: 0.6; }
        .btn-active { background-color: #059669 !important; cursor: pointer; animation: glow 1.5s infinite; }
        @keyframes glow { 0% { box-shadow: 0 0 5px #10b981; } 50% { box-shadow: 0 0 15px #10b981; } 100% { box-shadow: 0 0 5px #10b981; } }
        
        /* 闪烁思考效果 */
        .thinking-blink { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .3; } }

        /* 指定 API Key 占位符字号为 12px */
        #apiKey::placeholder { font-size: 12px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-8">
        <header class="mb-8 flex justify-between items-end border-b pb-4">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight">合同诊断助手 <span class="text-emerald-600 text-sm font-normal ml-2 italic">V1.0 自动脱敏版</span></h1>
                <p class="text-slate-500 mt-1 italic italic">本地脱敏，DeepSeek诊断，仅供参考</p>
            </div>
            <div class="flex space-x-3">
                <button id="exportBtn" disabled onclick="exportToWord()" class="btn-waiting text-white px-5 py-2 rounded-lg text-sm font-bold shadow-sm transition-all">
                    导出报告
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <aside class="lg:col-span-4 space-y-5">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center text-sm">
                        <span class="w-2 h-5 bg-emerald-500 rounded mr-2"></span>任务配置
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-slate-400 uppercase flex justify-between items-center">
                                <span>API Key（必填）</span>
                                <a href="https://platform.deepseek.com/" target="_blank" class="text-emerald-600 text-xs lowercase font-normal italic hover:underline">去获得官方Key</a>
                            </label>
                            <input type="password" id="apiKey" class="mt-1 block w-full rounded-lg border-slate-200 bg-slate-50 p-2 text-sm border shadow-sm" placeholder="填入DeepSeek官方API Key并充值">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-400 uppercase mb-1">合同上传 (可选)</label>
                            <div class="file-upload-zone rounded-lg p-3 text-center relative" id="uploadArea">
                                <input type="file" id="fileInput" class="absolute inset-0 opacity-0 cursor-pointer" accept=".docx,.pdf">
                                <div class="text-slate-400 text-[12px]" id="fileStatus">本地解析+自动脱敏</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-bold text-slate-400 uppercase">身份</label>
                                <select id="role" class="mt-1 block w-full rounded-lg border-slate-200 bg-slate-50 p-2 text-xs border font-bold">
                                    <option value="甲方">我是 甲方</option>
                                    <option value="乙方">我是 乙方</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-400 uppercase">模型</label>
                                <select id="model" class="mt-1 block w-full rounded-lg border-slate-200 bg-slate-50 p-2 text-xs border font-bold">
                                    <option value="deepseek-reasoner">DeepSeek-R1 (深度思维)</option>
                                    <option value="deepseek-chat">DeepSeek-V3 (极速模式)</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-400 uppercase text-emerald-600">★ 特别关注点（必填）</label>
                            <input type="text" id="focus" class="mt-1 block w-full rounded-lg border-emerald-200 bg-emerald-50 p-2.5 text-xs border shadow-inner" placeholder="例如合规、公平性">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-400 uppercase">脱敏预览 或 在此粘贴合同文本</label>
                            <textarea id="contractText" rows="10" class="mt-1 block w-full rounded-lg border-slate-200 bg-slate-50 p-2.5 text-[11px] border font-mono" placeholder="脱敏数据展示..."></textarea>
                        </div>
                        <button onclick="startInitialAudit()" id="submitBtn" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-black transition-all shadow-lg text-sm">
                            提交并开始诊断
                        </button>
                    </div>
                </div>
            </aside>

            <main class="lg:col-span-8 flex flex-col h-[85vh]">
                <div id="chatScrollZone" class="flex-1 bg-white p-10 rounded-2xl shadow-sm border border-slate-200 overflow-y-auto mb-4 relative">
                    <div id="reportOutput" class="prose prose-slate max-w-none">
                        <div class="text-center py-24 text-slate-300 uppercase tracking-widest text-xs">等待任务启动</div>
                    </div>
                </div>
                <div id="followUpZone" class="hidden bg-white p-4 rounded-xl border border-slate-200 shadow-xl">
                    <div class="flex space-x-3">
                        <input type="text" id="followUpInput" class="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-emerald-500" placeholder="追问细节...">
                        <button onclick="sendFollowUp()" id="sendFollowUpBtn" class="bg-emerald-600 text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-emerald-700">发送追问</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // PDF.js 初始化
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let identityMap = new Map();
        let companyCount = 0;
        let addressCount = 0;
        let originalFileName = "手动输入";
        let chatHistory = [];

        // --- 核心脱敏算法 V3.5 ---
        function secureDeIdentify(text) {
            if (!text) return "";
            let result = text;
            
            // 优化点：
            // 1. 公司正则：有限公司等直接匹配；“中心/厂/校”等弱特征词改为必须配合地域前缀识别，防止误伤“康养中心”；“会”精准化防止误伤“统一社会”。
            // 2. 地址正则：通过负向先行断言 (?!域) 确保“区域”不被匹配；通过 (?!社区|双方) 排除非地址前缀。
            const companyRegex = /(?:[\u4e00-\u9fa5]{2,30})(?:有限公司|有限责任公司|集团|研究所|事务所|分公司|代表处)|(?!(?:社区|双方))(?:[\u4e00-\u9fa5]{2,10}(?:省|市|区(?!域)|县))[\u4e00-\u9fa5]{0,20}(?:中心|工厂|学校|协会|商会)/g;
            const addressRegex = /(?!(?:社区|双方))(?:[\u4e00-\u9fa5]{2,}(?:省|自治区|市|区(?!域)|县|镇|街道|路|街|弄))+(?:[\u4e00-\u9fa5\d\-A-Za-z]+(?:号|幢|栋|单元|层|室|房|弄))/g;

            let rawMatches = Array.from(new Set([
                ...(text.match(companyRegex) || []),
                ...(text.match(addressRegex) || [])
            ]));

            let filteredMatches = rawMatches.filter((item, index) => {
                return !rawMatches.some((other, otherIndex) => {
                    return index !== otherIndex && other.includes(item);
                });
            });

            filteredMatches.sort((a, b) => b.length - a.length);

            filteredMatches.forEach(trimmedStr => {
                if (!identityMap.has(trimmedStr)) {
                    // 重新检测是公司还是地址
                    const isAddress = addressRegex.test(trimmedStr);
                    addressRegex.lastIndex = 0;
                    
                    if (isAddress) {
                        addressCount++;
                        identityMap.set(trimmedStr, `[地址_${addressCount}]`);
                    } else {
                        companyCount++;
                        identityMap.set(trimmedStr, `[企业_${String.fromCharCode(64 + companyCount)}]`);
                    }
                }
                const escaped = trimmedStr.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                result = result.replace(new RegExp(escaped, 'g'), identityMap.get(trimmedStr));
            });
            return result;
        }

        const SYSTEM_PROMPT = `你是一位拥有 20 年执业经验、以“毒辣、严谨、实战派”著称的顶尖商事律师。你审阅合同不仅关注文字的逻辑，更擅长像外科医生一样进行“穿透式诊断”——不仅看合同“说了什么（名）”，更看合同“想干什么（实）”。

你审阅合同的风格是“既看森林，也看每一片叶子的叶脉”。你深信：任何一处术语的不统一、任何一个变相的剥夺条款，都是潜伏的“诉讼地雷”。输出结果中请直接显示诊断内容，不要包含任何律师落款或个人签名（如：'您的律师：...'等）。

---

# 一、 审查方法论：三层扫描体系
1. 第一层：宏观结构审查（核心器官：合法合规、主体资格、标的、价款、违约、解除、管辖）。
2. 第二层：微观细节审查（显微镜排查：术语一致、时间颗粒度、被动语态陷阱、触发条件量化、黑洞条款、送达证据链）。
3. 第三层：穿透式 X 光扫描（实质风险识别：变相融资、变相劳动、变相担保、变相排他）。

# 二、 输出格式要求（必须严格遵守）
## 1. 核心效力与合规诊断（表格）
## 2. 穿透式实质风险报告（X-Ray Report 表格，揭露“名”与“实”）
## 3. 逐条细节清单与修订方案（表格，必须提供“手术方案”：即修订后的直接可用文本）
## 4. 缺失条款补充建议
## 5. 律师最后总结`;

        // 文档读取
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            originalFileName = file.name.replace(/\.[^/.]+$/, "");
            document.getElementById('fileStatus').innerHTML = `已载入: ${file.name}`;
            try {
                let rawText = "";
                if (file.name.endsWith('.docx')) {
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({arrayBuffer});
                    rawText = result.value;
                } else if (file.name.endsWith('.pdf')) {
                    const arrayBuffer = await file.arrayBuffer();
                    const loadingTask = pdfjsLib.getDocument({data: arrayBuffer});
                    const pdf = await loadingTask.promise;
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        rawText += content.items.map(item => item.str).join(" ") + "\n";
                    }
                }
                document.getElementById('contractText').value = secureDeIdentify(rawText);
            } catch (err) { alert("文档载入失败"); }
        });

        // --- 核心对话引擎 (加入“思考中”逻辑) ---
        async function callAI(messages) {
            const apiKey = document.getElementById('apiKey').value || localStorage.getItem('ds_api_key');
            const model = document.getElementById('model').value;
            const exportBtn = document.getElementById('exportBtn');
            const output = document.getElementById('reportOutput');

            exportBtn.disabled = true;
            exportBtn.className = "btn-waiting text-white px-5 py-2 rounded-lg text-sm font-bold shadow-sm transition-all";

            const msgDiv = document.createElement('div');
            msgDiv.className = "mb-10";
            
            // 1. 创建并插入“思考中”提示
            const thinkingDiv = document.createElement('div');
            thinkingDiv.id = "thinking-indicator";
            thinkingDiv.className = "flex items-center space-x-2 text-emerald-600 font-bold text-sm py-4 thinking-blink";
            thinkingDiv.innerHTML = `
                <svg class="animate-spin h-5 w-5 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>AI正在思考中...</span>
            `;
            output.appendChild(msgDiv);
            msgDiv.appendChild(thinkingDiv);
            
            document.getElementById('chatScrollZone').scrollTop = document.getElementById('chatScrollZone').scrollHeight;

            let fullContent = "";
            let hasStartedStream = false;

            try {
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({ model, messages, stream: true })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                            const data = JSON.parse(line.slice(6));
                            const delta = data.choices[0].delta.content || "";
                            
                            if (delta) {
                                // 2. 一旦收到数据，立刻清除思考提示
                                if (!hasStartedStream) {
                                    thinkingDiv.remove();
                                    hasStartedStream = true;
                                }
                                fullContent += delta;
                                msgDiv.innerHTML = marked.parse(fullContent);
                                document.getElementById('chatScrollZone').scrollTop = document.getElementById('chatScrollZone').scrollHeight;
                            }
                        }
                    }
                }
                chatHistory.push({ role: "assistant", content: fullContent });
                exportBtn.disabled = false;
                exportBtn.className = "btn-active text-white px-5 py-2 rounded-lg text-sm font-bold shadow-sm transition-all";
            } catch (e) { 
                thinkingDiv.remove();
                msgDiv.innerHTML += `<p class="text-red-500">连接异常: ${e.message}</p>`; 
            }
        }

        async function startInitialAudit() {
            const role = document.getElementById('role').value;
            const focus = document.getElementById('focus').value;
            const textarea = document.getElementById('contractText');
            const apiKey = document.getElementById('apiKey').value;
            
            let currentText = textarea.value.trim();
            if (!apiKey || !currentText || !focus) return alert('信息不完整');
            
            const maskedText = secureDeIdentify(currentText);
            textarea.value = maskedText; 

            localStorage.setItem('ds_api_key', apiKey);
            document.getElementById('reportOutput').innerHTML = "";
            document.getElementById('followUpZone').classList.remove('hidden');
            
            chatHistory = [
                { role: "system", content: SYSTEM_PROMPT },
                { role: "user", content: `【身份】：${role}\n【特别关注】：${focus}\n\n【文本】：\n${maskedText}` }
            ];
            await callAI(chatHistory);
        }

        async function sendFollowUp() {
            const input = document.getElementById('followUpInput');
            const q = input.value.trim();
            if (!q) return;
            const maskedQ = secureDeIdentify(q);
            input.value = "";
            const qUi = document.createElement('div');
            qUi.className = "bg-emerald-50 p-4 rounded-xl mb-6 text-sm border-l-4 border-emerald-500 font-medium";
            qUi.innerHTML = `<span class="text-emerald-700 font-bold">追问AI：</span> ${maskedQ}`;
            document.getElementById('reportOutput').appendChild(qUi);
            chatHistory.push({ role: "user", content: maskedQ });
            await callAI(chatHistory);
        }

        function exportToWord() {
            const content = document.getElementById('reportOutput').innerHTML;
            const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, "");
            const styles = `<style>body { font-family: 'SimSun', serif; font-size: 10.5pt; } table { width: 100%; border-collapse: collapse; } th, td { border: 1pt solid black; padding: 6pt; } h1 { text-align: center; border-bottom: 2pt solid black; } h2 { color: #059669; border-left: 5pt solid #059669; padding-left: 10pt; }</style>`;
            const html = `<html><head><meta charset='utf-8'>${styles}</head><body><h1>审核报告</h1><p style='text-align:right'>关联：${originalFileName}</p><hr>${content}</body></html>`;
            const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${originalFileName}_报告_${timestamp}.doc`;
            a.click();
        }

        // 绑定回车键逻辑
        document.getElementById('followUpInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                sendFollowUp();
            }
        });
    </script>
    <script src="common.js"></script>
</body>
</html>
