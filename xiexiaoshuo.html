<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DeepSeekå°è¯´åˆ›ä½œå·¥å…·</title>
    <style>
        :root {
            --bg: #f5f5f7;
            --card: #ffffff;
            --text: #1d1d1f;
            --text-sub: #86868b;
            --accent: #0071e3; 
            --danger: #ff3b30;
            --success: #34c759;
            --border: #d2d2d7;
            --wiki-bg: #f2faff;
            --fact-bg: #fffcf0; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
            background: var(--bg); color: var(--text);
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column; overflow: hidden;
        }

        #mobile-tabs {
            display: none; background: var(--card);
            border-bottom: 1px solid var(--border);
            justify-content: space-around; padding: 8px 0;
            flex-shrink: 0; z-index: 1000;
        }
        .tab-item { font-size: 14px; font-weight: 600; color: var(--text-sub); padding: 6px 16px; border-radius: 20px; transition: 0.2s; }
        .tab-item.active { color: #fff; background: var(--accent); }

        #layout-wrapper { display: flex; flex: 1; overflow: hidden; height: 100%; }

        .panel { display: flex; flex-direction: column; padding: 20px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        #static-sidebar { width: 300px; background: #fbfbfd; border-right: 1px solid var(--border); }
        #dynamic-sidebar { width: 340px; background: #fbfbfd; border-left: 1px solid var(--border); }
        
        #main-container { flex: 1; display: flex; flex-direction: column; background: #fff; overflow: hidden; position: relative; }

        #editor-wrapper { 
            height: 16%; min-height: 150px;
            display: flex; flex-direction: column; 
            border-bottom: 1px solid var(--border); 
            background: rgba(255, 255, 255, 0.95);
            z-index: 10; flex-shrink: 0;
        }
        #novel-content { flex: 1; padding: 20px; border: none; font-size: 14px; line-height: 1.2; outline: none; resize: none; background: transparent; }

        #history-wrapper { flex: 1; padding: 20px; overflow-y: auto; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; background: #f5f5f7; }

        #control-bar { 
            padding: 12px 15px; display: flex; gap: 10px; align-items: center; 
            background: var(--card); border-top: 1px solid var(--border);
            flex-shrink: 0;
        }

        h3 { font-size: 11px; font-weight: 700; color: var(--text-sub); margin: 0 0 10px 0; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; }
        label { display: block; font-size: 13px; font-weight: 600; margin: 15px 0 5px 0; color: #333; }
        .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; color: white; margin-left: 5px; background: #999; }
        .tips { font-size: 10px; color: #86868b; margin-bottom: 4px; line-height: 1.4; }
        
        textarea, input, select { 
            width: 100%; border: 1px solid var(--border); border-radius: 8px; 
            padding: 10px; font-size: 14px; background: var(--card); 
            transition: border 0.2s; font-family: inherit;
        }
        textarea:focus, input:focus, select:focus { border-color: var(--accent); outline: none; }
        
        /* ä¼˜åŒ–ï¼šå¤‡æ³¨æ–‡æœ¬æ ·å¼ */
        textarea::placeholder, input::placeholder { color: #b0b0b5; transition: color 0.2s; }
        textarea:focus::placeholder, input:focus::placeholder { color: transparent; }

        .input-wiki { background-color: var(--wiki-bg) !important; border-color: #bce3ff; color: #004085; font-size: 13px; font-family: "Menlo", monospace; }
        .input-fact { background-color: var(--fact-bg) !important; }
        .input-must { background-color: #fff1f0 !important; border-color: #ffbaba; }

        .btn { padding: 0 16px; height: 42px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; white-space: nowrap; transition: opacity 0.2s; }
        .btn:active { opacity: 0.7; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-update { background: #0071e3 !important; color: white !important; width: 100%; margin-bottom: 15px; padding: 12px; height: auto; box-shadow: 0 2px 5px rgba(0,113,227,0.2); }
        .btn-outline { background: var(--card); border: 1px solid var(--border); color: var(--text); }
        .btn-sm { height: 32px; font-size: 12px; padding: 0 10px; }
        .btn-stop { background: var(--danger); color: white; }

        .history-card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.05); }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
        .history-body { font-size: 16px; line-height: 1.6; white-space: pre-wrap; transition: max-height 0.3s ease; overflow: hidden; }
        .collapsed .history-body { max-height: 80px; mask-image: linear-gradient(to bottom, black 50%, transparent 100%); }
        .serial-number { color: var(--danger); font-size: 24px; font-weight: 800; display: inline-block; margin-right: 8px; }

        .stats-bar { margin-top: 15px; padding: 12px; background: #fff; border: 1px solid #ddd; border-radius: 10px; font-size: 12px; color: #666; display: flex; justify-content: space-between; }

        @media (max-width: 768px) {
            #mobile-tabs { display: flex; }
            #layout-wrapper { flex-direction: column; }
            .panel, #main-container { display: none; width: 100% !important; height: 100%; }
            .active-panel { display: flex !important; }
            textarea, input, select { font-size: 16px; } 
            #editor-wrapper { height: 120px; min-height: 120px; margin: 0; flex-shrink: 0; }
            #history-wrapper { padding: 15px; background: #f2f2f7; }
            #control-bar { padding: 10px 15px 25px 15px; } 
        }
    </style>
</head>
<body>

    <div id="mobile-tabs">
        <div class="tab-item" onclick="switchTab('static-sidebar', this)">åŸºç¡€è®¾å®š</div>
        <div class="tab-item active" onclick="switchTab('main-container', this)">åˆ›ä½œ</div>
        <div class="tab-item" onclick="switchTab('dynamic-sidebar', this)">å¯¼æ¼”</div>
    </div>

    <div id="layout-wrapper">
        
        <div class="panel" id="static-sidebar">
            <span class="badge" style="background:#86868b; align-self: flex-start; margin-bottom:10px;">DeepSeek åˆ›ä½œå·¥å…·</span>
            
            <label>API Key</label>
            <input type="password" id="apiKey" placeholder="è¯·å»DeepSeekç”³è¯·å¹¶å……ä¸¤ä¸‰å…ƒ">
            <label>å°è¯´åå­—</label>
            <input type="text" id="novel-title" placeholder="è¯·è¾“å…¥å°è¯´å">

            <hr style="width:100%; border:0; border-top:1px solid #e5e5e5; margin:15px 0;">

            <label>ğŸ“˜ æ™ºèƒ½çŸ¥è¯†åº“ (Auto-Wiki)</label>
            <div class="tips">* AI è‡ªåŠ¨æå–æ–°çš„äºº/ç‰©/ä¼ç¬”ï¼Œä¿æŒè¿è´¯æ€§ã€‚</div>
            <textarea id="entityMemory" rows="8" class="input-wiki" placeholder="[ç‰©å“] æ­¦å™¨ï¼šé‡‘ç®æ£’..."></textarea>
            
            <label>ğŸŒ ä¸–ç•Œè§‚ (Worldview)</label>
            <textarea id="worldView" rows="4" placeholder="è§„åˆ™ã€ç¯å¢ƒã€ä½“ç³»..."></textarea>
            
            <label>ğŸ‘¤ æ ¸å¿ƒè§’è‰²æ¡£æ¡ˆ (Bible)</label>
            <textarea id="characterBible" rows="5" placeholder="å§“åã€æ€§æ ¼ã€äººè®¾ã€å…³ç³»..."></textarea>
            
            <label>ğŸ¨ æ–‡å­¦é£æ ¼ (Style)</label>
            <textarea id="styleRef" rows="2" placeholder="ä¾‹å¦‚ï¼šæƒè°‹ï¼Œå†·å³»ï¼ŒèŠ‚å¥ç´§å‡‘ã€‚"></textarea>
            
            <label>ğŸš« é¿å‘æŒ‡ä»¤ (Negative)</label>
            <textarea id="negativePrompt" rows="2" placeholder="ä¾‹å¦‚ï¼šå°‘å†™â€œçœ¼ç¥ä¸€å†·â€ï¼›æ‹’ç»æµæ°´è´¦ã€‚"></textarea>
        </div>

        <div id="main-container" class="active-panel">
            <div id="editor-wrapper">
                <div style="padding: 10px 20px 0; font-size: 12px; font-weight: 700; color: #86868b; display:flex; justify-content:space-between;">
                    <span>æ¥åŠ›èµ·ç‚¹</span>
                    <span id="editor-count">0 å­—</span>
                </div>
                <textarea id="novel-content" placeholder="åœ¨æ­¤ç²˜è´´ä¸Šä¸€æ®µç»“å°¾..."></textarea>
            </div>
            
            <div id="history-wrapper">
                <div id="history-list"></div>
            </div>

            <div id="control-bar">
                <input type="text" id="prompt-input" placeholder="è¾“å…¥ä½ çš„è¦æ±‚ï¼Œä¾‹å¦‚â€œç»­å†™â€ã€å­—æ•°ç­‰...">
                <button id="btn-gen" class="btn btn-primary" onclick="generate()">ğŸ¬ å¼€æ</button>
                <button id="btn-stop" class="btn btn-stop" style="display:none;" onclick="stop()">â¹ åœæ­¢</button>
            </div>
        </div>

        <div class="panel" id="dynamic-sidebar">
            <button class="btn btn-update" onclick="smartUpdateMemory()">
                <span>ğŸ”„ æ›´æ–°AIè®°å¿†+çŸ¥è¯†åº“</span>
            </button>
            
            <label>â‘  äº‹å®æ¡£æ¡ˆ (Facts)</label>
            <div class="tips">* è®°å½•ä¸å¯é€†çš„æ”¹å˜æˆ–é‡å¤§è½¬æŠ˜ï¼ˆå¦‚è§’è‰²æ­»äº¡ã€åŸæ± é™·è½ï¼‰ã€‚</div>
            <textarea id="statusTracker" rows="4" class="input-fact" placeholder="å·²å‘ç”Ÿçš„äº‹å®..."></textarea>
            
            <label>â‘¡ å‰æƒ…ææè¦ (Summary)</label>
            <textarea id="contextSummary" rows="4" placeholder="AIç”Ÿæˆä¸Šä¸€ç« å‰§æƒ…æµ“ç¼©å¿«ç…§..."></textarea>
            
            <hr style="width:100%; border:0; border-top:1px solid #e5e5e5; margin:15px 0;">
            
            <label style="color: var(--accent);">â‘¢ æœ¬æ®µç›®æ ‡ (Goal)</label>
            <textarea id="sceneGoal" rows="2" placeholder="è¿™ä¸€åœºæˆçš„æ ¸å¿ƒå†²çªæ˜¯ä»€ä¹ˆï¼Ÿ"></textarea>
            
            <label style="color: var(--danger);">â‘£ å¿…é¡»æåŠ (Must Include)</label>
            <textarea id="mustInclude" rows="2" class="input-must" placeholder="å…³é”®é“å…·ã€ä¼ç¬”..."></textarea>
            
            <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label>â‘¤ èŠ‚å¥</label>
                    <select id="rhythmControl">
                        <option value="æ­£å¸¸">æ­£å¸¸æ¨è¿›</option>
                        <option value="æ…¢ï¼šç¯å¢ƒ/å¿ƒç†">æ…¢ï¼šç¯å¢ƒ/å¿ƒç†</option>
                        <option value="å¿«ï¼šåŠ¨ä½œ/å¯¹è¯">å¿«ï¼šåŠ¨ä½œ/å¯¹è¯</option>
                    </select>
                </div>
                <div style="flex:1">
                    <label>ç¯‡å¹…</label>
                    <select id="lengthMode">
                        <option value="standard">æ ‡å‡†</option>
                        <option value="long">æ²‰æµ¸æ‰©å†™</option>
                        <option value="short">çŸ­å°è¿‡æ¸¡</option>
                    </select>
                </div>
            </div>

            <label>â‘¥ å™äº‹è§†è§’ (POV)</label>
            <select id="pov">
                <option value="ç¬¬ä¸‰äººç§°è§†è§’">ç¬¬ä¸‰äººç§°</option>
                <option value="ç¬¬ä¸€äººç§°">ç¬¬ä¸€äººç§°</option>
                <option value="ä¸Šå¸è§†è§’">ä¸Šå¸è§†è§’</option>
            </select>
            
            <div class="stats-bar">
                <span>æ€»å­—æ•°: <b id="total-words">0</b></span>
                <span>åœºæ¬¡: <b id="ver-count">0</b></span>
            </div>
            <button class="btn btn-outline" style="width:100%; margin-top:10px; font-size:12px;" onclick="downloadFullDraft()">ğŸ“¥ å¯¼å‡ºå…¨æœ¬</button>
        </div>
    </div>

    <script>
        function switchTab(panelId, tabEl) {
            document.querySelectorAll('.panel, #main-container').forEach(p => p.classList.remove('active-panel'));
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            document.getElementById(panelId).classList.add('active-panel');
            tabEl.classList.add('active');
        }

        let controller;
        let genCount = 0;
        const storageKey = 'deepseek_pro_v15';

        function buildPrompt() {
            const rhythm = document.getElementById('rhythmControl').value;
            const lengthMode = document.getElementById('lengthMode').value;
            const pov = document.getElementById('pov').value;
            
            let lengthInstruction = "";
            if(lengthMode === 'long') lengthInstruction = "è¯·æ·±åº¦æ‰©å†™ï¼Œä¸°å¯Œç»†èŠ‚ï¼Œç¯‡å¹…1500å­—ä»¥ä¸Šã€‚";
            if(lengthMode === 'short') lengthInstruction = "è¯·å¿«é€Ÿæ¨è¿›ï¼Œç¯‡å¹…500å­—å·¦å³ã€‚";

            return `ä½ æ˜¯ä¸€ä½æ®¿å ‚çº§å°è¯´å®¶ã€‚
ã€é™æ€æ¡†æ¶ (Static)ã€‘
- ä¸–ç•Œè§‚ï¼š${document.getElementById('worldView').value}
- è§’è‰²æ¡£æ¡ˆï¼š${document.getElementById('characterBible').value}

ã€åŠ¨æ€çŸ¥è¯†åº“ (Auto-Wiki)ã€‘
${document.getElementById('entityMemory').value || "æš‚æ— è®°å½•"}

ã€é¿å‘æŒ‡å—ã€‘
${document.getElementById('negativePrompt').value}

ã€å‰§æƒ…çŠ¶æ€ã€‘
- æ‘˜è¦ï¼š${document.getElementById('contextSummary').value}
- äº‹å®ï¼š${document.getElementById('statusTracker').value}

ã€æœ¬åœºæŒ‡ä»¤ã€‘
- ç›®æ ‡ï¼š${document.getElementById('sceneGoal').value}
- å¿…é¡»åŒ…å«ï¼š${document.getElementById('mustInclude').value}
- è§†è§’ï¼š${pov}
- èŠ‚å¥ï¼š${rhythm}
- è¦æ±‚ï¼š${lengthInstruction}
- é£æ ¼ï¼š${document.getElementById('styleRef').value}

è¯·ä¾æ®è®¾å®šä¿æŒå‰åä¸€è‡´ã€‚ç›´æ¥ç»­å†™æ­£æ–‡ã€‚`;
        }

        async function generate() {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) return alert("è¯·å…ˆå¡«å†™ API Key");
            toggleUI(true);
            controller = new AbortController();
            const editor = document.getElementById('novel-content');
            genCount++;
            
            const cardId = `card-${Date.now()}`;
            const card = createHistoryCard(cardId, genCount);
            document.getElementById('history-list').prepend(card);
            
            const cardBody = card.querySelector('.history-body');
            cardBody.innerHTML = `<span class="serial-number">#${genCount}</span>`;
            const textContent = document.createElement('span');
            cardBody.appendChild(textContent);

            try {
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                    signal: controller.signal,
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            { role: "system", content: buildPrompt() },
                            { role: "user", content: `èµ·ç‚¹ï¼š\n${editor.value}\næŒ‡ä»¤ï¼š${document.getElementById('prompt-input').value}` }
                        ],
                        stream: true
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                            const data = JSON.parse(line.slice(6));
                            textContent.innerText += data.choices[0].delta.content || "";
                        }
                    }
                }
            } catch (e) { if(e.name !== 'AbortError') alert(e.message); }
            finally { 
                updateCardWordCount(card); 
                toggleUI(false); 
                save(); 
            }
        }

        async function smartUpdateMemory() {
            const apiKey = document.getElementById('apiKey').value;
            const historyList = document.getElementById('history-list');
            if(historyList.children.length === 0) return alert("æš‚æ— å†…å®¹å¯åŒæ­¥ã€‚");
            
            const btn = document.querySelector('.btn-update');
            const originalText = btn.innerText;
            btn.innerText = "ğŸ§  æ­£åœ¨æ›´æ–°çŸ¥è¯†åº“...";
            btn.disabled = true;

            const latestText = historyList.children[0].querySelector('.history-body').innerText;
            
            try {
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [{
                            role: "system", 
                            content: `åˆ†ææœ€æ–°å°è¯´æ®µè½ï¼š
1. **æ›´æ–°Wiki**ï¼šç®€è¦æå–æ–°å‡ºç°çš„å…³é”®äººç‰©ç‰¹å¾ã€ç‰©å“ã€ä¼ç¬”ã€‚ä¿ç•™æ—§çš„é‡è¦æ¡ç›®ï¼Œåˆå¹¶æ–°æ¡ç›®ã€‚
2. **æ›´æ–°æ‘˜è¦**ï¼šæ¦‚æ‹¬å‰§æƒ…ã€‚
3. **æ›´æ–°äº‹å®**ï¼šè®°å½•ä¸å¯é€†æ”¹å˜ï¼ˆå¦‚æ­»äº¡ã€æ¯ç­ã€å¼ºçƒˆå†²çªï¼‰ã€‚
è¿”å›JSONï¼š{ "wiki": "...", "summary": "...", "facts": "..." }`
                        }, {
                            role: "user", 
                            content: `æ—§Wiki: ${document.getElementById('entityMemory').value}\næ—§æ‘˜è¦: ${document.getElementById('contextSummary').value}\næ—§äº‹å®: ${document.getElementById('statusTracker').value}\næ–°å‰§æƒ…: ${latestText}`
                        }],
                        response_format: { type: 'json_object' }
                    })
                });
                
                const data = await response.json();
                const res = JSON.parse(data.choices[0].message.content);
                document.getElementById('entityMemory').value = res.wiki;
                document.getElementById('contextSummary').value = res.summary;
                document.getElementById('statusTracker').value = res.facts;
                save();
                alert("è®°å¿†åŒæ­¥å®Œæˆï¼");
            } catch (e) { alert("åŒæ­¥å¤±è´¥: " + e.message); } 
            finally { btn.innerText = originalText; btn.disabled = false; }
        }

        function createHistoryCard(id, count, content = "") {
            const time = new Date().toLocaleString('zh-CN', { hour12: false });
            const div = document.createElement('div');
            div.className = 'history-card';
            div.id = id;
            div.innerHTML = `
                <div class="history-header">
                    <div><span style="font-weight:700">åœºæ¬¡ ${count}</span><span style="color:#999;font-size:10px;margin-left:5px">${time}</span></div>
                    <div>
                        <span style="font-size:11px;color:#86868b;margin-right:5px">å­—æ•°:<span class="w-count">0</span></span>
                        <button class="btn btn-outline btn-sm" onclick="toggleCard('${id}')">æŠ˜å </button>
                    </div>
                </div>
                <div class="history-body" contenteditable="true">${content}</div>
                <div style="margin-top:10px;display:flex;gap:5px;border-top:1px dashed #eee;padding-top:10px">
                    <button class="btn btn-outline btn-sm" style="flex:1" onclick="downloadOne('${id}', ${count})">ğŸ“¥ å¯¼å‡º</button>
                    <button class="btn btn-outline btn-sm" style="flex:1" onclick="setAsBase('${id}')">ğŸ” è®¾ä¸ºèµ·ç‚¹</button>
                    <button class="btn btn-outline btn-sm" style="color:#ff3b30" onclick="if(confirm('åˆ é™¤?')) {this.closest('.history-card').remove(); updateCounts(); save();}">ğŸ—‘</button>
                </div>
            `;
            if(content) setTimeout(() => updateCardWordCount(div), 0);
            return div;
        }

        function toggleCard(id) {
            const card = document.getElementById(id);
            const btn = card.querySelector('button[onclick^="toggleCard"]');
            card.classList.toggle('collapsed');
            btn.innerText = card.classList.contains('collapsed') ? 'å±•å¼€' : 'æŠ˜å ';
        }

        function setAsBase(id) {
            const text = document.getElementById(id).querySelector('.history-body').innerText.replace(/^#\d+\s*/, '');
            document.getElementById('novel-content').value = text;
            document.getElementById('editor-count').innerText = text.length + " å­—";
            switchTab('main-container', document.querySelectorAll('.tab-item')[1]);
        }

        function downloadFullDraft() {
            let fullText = `ã€Š${document.getElementById('novel-title').value}ã€‹\n\n`;
            const cards = Array.from(document.querySelectorAll('.history-body')).reverse();
            cards.forEach(el => fullText += el.innerText + "\n\n");
            saveFile(`å…¨ç¨¿_${Date.now()}.txt`, fullText);
        }

        function downloadOne(id, c) {
            const text = document.getElementById(id).querySelector('.history-body').innerText;
            const title = document.getElementById('novel-title').value;
            saveFile(`${title}_åœºæ¬¡${c}.txt`, text);
        }

        function saveFile(name, text) {
            const blob = new Blob([text], {type: 'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = name;
            a.click();
        }

        function updateCardWordCount(card) {
            const text = card.querySelector('.history-body').innerText;
            card.querySelector('.w-count').innerText = text.length;
            updateCounts();
        }

        function updateCounts() {
            let total = 0;
            document.querySelectorAll('.history-body').forEach(el => total += el.innerText.length);
            document.getElementById('total-words').innerText = total;
            document.getElementById('ver-count').innerText = document.querySelectorAll('.history-body').length;
        }

        function toggleUI(l) {
            document.getElementById('btn-gen').style.display = l ? 'none' : 'inline-flex';
            document.getElementById('btn-stop').style.display = l ? 'inline-flex' : 'none';
        }
        function stop() { if(controller) controller.abort(); }

        function save() {
            const d = { config: {}, history: [] };
            document.querySelectorAll('input, textarea, select').forEach(el => { if(el.id) d.config[el.id] = el.value; });
            document.querySelectorAll('.history-body').forEach(el => d.history.push(el.innerText));
            d.config.genCount = genCount;
            localStorage.setItem(storageKey, JSON.stringify(d));
        }

        window.onload = () => {
            const s = localStorage.getItem(storageKey);
            if(s) {
                const d = JSON.parse(s);
                Object.keys(d.config).forEach(id => { if(document.getElementById(id)) document.getElementById(id).value = d.config[id]; });
                genCount = d.config.genCount || 0;
                d.history.reverse().forEach((txt, i) => {
                    document.getElementById('history-list').prepend(createHistoryCard(`old-${i}`, d.history.length - i, txt));
                });
            }
            updateCounts();
            document.getElementById('editor-count').innerText = document.getElementById('novel-content').value.length + " å­—";
            document.getElementById('novel-content').addEventListener('input', function() {
                document.getElementById('editor-count').innerText = this.value.length + " å­—";
                save();
            });
        };
        document.addEventListener('input', save);
    </script>
<script src="common.js"></script>

</body>
</html>
