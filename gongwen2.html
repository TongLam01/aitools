<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å…¬æ–‡è‡ªåŠ¨æ’°å†™åŠ©æ‰‹ V1.3 </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html-docx-js@0.3.1/dist/html-docx.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Inter:wght@400;500;600;700&display=swap');
        
        body { 
            background-color: #fcfcfc; 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            color: #1a1a1a;
        }
        
        /* å…¬æ–‡é¢„è§ˆåŒºæ ·å¼ */
        .doc-preview { 
            font-family: 'Noto Serif SC', 'SimSun', serif; 
            line-height: 2.2; 
            color: #000; 
        }
        .doc-preview h1 { font-weight: 700; font-size: 28pt; text-align: center; margin-bottom: 24pt; line-height: 1; }
        .doc-preview h2 { font-weight: 700; font-size: 16pt; margin-top: 18pt; margin-bottom: 12pt; }
        .doc-preview p { margin-bottom: 12pt; text-align: justify; font-size: 12pt; }
        .doc-preview ul, .doc-preview ol { margin-bottom: 12pt; padding-left: 2em; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* å‘¼å¸ç¯åŠ¨ç”» */
        .thinking-pill {
            display: none;
            background: #fff;
            border: 1px solid #000;
            border-radius: 9999px;
            padding: 0.6rem 1.5rem;
            color: #000;
            font-size: 0.875rem;
            font-weight: 600;
            animation: breathe 3s infinite ease-in-out;
            margin: 0 auto 2rem auto;
            width: fit-content;
            box-shadow: 0 2px 0px rgba(0,0,0,1);
        }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }

        .bubble-enter {
            animation: bubbleFadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        @keyframes bubbleFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .input-minimal {
            background-color: #fff;
            border: 1px solid #e5e5e5;
            transition: all 0.2s;
            color: #111;
        }
        .input-minimal:focus {
            border-color: #000;
            outline: none;
            box-shadow: 0 0 0 1px #000;
        }
        
        .label-bold {
            font-size: 0.875rem; 
            font-weight: 700;    
            color: #171717;      
            margin-bottom: 0.5rem;
            display: block;
        }

        .version-tab {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .version-tab.active { background-color: #000; color: #fff; border-color: #000; }
        .version-tab.inactive { background-color: #fff; color: #999; border-color: #e5e5e5; }

        /* ç§»åŠ¨ç«¯å¼ºåˆ¶ 16px é˜²æ­¢ç¼©æ”¾ */
        input, select, textarea { font-size: 16px !important; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden">

    <nav class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center z-20 shrink-0 relative">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-red-600 text-white rounded flex items-center justify-center text-sm font-bold">å…¬</div>
            <div class="flex flex-col">
                <span class="text-sm font-bold tracking-tight text-black">å…¬æ–‡è‡ªåŠ¨æ’°å†™åŠ©æ‰‹</span>
                <span class="text-[10px] text-gray-500 font-medium uppercase tracking-wider">DeepSeek R1 Inside</span>
            </div>
        </div>
        
        <div class="flex items-center gap-4 relative">
            <a href="https://platform.deepseek.com/api_keys" target="_blank" class="text-xs font-medium text-gray-400 hover:text-black hover:underline transition-colors flex items-center gap-1">
                è·å– Key 
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
            </a>
            <button onclick="toggleSettings()" class="text-gray-400 hover:text-black transition-colors" id="settingsBtn">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                </svg>
            </button>
        </div>
    </nav>

    <div id="settingsModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white border border-gray-200 shadow-2xl w-full max-w-sm p-8 rounded-2xl transform transition-all scale-100">
            <h3 class="text-lg font-bold text-black mb-6 text-center">é…ç½® API Key</h3>
            <div class="mb-6">
                <input type="password" id="apiKeyInput" placeholder="sk-..." 
                       class="w-full bg-gray-50 border border-gray-200 rounded-lg p-4 text-sm focus:border-black outline-none transition-all text-center tracking-widest">
            </div>
            <div class="flex gap-4">
                <button onclick="toggleSettings()" class="flex-1 px-4 py-3 text-gray-500 hover:text-black hover:bg-gray-50 rounded-lg font-medium transition-colors">å–æ¶ˆ</button>
                <button onclick="saveSettings()" class="flex-1 px-4 py-3 bg-black text-white hover:bg-gray-800 rounded-lg font-medium shadow-lg transition-all">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
        
        <div class="w-full md:w-[420px] bg-white border-b md:border-b-0 md:border-r border-gray-200 flex flex-col z-10">
            <div class="flex-1 overflow-y-auto p-6 md:p-8 space-y-8 no-scrollbar">
                
                <div class="space-y-6">
                    <div>
                        <label class="label-bold">æ–‡ç§ç±»å‹</label>
                        <select id="docType" class="w-full input-minimal rounded-lg p-3 text-sm font-medium appearance-none">
                            <option value="æ ¹æ®å†…å®¹è‡ªåŠ¨åŒ¹é…æ–‡ç§">âœ¨ æ™ºèƒ½åŒ¹é…</option>
                            <option value="å·¥ä½œæ€»ç»“">ğŸ“ˆ å·¥ä½œæ€»ç»“</option>
                            <option value="å·¥ä½œè®¡åˆ’">ğŸ“… å·¥ä½œè®¡åˆ’</option>
                            <option value="å·¥ä½œé€šçŸ¥">ğŸ“¢ å·¥ä½œé€šçŸ¥</option>
                            <option value="ä¼šè®®çºªè¦">ğŸ“ ä¼šè®®çºªè¦</option>
                            <option value="è¯·ç¤ºæŠ¥å‘Š">ğŸ“„ è¯·ç¤ºæŠ¥å‘Š</option>
                            <option value="å·¥ä½œæ–¹æ¡ˆ">ğŸ“Š å·¥ä½œæ–¹æ¡ˆ</option>
                            <option value="é¢†å¯¼è®²è¯">ğŸ™ï¸ é¢†å¯¼è®²è¯</option>
                            <option value="æ¥å¾€å…¬å‡½">âœ‰ï¸ æ¥å¾€å…¬å‡½</option>
                        </select>
                    </div>

                    <div>
                        <label class="label-bold">èƒŒæ™¯ä¿¡æ¯ <span class="text-xs font-normal text-gray-400">é€‰å¡«</span></label>
                        <textarea id="orgContext" rows="3" class="w-full input-minimal rounded-lg p-3 text-sm resize-none" placeholder="ä¾‹å¦‚ï¼šxxxå…¬å¸ï¼Œæ ¸å¿ƒä¸šåŠ¡æ˜¯..."></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="label-bold">æ’°ç¨¿è€…è§’è‰²</label>
                            <input type="text" id="authorIdentity" placeholder="å¦‚ï¼šåŠå…¬å®¤" class="w-full input-minimal rounded-lg p-3 text-sm">
                        </div>
                        <div>
                            <label class="label-bold">é˜…è¯»å¯¹è±¡ *</label>
                            <input type="text" id="targetAudience" placeholder="å¦‚ï¼šå…¨ä½“äººå‘˜" class="w-full input-minimal rounded-lg p-3 text-sm bg-gray-50 focus:bg-white">
                        </div>
                    </div>
                </div>

                <div class="flex-1 flex flex-col min-h-[200px]">
                    <div class="flex justify-between items-center mb-2">
                        <label class="label-bold !mb-0">ç´ æ/æ„å›¾/èƒŒæ™¯</label>
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-bold text-green-600 uppercase tracking-widest">è‡ªåŠ¨è„±æ•</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="anonymizeToggle" class="sr-only peer" checked>
                                <div class="w-8 h-4 bg-gray-200 rounded-full peer peer-checked:bg-red-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:after:translate-x-full"></div>
                            </label>
                        </div>
                    </div>
                    <textarea id="userInput" class="w-full h-80 input-minimal rounded-lg p-4 text-sm leading-relaxed resize-y" placeholder="è¯·åœ¨æ­¤è¾“å…¥AIè¿˜ä¸äº†è§£çš„å…³é”®ä¿¡æ¯..."></textarea>
                </div>
            </div>

            <div class="p-6 pb-10 md:pb-6 bg-white border-t border-gray-100">
                <button onclick="generateDoc()" id="submitBtn" class="group w-full bg-black hover:bg-gray-800 text-white font-bold py-4 rounded-lg shadow-xl flex justify-center items-center gap-2">
                    <span>å¼€å§‹æ’°å†™</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                </button>
            </div>
        </div>

        <div class="w-full md:w-auto flex-1 bg-[#f5f5f5] relative flex flex-col h-full">
            <div class="flex-1 overflow-y-auto p-4 md:p-12" id="previewContainer">
                
                <div id="thinkingIndicator" class="thinking-pill">
                    <span class="flex items-center gap-2">AI æ­£åœ¨æ€è€ƒ ...</span>
                </div>

                <div id="versionBar" class="max-w-[21cm] mx-auto mb-4 flex gap-2 overflow-x-auto no-scrollbar hidden transition-all"></div>

                <div class="max-w-[21cm] mx-auto bg-white shadow-sm min-h-[29.7cm] p-12 md:p-[2.54cm] rounded-sm relative" id="paperCard">
                    <div class="absolute top-4 right-4 flex gap-2">
                        <button onclick="copyResult()" class="p-2 rounded text-gray-400 hover:text-black font-bold text-xs flex items-center gap-1">å¤åˆ¶</button>
                        <button onclick="exportToWord()" class="p-2 rounded text-gray-400 hover:text-blue-600 font-bold text-xs flex items-center gap-1">å¯¼å‡º Word</button>
                    </div>

                    <div id="resultOutput" class="doc-preview">
                        <div class="flex flex-col items-center justify-center h-96 text-gray-300">
                            <p class="text-sm font-medium text-gray-400">è¯·åœ¨å·¦ä¾§è¾“å…¥ä¿¡æ¯å¹¶å¼€å§‹æ’°å†™</p>
                        </div>
                    </div>
                </div>

                <div id="followUpContainer" class="hidden max-w-[21cm] mx-auto mt-6">
                    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200 flex gap-3">
                        <input type="text" id="followUpInput" class="flex-1 input-minimal rounded p-3 text-sm" placeholder="è¿½é—®æˆ–ä¿®æ”¹è¦æ±‚..." onkeydown="if(event.key==='Enter') sendFollowUp()">
                        <button onclick="sendFollowUp()" id="followUpBtn" class="bg-black text-white px-6 py-2 rounded text-sm hover:bg-gray-800 transition-colors">å‘é€</button>
                    </div>
                </div>
                
                <div class="text-center mt-8 text-gray-300 text-[10px] font-mono">GENERATED BY DEEPSEEK R1</div>
            </div>
        </div>
    </div>

    <script>
        let chatHistory = [];
        let versionHistory = []; 
        let currentVersionIndex = -1;

        window.onload = function() {
            const savedKey = localStorage.getItem('deepseek_api_key');
            if (savedKey) document.getElementById('apiKeyInput').value = savedKey;
        }

        function toggleSettings() { document.getElementById('settingsModal').classList.toggle('hidden'); }
        function saveSettings() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key) { localStorage.setItem('deepseek_api_key', key); toggleSettings(); }
            else alert('è¯·è¾“å…¥ API Key');
        }

        /**
         * å¼ºåŒ–è„±æ•æ ¸å¿ƒå‡½æ•° (å®Œå…¨ä¿ç•™åŸé€»è¾‘)
         */
        function anonymizeData(text, mapping) {
            if (!text) return text;
            const suffixes = ['å…¬å¸', 'å¸‚', 'åŒº'];
            let processedText = text;

            suffixes.forEach(suffix => {
                const regex = new RegExp(`([A-Za-z0-9\\u4e00-\\u9fa5]+?${suffix})`, 'g');
                processedText = processedText.replace(regex, (match) => {
                    if (mapping[match]) return mapping[match];
                    const codeLabel = String.fromCharCode(65 + (mapping.count % 26));
                    const suffixLabel = mapping.count >= 26 ? Math.floor(mapping.count / 26) : "";
                    const replacement = `${codeLabel}${suffixLabel}${suffix}`;
                    mapping[match] = replacement;
                    mapping.count++;
                    return replacement;
                });
            });
            return processedText;
        }

        // æ ¸å¿ƒæµå¼è¯·æ±‚ (è¿æ¥ /api/gongwen)
        async function processStream(userKey, messages) {
            const outputDiv = document.getElementById('resultOutput');
            const thinkingDiv = document.getElementById('thinkingIndicator');
            const submitBtn = document.getElementById('submitBtn');
            const followUpContainer = document.getElementById('followUpContainer');

            submitBtn.disabled = true;
            thinkingDiv.style.display = 'block';
            outputDiv.innerHTML = '';
            followUpContainer.classList.add('hidden');

            try {
                const response = await fetch('/api/gongwen', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userKey, messages })
                });

                if (!response.ok) throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Key æˆ–é‡è¯•');

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let accumulatedText = ""; 

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.slice(6);
                            if (dataStr === '[DONE]') break;
                            try {
                                const data = JSON.parse(dataStr);
                                accumulatedText += data.choices[0].delta.content || "";
                                
                                if (accumulatedText.includes('</think>')) thinkingDiv.style.display = 'none';
                                const clean = accumulatedText.replace(/<think>[\s\S]*?<\/think>/g, "").replace(/<think>[\s\S]*/g, "").trim();
                                if (clean) outputDiv.innerHTML = marked.parse(clean);
                            } catch (e) {}
                        }
                    }
                }

                chatHistory.push({ role: "assistant", content: accumulatedText.replace(/<think>[\s\S]*?<\/think>/g, "").trim() });
                versionHistory.push(outputDiv.innerHTML);
                currentVersionIndex = versionHistory.length - 1;
                renderVersionTabs();
                followUpContainer.classList.remove('hidden');

            } catch (error) {
                outputDiv.innerHTML = `<div class="p-4 text-red-600 text-center">å‡ºé”™äº†: ${error.message}</div>`;
            } finally {
                submitBtn.disabled = false;
                thinkingDiv.style.display = 'none';
            }
        }

        async function generateDoc() {
            const apiKey = localStorage.getItem('deepseek_api_key');
            if (!apiKey) { alert('è¯·å…ˆè®¾ç½® API Key'); toggleSettings(); return; }

            const docType = document.getElementById('docType').value;
            let orgContext = document.getElementById('orgContext').value.trim();
            let author = document.getElementById('authorIdentity').value.trim() || "åŠå…¬å®¤";
            let audience = document.getElementById('targetAudience').value.trim();
            let userInput = document.getElementById('userInput').value.trim();

            if (!audience || !userInput) { alert('è¯·å¡«å†™é˜…è¯»å¯¹è±¡å’Œç´ æ'); return; }

            // ä¿æŒè„±æ•é€»è¾‘
            if (document.getElementById('anonymizeToggle').checked) {
                const mapping = { count: 0 };
                orgContext = anonymizeData(orgContext, mapping);
                author = anonymizeData(author, mapping);
                audience = anonymizeData(audience, mapping);
                userInput = anonymizeData(userInput, mapping);
            }

            const prompt = `æ’°å†™å…¬æ–‡ï¼š\nã€èƒŒæ™¯ã€‘ï¼š${orgContext}\nã€æ–‡ç§ã€‘ï¼š${docType}\nã€è§’è‰²ã€‘ï¼š${author}\nã€å¯¹è±¡ã€‘ï¼š${audience}\nã€ç´ æã€‘ï¼š${userInput}`;
            
            chatHistory = [{ role: "user", content: prompt }];
            versionHistory = [];
            await processStream(apiKey, chatHistory);
        }

        async function sendFollowUp() {
            const inputEl = document.getElementById('followUpInput');
            const val = inputEl.value.trim();
            const apiKey = localStorage.getItem('deepseek_api_key');
            if (!val || !apiKey) return;

            chatHistory.push({ role: "user", content: val });
            inputEl.value = '';
            await processStream(apiKey, chatHistory);
        }

        function renderVersionTabs() {
            const bar = document.getElementById('versionBar');
            if (versionHistory.length <= 1) return;
            bar.classList.remove('hidden');
            bar.innerHTML = versionHistory.map((_, i) => `<div onclick="switchVersion(${i})" class="version-tab ${i===currentVersionIndex?'active':'inactive'}">ç‰ˆæœ¬ ${i+1}</div>`).join('');
        }

        function switchVersion(i) {
            currentVersionIndex = i;
            document.getElementById('resultOutput').innerHTML = versionHistory[i];
            renderVersionTabs();
        }

        function copyResult() {
            const text = document.getElementById('resultOutput').innerText;
            navigator.clipboard.writeText(text).then(() => alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'));
        }

        function exportToWord() {
            const content = document.getElementById('resultOutput').innerHTML;
            const blob = htmlDocx.asBlob(`<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body>${content}</body></html>`);
            saveAs(blob, `å…¬æ–‡_${new Date().getTime()}.docx`);
        }
    </script>
<script src="common.js"></script>
</body>
</html>
