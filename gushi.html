<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>古诗共鸣-V1.0版</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;600;900&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --text-color: #2c3e50;
            --accent-color: #a63232; /* 丹砂红 */
            --jade-color: #519a73;
            --card-bg: #fffcf7;
            --serif-font: "Noto Serif SC", serif;
        }

        /* --- 背景动效 --- */
        body {
            margin: 0; min-height: 100vh; font-family: var(--serif-font);
            color: var(--text-color); background-color: #f7f5f0;
            display: flex; flex-direction: column; align-items: center; padding: 40px 20px;
            overflow-x: hidden;
        }

        .ink-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; filter: blur(80px); opacity: 0.25;
            background: radial-gradient(circle at 20% 30%, #000 0%, transparent 40%),
                        radial-gradient(circle at 80% 70%, #444 0%, transparent 40%);
            animation: inkMovement 30s infinite alternate ease-in-out;
        }

        @keyframes inkMovement {
            0% { transform: scale(1) translate(0, 0); }
            50% { transform: scale(1.2) translate(5%, 2%); }
            100% { transform: scale(1.1) translate(-2%, 5%); }
        }

        /* --- 极简密匙设置 --- */
        .settings-area {
            width: 100%; max-width: 600px;
            display: flex; justify-content: flex-end; align-items: center;
            margin-bottom: 30px; position: relative;
        }
        .settings-btn-group { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .settings-toggle { background: none; border: none; cursor: pointer; font-family: var(--serif-font); font-size: 0.85rem; color: #aaa; letter-spacing: 2px; transition: color 0.3s; }
        .settings-toggle:hover { color: var(--text-color); }
        .status-dot { width: 5px; height: 5px; background: #eee; border-radius: 50%; transition: 0.5s; }
        .active-dot { background: var(--jade-color); box-shadow: 0 0 8px var(--jade-color); animation: jadeBreathe 4s infinite; }
        @keyframes jadeBreathe { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
        .api-controls {
            position: absolute; top: 35px; right: 0; background: rgba(255,255,255,0.98); padding: 25px; border-radius: 2px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08); display: none; flex-direction: column; gap: 15px; min-width: 260px; z-index: 101; backdrop-filter: blur(10px);
        }
        .settings-area.open .api-controls { display: flex; }
        input[type="password"] { border: none; border-bottom: 1px solid #ddd; padding: 8px 0; font-size: 13px; outline: none; background: transparent; width: 100%; }
        .btn-save { background: var(--text-color); color: white; border: none; padding: 10px; cursor: pointer; font-size: 12px; margin-top: 5px; }

        /* --- 主容器排版 --- */
        .container { width: 100%; max-width: 600px; z-index: 1; }
        header { text-align: center; margin-bottom: 70px; margin-top: 50px; }
        h1 { font-size: 2.5rem; font-weight: 900; letter-spacing: 2.2rem; margin-right: -2.2rem; color: #111; }
        
        /* 1. 输入框字号缩小 */
        textarea {
            width: 100%; height: 100px; background: transparent; border: none; border-bottom: 1px solid rgba(0,0,0,0.08);
            padding: 15px 0; font-family: var(--serif-font); 
            font-size: 1rem; /* 字号调小 */
            resize: none; outline: none; box-sizing: border-box; transition: 0.4s; line-height: 1.8;
        }
        textarea:focus { border-bottom-color: var(--accent-color); }

        .action-btn {
            width: 100%; padding: 20px; margin-top: 50px; background: var(--text-color); color: white; border: none; font-family: var(--serif-font);
            font-size: 1.15rem; letter-spacing: 1.5rem; cursor: pointer; transition: 0.4s;
        }
        .action-btn:hover { background: var(--accent-color); }

        /* --- 3. 诗歌卡片 (内容字号缩小) --- */
        #resultWrapper { margin-top: 90px; display: none; width: 100%; }
        #cardArea { padding: 30px; background: #f7f5f0; }
        .poetry-card {
            background: var(--card-bg); padding: 90px 70px; border-radius: 1px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.03); position: relative; text-align: center;
            background-image: url("https://www.transparenttextures.com/patterns/paper-fibers.png");
        }
        .card-header { margin-bottom: 60px; }
        .card-title { font-size: 1.7rem; font-weight: 600; color: var(--accent-color); margin: 0; letter-spacing: 5px; }
        
        /* 诗歌正文字号缩小 */
        .card-body { 
            font-size: 1.2rem; /* 字号缩小，增强留白 */
            line-height: 2.6; color: #2c3e50; white-space: pre-wrap; font-weight: 300; 
        }
        
        /* 2. 卡片底部页脚重构 (增加时间戳) */
        .card-footer { margin-top: 70px; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .footer-line { width: 80px; height: 1px; background: #DBDBDB; }
        .footer-text { font-size: 0.7rem; color: #D3D3D3; letter-spacing: 3px; font-weight: 300; text-transform: uppercase; }
        .footer-date { font-size: 0.65rem; color: #D3D3D3; letter-spacing: 2px; font-weight: 300; }

        /* 4. 下载按钮颜色同步 */
        .download-btn { 
            margin: 50px auto; display: block; background: none; border: none; 
            color: var(--accent-color); border-bottom: 1px solid var(--accent-color); 
            padding: 5px 15px; cursor: pointer; font-size: 0.85rem; opacity: 0.8; transition: 0.3s;
        }
        .download-btn:hover { opacity: 1; }
    </style>
</head>
<body>

<div class="ink-wrapper"></div>

<div class="container">
    <div class="settings-area" id="settingsArea">
        <div class="settings-btn-group" onclick="toggleSettings()">
            <button class="settings-toggle">API Key</button>
            <div id="statusDot" class="status-dot"></div>
        </div>
        <div class="api-controls">
            <input type="password" id="apiKey" placeholder="输入DeepSeek API Key">
            <button class="btn-save" onclick="saveKey()">保存配置</button>
        </div>
    </div>

    <header><h1>古诗共鸣</h1></header>

    <textarea id="poemInput" placeholder="请投入古诗，看千年前的月光，如何落在今夜的窗前..."></textarea>
    <button id="runBtn" class="action-btn" onclick="transformPoem()">开启共鸣</button>

    <div id="resultWrapper">
        <div id="cardArea">
            <div class="poetry-card" id="poetryCard">
                <div class="card-header"><h2 class="card-title" id="outTitle"></h2></div>
                <div class="card-body" id="outBody"></div>
                <div class="card-footer">
                    <div class="footer-line"></div>
                    <div class="footer-text">TOURUGUSHI YUJIANJINREN</div>
                    <div id="outDate" class="footer-date"></div> </div>
            </div>
        </div>
        <button class="download-btn" onclick="downloadCard()">下载此卡片</button>
    </div>
</div>

<script>
    const SYSTEM_PROMPT = `# Role: 现代通感诗人 (The Modern Visionary)

## Profile
你是一位深谙古典神韵与现代审美边界的诗人。你擅长将古诗中的“生命体验”提取出来，置于现代生活的广角镜头下。追求【疏离而深情】的电影质感，文字克制，意象精准。

## 创作逻辑：意象的“精神平移”
不要词语翻译，要生命瞬间的捕捉：
1. **捕捉“情绪母体”**：原诗打动人的灵魂是什么？分别的“断裂感”？繁华后的“虚无感”？抓住它。
2. **光影化的现代意象**：避开平庸日常。使用【电影镜头感】的物象：明暗交替的隧道、霓虹灯带、潮湿柏油路、空旷候车厅、幕墙残阳。
3. **叙事的张力**：用留白代替解释。用【通感】代替抒情（如：“感应灯熄灭后的走廊，月光像一种迟到的补丁”）。

## 创作约束 (Creative Style)
- **质感**：要有“胶片电影”的颗粒感。短句为主，节奏有呼吸感。
- **语言**：文字冷峻，内核滚烫。
- **神韵**：古诗中“天长地久”的苍凉或“一瞬即永恒”的惊喜，必须在现代叙事中得到回应。

## 创作流程 (Workflow)
1. **勘其神**：思考原诗在现代语境下的“情感锚点”。
2. **写其骨**：交付重构后的现代诗，不包含任何解释或 Markdown 符号。标题简洁`;

    window.onload = () => {
        const key = localStorage.getItem('ds_api_key');
        if (key) {
            document.getElementById('apiKey').value = key;
            document.getElementById('statusDot').classList.add('active-dot');
        }
    };

    function toggleSettings() { document.getElementById('settingsArea').classList.toggle('open'); }
    function saveKey() {
        const key = document.getElementById('apiKey').value.trim();
        if(key) {
            localStorage.setItem('ds_api_key', key);
            document.getElementById('statusDot').classList.add('active-dot');
            toggleSettings();
        }
    }

    async function transformPoem() {
        const key = localStorage.getItem('ds_api_key');
        const poem = document.getElementById('poemInput').value.trim();
        if(!key || !poem) return alert("请输入古诗/填好有效的API Key");

        const btn = document.getElementById('runBtn');
        btn.innerText = "请稍候..."; btn.disabled = true;
        document.getElementById('resultWrapper').style.display = 'block';
        document.getElementById('outTitle').innerText = "感应中...";
        document.getElementById('outBody').innerText = "";

        try {
            const response = await fetch('https://api.deepseek.com/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [{ role: "system", content: SYSTEM_PROMPT }, { role: "user", content: poem }],
                    temperature: 1.15
                })
            });
            const data = await response.json();
            const text = data.choices[0].message.content.replace(/[#*`>~]/g, '').trim();
            const lines = text.split('\n').filter(l => l.trim() !== '');
            
            document.getElementById('outTitle').innerText = lines[0];
            document.getElementById('outBody').innerText = lines.slice(1).join('\n').trim();
            
            // 设置当前时间
            const now = new Date();
            document.getElementById('outDate').innerText = `${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')}`;
            
        } catch (e) {
            alert("共鸣中断");
        } finally {
            btn.innerText = "开启共鸣"; btn.disabled = false;
        }
    }

    // 修复下载功能
    function downloadCard() {
        const cardArea = document.getElementById('cardArea');
        html2canvas(cardArea, { 
            scale: 3, 
            backgroundColor: "#f7f5f0",
            useCORS: true 
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = `古诗共鸣-${Date.now()}.jpg`;
            link.href = canvas.toDataURL('image/jpeg', 0.95); // 修正拼写错误
            link.click();
        }).catch(err => {
            console.error("下载失败", err);
            alert("导出图片失败，请重试");
        });
    }
</script>
<script src="common.js"></script>
<script src="qipao.js"></script>    
</body>

</html>
