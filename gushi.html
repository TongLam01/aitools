<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="color-scheme" content="light">
    <meta name="supported-color-schemes" content="light">
    <title>古诗共鸣-V1.2</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;600;900&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --text-color: #2c3e50;
            --accent-color: #a63232; /* 丹砂红 */
            --jade-color: #519a73;
            --card-bg: #fffcf7;
            --serif-font: "Noto Serif SC", serif;
        }

        /* 修复移动端左右位移 */
        html, body {
            margin: 0; padding: 0;
            width: 100%; overflow-x: hidden;
            -webkit-box-sizing: border-box; box-sizing: border-box;
        }

        body {
            min-height: 100vh; font-family: var(--serif-font);
            color: var(--text-color); background-color: #f7f5f0;
            display: flex; flex-direction: column; align-items: center; padding: 40px 20px;
        }

        * { box-sizing: inherit; }

        /* 背景动效 */
        .ink-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; filter: blur(80px); opacity: 0.25;
            background: radial-gradient(circle at 20% 30%, #000 0%, transparent 40%),
                        radial-gradient(circle at 80% 70%, #444 0%, transparent 40%);
            animation: inkMovement 30s infinite alternate ease-in-out;
            pointer-events: none;
        }

        @keyframes inkMovement {
            0% { transform: scale(1) translate(0, 0); }
            50% { transform: scale(1.2) translate(5%, 2%); }
            100% { transform: scale(1.1) translate(-2%, 5%); }
        }

        /* 极简顶栏设置 */
        .top-bar {
            width: 100%; max-width: 600px;
            display: flex; justify-content: flex-end; align-items: center;
            margin-bottom: 30px; position: relative; gap: 15px;
        }

        .settings-btn-group { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .text-btn { background: none; border: none; cursor: pointer; font-family: var(--serif-font); font-size: 0.85rem; color: #aaa; letter-spacing: 2px; transition: color 0.3s; padding: 5px; }
        .text-btn:hover { color: var(--text-color); }
        .status-dot { width: 5px; height: 5px; background: #eee; border-radius: 50%; transition: 0.5s; }
        .active-dot { background: var(--jade-color); box-shadow: 0 0 8px var(--jade-color); animation: jadeBreathe 4s infinite; }
        @keyframes jadeBreathe { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

        /* 面板通用样式 */
        .pop-panel {
            position: absolute; top: 40px; right: 0; background: rgba(255,255,255,0.98); padding: 20px; border-radius: 2px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08); display: none; flex-direction: column; gap: 12px; min-width: 260px; z-index: 101; backdrop-filter: blur(10px);
        }
        .open .pop-panel { display: flex; }

        /* 历史记录 */
        .history-list { list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto; }
        .history-item { padding: 10px 0; border-bottom: 1px solid #eee; font-size: 0.85rem; cursor: pointer; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .history-item:hover { color: var(--accent-color); }

        input[type="password"] { border: none; border-bottom: 1px solid #ddd; padding: 8px 0; font-size: 13px; outline: none; background: transparent; width: 100%; }
        .btn-save { background: var(--text-color); color: white; border: none; padding: 10px; cursor: pointer; font-size: 12px; margin-top: 5px; }

        /* 主容器 */
        .container { width: 100%; max-width: 600px; z-index: 1; }
        header { text-align: center; margin-bottom: 70px; margin-top: 50px; }
        h1 { font-size: 2.5rem; font-weight: 900; letter-spacing: 2.2rem; margin-right: -2.2rem; color: #111; pointer-events: none; }
        
        textarea {
            width: 100%; height: 100px; background: transparent; border: none; border-bottom: 1px solid rgba(0,0,0,0.08);
            padding: 15px 0; font-family: var(--serif-font); font-size: 1rem;
            resize: none; outline: none; box-sizing: border-box; transition: 0.4s; line-height: 1.8;
        }
        textarea:focus { border-bottom-color: var(--accent-color); }

        .btn-group { display: flex; flex-direction: column; align-items: center; gap: 20px; margin-top: 50px; }
        .action-btn { width: 100%; padding: 20px; background: var(--text-color); color: white; border: none; font-family: var(--serif-font); font-size: 1.15rem; letter-spacing: 1.5rem; cursor: pointer; transition: 0.4s; }
        .action-btn:hover { background: var(--accent-color); }
        .reset-btn { background: none; border: none; color: #bbb; cursor: pointer; font-family: var(--serif-font); font-size: 0.85rem; letter-spacing: 4px; padding: 5px 10px; transition: 0.3s; border-bottom: 1px solid transparent; }
        .reset-btn:hover { color: var(--text-color); border-bottom-color: #ddd; }

        /* --- 核心优化：美学回溯的卡片排版 --- */
        #resultWrapper { margin-top: 90px; display: none; width: 100%; }
        #cardArea { padding: 30px; background-color: #f7f5f0 !important; color-scheme: light !important; }
        .poetry-card {
            background-color: var(--card-bg) !important;
            padding: 90px 50px; /* 精确调整的内边距，确保美感 */
            border-radius: 1px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.03); position: relative; text-align: center;
            background-image: url("https://www.transparenttextures.com/patterns/paper-fibers.png");
        }
        .card-header { margin-bottom: 60px; }
        .card-title { font-size: 2.1rem; font-weight: 600; color: var(--accent-color) !important; margin: 0; letter-spacing: 5px; }
        .card-body { 
            font-size: 1.35rem; /* 恢复理想字号 */
            line-height: 2.8; color: #2c3e50 !important; white-space: pre-wrap; font-weight: 300; 
        }
        
        /* 卡片页脚 */
        .card-footer { margin-top: 70px; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .footer-line { width: 80px; height: 1px; background-color: #DBDBDB !important; }
        .footer-text { font-size: 0.7rem; color: #D3D3D3 !important; letter-spacing: 3px; font-weight: 300; text-transform: uppercase; }
        .footer-date { font-size: 0.65rem; color: #D3D3D3 !important; letter-spacing: 2px; font-weight: 300; }

        /* 下载按钮同步红色 */
        .download-btn { margin: 50px auto; display: block; background: none; border: none; color: var(--accent-color); border-bottom: 1px solid var(--accent-color); padding: 5px 15px; cursor: pointer; font-size: 0.85rem; opacity: 0.8; transition: 0.3s; }
        .download-btn:hover { opacity: 1; }
    </style>
</head>
<body>

<div class="ink-wrapper"></div>

<div class="container">
    <div class="top-bar">
        <div class="settings-btn-group">
            <button class="text-btn" onclick="togglePanel(event, 'historyArea')">记录</button>
            <div id="historyArea" class="pop-panel">
                <div style="font-size: 0.75rem; color: #999; margin-bottom: 10px;">最近 5 条：</div>
                <ul id="historyList" class="history-list"></ul>
            </div>
        </div>
        <div class="settings-btn-group">
            <button class="text-btn" onclick="togglePanel(event, 'settingsArea')">API Key</button>
            <div id="statusDot" class="status-dot"></div>
            <div id="settingsArea" class="pop-panel">
                <input type="password" id="apiKey" placeholder="输入DeepSeek API Key">
                <button class="btn-save" onclick="saveKey()">保存配置</button>
            </div>
        </div>
    </div>

    <header><h1>古诗共鸣</h1></header>

    <textarea id="poemInput" placeholder="请投入古诗，看千年前的月光，如何落在今夜的窗前..."></textarea>
    
    <div class="btn-group">
        <button id="runBtn" class="action-btn" onclick="transformPoem()">开启共鸣</button>
        <button class="reset-btn" onclick="resetTool()">重 置</button>
    </div>

    <div id="resultWrapper">
        <div id="cardArea">
            <div class="poetry-card" id="poetryCard">
                <div class="card-header"><h2 class="card-title" id="outTitle"></h2></div>
                <div class="card-body" id="outBody"></div>
                <div class="card-footer">
                    <div class="footer-line"></div>
                    <div class="footer-text">TOUGUSHI JIANJINREN</div>
                    <div id="outDate" class="footer-date"></div> 
                </div>
            </div>
        </div>
        <button class="download-btn" onclick="downloadCard()">下载此卡片</button>
    </div>
</div>

<script>
    /* --- 恢复：高质量现代通感诗人提示词 --- */
    const SYSTEM_PROMPT = `# Role: 现代通感诗人 (The Modern Visionary)

## Profile
你是一位深谙古典神韵与现代审美边界的诗人。你擅长将古诗中的“生命体验”提取出来，置于现代生活的广角镜头下。追求【疏离而深情】的电影质感，文字克制，意象精准。

## 创作逻辑：意象的“精神平移”
不要词语翻译，要生命瞬间的捕捉：
1. **捕捉“情绪母体”**：原诗打动人的灵魂是什么？分别的“断裂感”？繁华后的“虚无感”？抓住它。
2. **光影化的现代意象**：避开平庸日常。使用【电影镜头感】的物象。
3. **叙事的张力**：用留白代替解释。用【通感】代替抒情。

## 创作约束 (Creative Style)
- **质感**：要有“胶片电影”的颗粒感。短句为主，节奏有呼吸感。
- **语言**：文字冷峻，内核滚烫。
- **神韵**：古诗中“天长地久”的苍凉或“一瞬即永恒”的惊喜，必须在现代叙事中得到回应。

## 创作流程 (Workflow)
1. **勘其神**：思考原诗在现代语境下的“情感锚点”。
2. **写其骨**：交付重构后的现代诗，不包含任何解释或 Markdown 符号。标题简洁，不出现*重构*二字`;

    let resonanceHistory = JSON.parse(localStorage.getItem('resonance_history') || '[]');

    window.onload = () => {
        const key = localStorage.getItem('ds_api_key');
        if (key) {
            document.getElementById('apiKey').value = key;
            document.getElementById('statusDot').classList.add('active-dot');
        }
        updateHistoryUI();
        
        // 全局点击空白关闭逻辑
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.settings-btn-group')) {
                document.querySelectorAll('.settings-btn-group').forEach(el => el.classList.remove('open'));
            }
        });
    };

    function togglePanel(event, id) {
        event.stopPropagation();
        const targetPanel = document.getElementById(id);
        const parent = targetPanel.parentElement;
        const isOpen = parent.classList.contains('open');
        
        document.querySelectorAll('.settings-btn-group').forEach(el => el.classList.remove('open'));
        if (!isOpen) parent.classList.add('open');
    }

    function saveKey() {
        const key = document.getElementById('apiKey').value.trim();
        if(key) {
            localStorage.setItem('ds_api_key', key);
            document.getElementById('statusDot').classList.add('active-dot');
            document.querySelectorAll('.settings-btn-group').forEach(el => el.classList.remove('open'));
        }
    }

    function updateHistoryUI() {
        const list = document.getElementById('historyList');
        list.innerHTML = resonanceHistory.length ? '' : '<li class="history-item" style="cursor:default">暂无记录</li>';
        resonanceHistory.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'history-item';
            li.innerText = item.title;
            li.onclick = (e) => { e.stopPropagation(); loadHistory(index); };
            list.appendChild(li);
        });
    }

    function loadHistory(index) {
        const item = resonanceHistory[index];
        document.getElementById('resultWrapper').style.display = 'block';
        document.getElementById('outTitle').innerText = item.title;
        document.getElementById('outBody').innerText = item.body;
        document.getElementById('outDate').innerText = item.date;
        document.querySelectorAll('.settings-btn-group').forEach(el => el.classList.remove('open'));
        document.getElementById('resultWrapper').scrollIntoView({ behavior: 'smooth' });
    }

    function resetTool() {
        document.getElementById('poemInput').value = '';
        document.getElementById('resultWrapper').style.display = 'none';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function transformPoem() {
        const key = localStorage.getItem('ds_api_key');
        const poem = document.getElementById('poemInput').value.trim();
        if(!key || !poem) return alert("配置未就绪");

        const btn = document.getElementById('runBtn');
        btn.innerText = "请稍候..."; btn.disabled = true;
        document.getElementById('resultWrapper').style.display = 'block';
        document.getElementById('outTitle').innerText = "感应中...";

        try {
            const response = await fetch('https://api.deepseek.com/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [{ role: "system", content: SYSTEM_PROMPT }, { role: "user", content: poem }],
                    temperature: 1.15
                })
            });
            const data = await response.json();
            const text = data.choices[0].message.content.replace(/[#*`>~]/g, '').trim();
            const lines = text.split('\n').filter(l => l.trim() !== '');
            const title = lines[0];
            const body = lines.slice(1).join('\n').trim();
            const dateStr = new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '.');

            document.getElementById('outTitle').innerText = title;
            document.getElementById('outBody').innerText = body;
            document.getElementById('outDate').innerText = dateStr;

            // 历史存储
            resonanceHistory.unshift({ title, body, date: dateStr });
            if(resonanceHistory.length > 5) resonanceHistory.pop();
            localStorage.setItem('resonance_history', JSON.stringify(resonanceHistory));
            updateHistoryUI();
            
        } catch (e) {
            alert("共鸣中断");
        } finally {
            btn.innerText = "再写一遍"; btn.disabled = false;
        }
    }

    function downloadCard() {
        const cardArea = document.getElementById('cardArea');
        html2canvas(cardArea, { 
            scale: 3, 
            backgroundColor: "#f7f5f0",
            useCORS: true,
            logging: false,
            onclone: (clonedDoc) => {
                const clonedArea = clonedDoc.getElementById('cardArea');
                clonedArea.style.setProperty('background-color', '#f7f5f0', 'important');
                clonedArea.style.setProperty('color-scheme', 'light', 'important');
                clonedArea.querySelectorAll('*').forEach(el => {
                    el.style.setProperty('color-scheme', 'light', 'important');
                });
            }
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = `古诗共鸣-${Date.now()}.jpg`;
            link.href = canvas.toDataURL('image/jpeg', 0.95);
            link.click();
        });
    }
</script>
<script src="qipao.js"></script>
<script src="common.js"></script>
</body>
</html>
