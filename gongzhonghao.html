/** * GZH AI Editor v2.1
 * 修复了 ID 缺失导致的报错及工具栏不显示问题
 */

// 1. 域名安全检测
const ALLOWED = ['aibox6.com', 'www.aibox6.com', 'localhost', '127.0.0.1'];
if (!ALLOWED.includes(window.location.hostname)) {
    document.body.innerHTML = "<div style='padding:100px;text-align:center;'>Domain Denied.</div>";
}

let activeBlockEl = null;
let newDraftContent = "";

// 2. 初始化
window.addEventListener('DOMContentLoaded', () => {
    const key = localStorage.getItem('ds_api_key_v1');
    if (key) {
        if(document.getElementById('apiKeyInput')) document.getElementById('apiKeyInput').value = key;
        updateApiLight(true);
    }
});

function toggleApiModal(show) { 
    const modal = document.getElementById('apiModal');
    if(modal) modal.classList.toggle('hidden', !show); 
}

function updateApiLight(ok) {
    const dot = document.getElementById('statusDot');
    if(dot) dot.className = `w-3 h-3 rounded-full ${ok ? 'breathing-green' : 'breathing-red'}`;
}

function saveApiKey() {
    const input = document.getElementById('apiKeyInput');
    const key = input ? input.value.trim() : "";
    if (!key.startsWith('sk-')) return alert("请输入以 sk- 开头的有效密钥");
    localStorage.setItem('ds_api_key_v1', key);
    updateApiLight(true);
    toggleApiModal(false);
}

function checkKeyOnFocus() {
    if (!localStorage.getItem('ds_api_key_v1')) toggleApiModal(true);
}

function updateWordCount(textarea) {
    const count = textarea.value.length;
    const label = document.getElementById('charCount');
    if(label) {
        label.innerText = `${count} / 150`;
        label.className = `text-xs ml-2 ${count >= 150 ? 'text-green-500 font-bold' : 'text-red-400'}`;
    }
}

// 3. 核心交互逻辑：原子化块
function createAtomicBlock(content = "") {
    const div = document.createElement('div');
    div.className = "block-node text-gray-800 leading-relaxed";
    div.innerText = content;
    
    div.onclick = (e) => {
        e.stopPropagation();
        // 视觉切换
        if (activeBlockEl) activeBlockEl.classList.remove('active');
        activeBlockEl = div;
        activeBlockEl.classList.add('active');
        
        // 显示工具栏
        const bar = document.getElementById('floatingBar');
        if(bar) {
            bar.classList.remove('hidden');
            // 定位：由于 shell 是 relative，我们将 bar 放在屏幕顶端或块上方
            // 此处采用固定在模拟器顶部的方案，防止被遮挡
            bar.style.opacity = "1";
        }
    };
    return div;
}

// 4. 生成主逻辑
async function runGeneration() {
    const key = localStorage.getItem('ds_api_key_v1');
    if (!key) return toggleApiModal(true);

    const materialEl = document.getElementById('material');
    if (!materialEl || materialEl.value.length < 150) return alert("写作素材字数不足150字");

    const btn = document.getElementById('genBtn');
    const view = document.getElementById('editorView');
    
    btn.disabled = true;
    btn.innerText = "DeepSeek 思考中...";
    view.innerHTML = "";

    // 安全读取参数
    const getVal = (id) => {
        const el = document.getElementById(id);
        return el ? el.value : "";
    };

    const params = {
        topic: getVal('topic'),
        style: getVal('style'),
        referenceStyle: getVal('refStyle'),
        material: materialEl.value,
        taboos: getVal('taboos'),
        lengthRange: getVal('lengthRange')
    };

    try {
        const response = await fetch("https://api.deepseek.com/chat/completions", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": `Bearer ${key}` },
            body: JSON.stringify({
                model: "deepseek-chat",
                messages: [
                    { role: "system", content: GZH_PROMPTS.system },
                    { role: "user", content: GZH_PROMPTS.generate(params) }
                ],
                stream: true
            })
        });

        if (!response.ok) throw new Error("API连接失败");

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let currentBlock = createAtomicBlock("");
        view.appendChild(currentBlock);

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');
            for (let line of lines) {
                if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                    try {
                        const json = JSON.parse(line.substring(6));
                        const text = json.choices[0].delta.content || "";
                        if (text.includes('\n')) {
                            currentBlock = createAtomicBlock("");
                            view.appendChild(currentBlock);
                        } else {
                            currentBlock.innerText += text;
                            view.scrollTop = view.scrollHeight;
                        }
                    } catch (e) {}
                }
            }
        }
    } catch (err) {
        view.innerHTML = `<div class='text-red-500 p-4 text-xs'>生成中断: ${err.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.innerText = "重新生成全文";
    }
}

// 5. 块操作
async function handleBlockAction(action) {
    if (!activeBlockEl) return;
    const key = localStorage.getItem('ds_api_key_v1');
    const originalText = activeBlockEl.innerText;
    
    activeBlockEl.classList.add('animate-pulse', 'bg-blue-50');
    document.getElementById('floatingBar').classList.add('hidden');

    try {
        const res = await fetch("https://api.deepseek.com/chat/completions", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": `Bearer ${key}` },
            body: JSON.stringify({
                model: "deepseek-chat",
                messages: [
                    { role: "system", content: GZH_PROMPTS.system },
                    { role: "user", content: GZH_PROMPTS.blockAction(action, originalText, originalText) }
                ]
            })
        });
        const data = await res.json();
        newDraftContent = data.choices[0].message.content;
        
        document.getElementById('oldTextPreview').innerText = originalText;
        document.getElementById('newTextPreview').innerText = newDraftContent;
        document.getElementById('compareModal').classList.remove('hidden');
    } catch (e) {
        alert("优化失败，请稍后再试");
    } finally {
        activeBlockEl.classList.remove('animate-pulse', 'bg-blue-50');
    }
}

function closeCompareModal() { document.getElementById('compareModal').classList.add('hidden'); }
function confirmReplace() {
    if (activeBlockEl && newDraftContent) activeBlockEl.innerText = newDraftContent;
    closeCompareModal();
}

function copyAll() {
    const text = Array.from(document.querySelectorAll('.block-node')).map(el => el.innerText).join('\n\n');
    navigator.clipboard.writeText(text).then(() => alert("全文已复制！"));
}

// 点击空白处关闭菜单
window.onclick = (e) => {
    if (!e.target.closest('.block-node') && !e.target.closest('#floatingBar')) {
        if (activeBlockEl) activeBlockEl.classList.remove('active');
        const bar = document.getElementById('floatingBar');
        if(bar) bar.classList.add('hidden');
    }
};
