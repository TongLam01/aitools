<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡è½¬æ–‡å­— V1.1</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 20px; color: #333; }
        .container { background: white; width: 100%; max-width: 800px; padding: 30px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        h2 { text-align: center; margin-top: 0; color: #2c3e50; }
        
        /* æ‹–æ‹½ä¸Šä¼ åŒº */
        .upload-area {
            border: 2px dashed #cbd5e0; border-radius: 8px; padding: 30px; text-align: center;
            background: #f8fafc; cursor: pointer; transition: all 0.3s; position: relative;
        }
        .upload-area:hover, .upload-area.drag-over { border-color: #4299e1; background: #ebf8ff; }
        .upload-hint { color: #718096; font-size: 15px; margin-bottom: 10px; }
        .upload-sub-hint { color: #a0aec0; font-size: 12px; }
        #fileInput { display: none; }

        /* é¢„è§ˆä¸ç»“æœåˆ†æ  */
        .workspace { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 300px; }
        
        .preview-box { border: 1px solid #e2e8f0; border-radius: 6px; height: 300px; display: flex; align-items: center; justify-content: center; overflow: hidden; background: #edf2f7; }
        .preview-box img { max-width: 100%; max-height: 100%; display: none; }
        
        textarea { width: 100%; height: 300px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; resize: none; font-size: 15px; line-height: 1.6; box-sizing: border-box; }
        textarea:focus { outline: 2px solid #4299e1; border-color: transparent; }

        /* è¿›åº¦æ¡ä¸æ§åˆ¶æ  */
        .status-bar { margin: 15px 0; background: #edf2f7; height: 6px; border-radius: 3px; overflow: hidden; position: relative; }
        .progress-fill { height: 100%; background: #48bb78; width: 0%; transition: width 0.3s; }
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 14px; }
        .btn-primary { background: #4299e1; color: white; }
        .btn-primary:hover { background: #3182ce; }
        .btn-primary:disabled { background: #a0aec0; cursor: not-allowed; }
        .btn-copy { background: #e2e8f0; color: #4a5568; }
        .btn-copy:hover { background: #cbd5e0; }
        
        #log { font-size: 12px; color: #718096; margin-top: 5px; min-height: 1.5em; }
    </style>
</head>
<body>

<div class="container">
    <h2>âš¡ å›¾ç‰‡è½¬æ–‡å­— V1.1</h2>

    <div class="upload-area" id="dropZone">
        <div class="upload-hint">ç‚¹å‡»ä¸Šä¼ ï¼Œæˆ–å°†å›¾ç‰‡æ‹–æ‹½è‡³æ­¤</div>
        <div class="upload-sub-hint">ğŸ’¡ æ”¯æŒç›´æ¥ Ctrl+V ç²˜è´´æˆªå›¾</div>
        <input type="file" id="fileInput" accept="image/*">
    </div>

    <div style="margin-top: 15px;">
        <div class="controls">
            <div style="font-size: 14px; color: #4a5568;">
                <label><input type="checkbox" id="autoFormat" checked> æ™ºèƒ½å»ç©ºæ ¼</label>
            </div>
            <button id="btnStart" class="btn btn-primary" disabled>å¼€å§‹è¯†åˆ«</button>
        </div>
        <div class="status-bar"><div class="progress-fill" id="progress"></div></div>
        <div id="log">å‡†å¤‡å°±ç»ª...</div>
    </div>

    <div class="workspace">
        <div class="col">
            <div class="preview-box">
                <span id="preview-text" style="color:#a0aec0; font-size: 14px;">å›¾ç‰‡é¢„è§ˆ</span>
                <img id="previewImg">
            </div>
        </div>
        <div class="col" style="position: relative;">
            <textarea id="result" placeholder="è¯†åˆ«ç»“æœ..."></textarea>
            <button id="btnCopy" class="btn btn-copy" style="position: absolute; bottom: 10px; right: 10px;">å¤åˆ¶</button>
        </div>
    </div>
</div>

<script>
    // å…ƒç´ è·å–
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const previewImg = document.getElementById('previewImg');
    const btnStart = document.getElementById('btnStart');
    const resultArea = document.getElementById('result');
    const progressFill = document.getElementById('progress');
    const logEl = document.getElementById('log');
    const autoFormatEl = document.getElementById('autoFormat');
    const btnCopy = document.getElementById('btnCopy');
    const previewText = document.getElementById('preview-text');

    let currentFile = null;

    // === 1. æ ¸å¿ƒäº¤äº’ï¼šç‚¹å‡»ã€æ‹–æ‹½ã€ç²˜è´´ ===

    // ç‚¹å‡»ä¸Šä¼ 
    dropZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

    // æ‹–æ‹½ä¸Šä¼ 
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });

    // ç²˜è´´ä¸Šä¼  (Ctrl+V)
    document.addEventListener('paste', (e) => {
        const items = e.clipboardData.items;
        for (let item of items) {
            if (item.type.indexOf('image') !== -1) {
                const blob = item.getAsFile();
                handleFile(blob);
                break;
            }
        }
    });

    // === 2. æ–‡ä»¶å¤„ç†ä¸é¢„è§ˆ ===
    function handleFile(file) {
        if (!file || !file.type.startsWith('image/')) return;
        
        currentFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
            previewImg.src = e.target.result;
            previewImg.style.display = 'block';
            previewText.style.display = 'none';
            btnStart.disabled = false;
            // è‡ªåŠ¨è§¦å‘è¯†åˆ«ä½“éªŒæ›´å¥½ï¼Œè¿™é‡Œä¿ç•™æ‰‹åŠ¨ç‚¹å‡»
            logEl.innerText = `å·²åŠ è½½å›¾ç‰‡: ${file.name || 'æˆªå›¾'} (${(file.size/1024).toFixed(1)}KB)`;
            resultArea.value = '';
            progressFill.style.width = '0%';
        };
        reader.readAsDataURL(file);
    }

    // === 3. è¯†åˆ«é€»è¾‘ ===
    btnStart.addEventListener('click', async () => {
        if (!currentFile) return;

        btnStart.disabled = true;
        resultArea.value = 'æ­£åœ¨åˆå§‹åŒ–å¼•æ“...';
        
        try {
            const worker = await Tesseract.createWorker('chi_sim+eng', 1, {
                logger: m => {
                    if (m.status === 'recognizing text') {
                        const p = Math.round(m.progress * 100);
                        progressFill.style.width = p + '%';
                        logEl.innerText = `è¯†åˆ«ä¸­... ${p}%`;
                    } else if (m.status.includes('download')) {
                        const p = Math.round(m.progress * 100);
                        logEl.innerText = `ä¸‹è½½è¯­è¨€æ¨¡å‹... ${p}%`;
                        progressFill.style.width = (p * 0.2) + '%'; // ä¸‹è½½åªå å‰20%
                    }
                }
            });

            logEl.innerText = 'æ­£åœ¨åˆ†æ...';
            const { data: { text } } = await worker.recognize(currentFile);
            
            // æ–‡æœ¬æ¸…æ´— (ä¼˜åŒ–ç®—æ³•)
            let output = text;
            if (autoFormatEl.checked) {
                // ç¬¬ä¸€æ­¥ï¼šå¤„ç† "æ±‰å­— æ±‰å­—" ä¹‹é—´çš„ç©ºæ ¼ã€‚è¿è¡Œä¸¤æ¬¡ä»¥è§£å†³é‡å åŒ¹é…é—®é¢˜ (ä¾‹å¦‚: A B C)
                output = output.replace(/([\u4e00-\u9fa5])\s+([\u4e00-\u9fa5])/g, '$1$2');
                output = output.replace(/([\u4e00-\u9fa5])\s+([\u4e00-\u9fa5])/g, '$1$2');

                // ç¬¬äºŒæ­¥ï¼šå¤„ç† "æ±‰å­— æ ‡ç‚¹" å’Œ "æ ‡ç‚¹ æ±‰å­—"ã€‚å¢åŠ äº†å¯¹è‹±æ–‡æ ‡ç‚¹çš„å…¼å®¹
                // è§£é‡Šï¼š([\u4e00-\u9fa5]) åŒ¹é…ä¸­æ–‡ï¼Œ[ï¼Œã€‚ï¼›ï¼šï¼ï¼Ÿ,.?!%] åŒ¹é…ä¸­è‹±æ–‡å¸¸è§æ ‡ç‚¹
                output = output.replace(/([\u4e00-\u9fa5])\s+([ï¼Œã€‚ï¼›ï¼šï¼ï¼Ÿ,.?!%])/g, '$1$2');
                output = output.replace(/([ï¼Œã€‚ï¼›ï¼šï¼ï¼Ÿ,.?!%])\s+([\u4e00-\u9fa5])/g, '$1$2');
            }

            resultArea.value = output;
            logEl.innerText = `âœ… å®Œæˆ! è€—æ—¶: ${(new Date() - startTime)/1000}s`;
            await worker.terminate();

        } catch (err) {
            console.error(err);
            resultArea.value = 'é”™è¯¯: ' + err.message;
        } finally {
            btnStart.disabled = false;
        }
    });
    
    // è®¡æ—¶å™¨è¾…åŠ©
    let startTime;
    btnStart.addEventListener('mousedown', () => startTime = new Date());

    // === 4. å¤åˆ¶åŠŸèƒ½ ===
    btnCopy.addEventListener('click', () => {
        resultArea.select();
        document.execCommand('copy');
        const originalText = btnCopy.innerText;
        btnCopy.innerText = 'å·²å¤åˆ¶!';
        setTimeout(() => btnCopy.innerText = originalText, 1500);
    });

</script>
<script src="common.js"></script>
</body>
</html>
