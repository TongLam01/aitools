<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown æç®€æ’ç‰ˆä¸ PDF å¯¼å‡º</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            /* å¾®ä¿¡ç»¿ä¸»é¢˜ */
            --primary: #07c160;       
            --primary-hover: #06ad56; 
            --primary-light: #e8f9f0; 
            
            --font-size: 16px;
            --line-height: 1.8;
            --text-color: #1f2937;
            --heading-color: #111827;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            
            --aside-bg: #fffbeb;
            --aside-border: #f59e0b;
            --aside-text: #451a03;
            
            --bg-app: #f9fafb;
            --bg-panel: #ffffff;
            --border-color: #e5e7eb;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            display: flex; height: 100vh;
            font-family: var(--font-family);
            background-color: var(--bg-app);
            color: var(--text-color);
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        /* ========== å·¦ä¾§æ§åˆ¶å° ========== */
        .sidebar {
            width: 420px; 
            background: var(--bg-panel); 
            padding: 24px 24px;
            border-right: 1px solid var(--border-color); 
            display: flex; flex-direction: column; gap: 24px; 
            overflow-y: auto; z-index: 10;
        }

        .sidebar-header {
            display: flex; align-items: center; justify-content: space-between;
        }
        .sidebar h2 { margin: 0; font-size: 18px; font-weight: 600; color: #111827; }

        .section-title { 
            font-size: 14px; font-weight: 600; color: var(--primary); 
            letter-spacing: 0.02em;
            margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
        }
        .collapse-toggle { cursor: pointer; user-select: none; transition: opacity 0.2s; }
        .collapse-toggle:hover { opacity: 0.8; }
        
        .control-group { display: flex; flex-direction: column; gap: 8px; }
        .collapse-content { display: none; flex-direction: column; gap: 8px; }

        input[type="text"], textarea, select {
            width: 100%; padding: 10px 12px;
            border: 1px solid var(--border-color); border-radius: 8px;
            font-size: 13px; font-family: inherit; color: #374151;
            background: #ffffff; transition: all 0.2s; outline: none;
        }
        input[type="text"]:focus, textarea:focus, select:focus {
            border-color: var(--primary); box-shadow: 0 0 0 3px rgba(7, 193, 96, 0.1);
        }
        textarea { min-height: 200px; resize: vertical; line-height: 1.5; font-family: monospace;}

        .slider-row { display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #4b5563; margin-bottom: 4px;}
        input[type="range"] { 
            -webkit-appearance: none; width: 100%; height: 4px; border-radius: 2px;
            background: #e5e7eb; outline: none; margin: 10px 0;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%;
            background: #ffffff; border: 2px solid var(--primary); cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .top-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 4px; gap: 8px;}
        
        .custom-upload-btn {
            background: var(--primary-light); color: var(--primary); border: 1px solid #bbf7d0;
            padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;
            display: inline-flex; align-items: center; justify-content: center; flex: 1; transition: all 0.2s;
        }
        .custom-upload-btn:hover { background: #dcfce7; border-color: #86efac; }
        .custom-upload-btn input[type="file"] { display: none; }

        .btn-clear { 
            background: #fef2f2; color: #ef4444; border: 1px solid #fecaca; 
            padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s;
        }
        .btn-clear:hover { background: #fee2e2; border-color: #fca5a5;}

        .btn-primary {
            background-color: var(--primary); color: white; border: none;
            padding: 12px; border-radius: 8px; cursor: pointer;
            font-size: 15px; font-weight: 500; transition: all 0.2s; width: 100%;
            box-shadow: 0 2px 4px rgba(7, 193, 96, 0.2);
        }
        .btn-primary:hover { background-color: var(--primary-hover); transform: translateY(-1px); box-shadow: 0 4px 6px rgba(7, 193, 96, 0.3); }

        /* ========== å·¥å…·æ  ========== */
        .toolbar {
            display: flex; flex-wrap: wrap; gap: 4px; align-items: center;
            background: #f9fafb; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);
        }
        .toolbar-group { display: flex; gap: 4px; align-items: center; }
        .toolbar-divider { width: 1px; height: 20px; background: #e5e7eb; margin: 0 4px; }
        
        .toolbar-btn {
            background: transparent; border: 1px solid transparent; 
            width: 32px; height: 32px; padding: 0;
            border-radius: 6px; cursor: pointer; font-size: 14px; color: #4b5563;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
            font-family: serif; font-weight: bold;
        }
        .toolbar-btn:hover { background: #f3f4f6; color: #111827; border-color: #d1d5db; }
        .toolbar select.toolbar-btn { width: auto; padding: 0 20px 0 8px; font-family: sans-serif; font-weight: normal; }

        /* --- åˆ†ç¦»å¼é¢œè‰²æŒ‰é’® (Split Button) æ–°è®¾è®¡ --- */
        .split-color-btn {
            display: flex; align-items: center; height: 32px;
            border: 1px solid transparent; border-radius: 6px; transition: all 0.2s;
        }
        .split-color-btn:hover { background: #f3f4f6; border-color: #d1d5db; }
        
        .split-color-main {
            background: transparent; border: none; padding: 0; width: 24px; height: 100%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-family: serif; font-weight: bold; font-size: 14px; border-radius: 6px 0 0 6px;
        }
        .split-color-drop {
            position: relative; width: 14px; height: 100%; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            border-left: 1px solid transparent; border-radius: 0 6px 6px 0;
        }
        .split-color-btn:hover .split-color-drop { border-left-color: #d1d5db; }
        .split-color-drop input[type="color"] {
            position: absolute; width: 200%; height: 200%; top: -50%; left: -50%;
            opacity: 0; cursor: pointer;
        }

        .btn-aside {
            background: #fffbeb; color: #d97706; border: 1px solid #fde68a;
            padding: 8px 12px; border-radius: 6px; font-size: 13px; font-weight: 600;
            width: 100%; margin-top: 6px; display: flex; justify-content: center; align-items: center; gap: 6px;
            transition: all 0.2s; cursor: pointer;
        }
        .btn-aside:hover { background: #fef3c7; border-color: #fcd34d; }

        .aside-color-settings {
            display: flex; gap: 12px; margin-top: 4px; padding: 12px;
            background: #f9fafb; border-radius: 8px; border: 1px solid var(--border-color);
        }
        .color-control { flex: 1; display: flex; flex-direction: column; gap: 6px; align-items: center; }
        .color-control span { font-size: 11px; color: #6b7280; }
        .color-control input[type="color"] { width: 100%; height: 24px; border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; padding: 0; }

        /* ========== å³ä¾§é¢„è§ˆåŒº ========== */
        .preview-container {
            flex-grow: 1; padding: 40px; overflow-y: auto;
            display: flex; justify-content: center; align-items: flex-start;
        }

        .markdown-body {
            background: white; padding: 60px 80px; width: 100%; max-width: 850px; min-height: 100%;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025), 0 0 0 1px rgba(0,0,0,0.02);
            font-size: var(--font-size); line-height: var(--line-height); color: var(--text-color);
            outline: none; transition: box-shadow 0.2s;
        }
        .markdown-body:focus { box-shadow: 0 0 0 2px rgba(7, 193, 96, 0.3), 0 10px 15px -3px rgba(0, 0, 0, 0.05); }

        .markdown-body table { width: 100%; border-collapse: collapse; margin-bottom: 1.5em; font-size: 0.95em; table-layout: auto; }
        .markdown-body th, .markdown-body td { border: 1px solid var(--border-color); padding: 10px 14px; text-align: left; position: relative; word-break: break-word;}
        .markdown-body th { background-color: #f9fafb; font-weight: 600; color: #111827; }
        
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { color: var(--heading-color); margin-top: 1.5em; margin-bottom: 0.5em; font-weight: 600; }
        .markdown-body h1 { font-size: 2em; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
        .markdown-body h2 { font-size: 1.5em; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
        .markdown-body p { margin-bottom: 1em; }
        
        .markdown-body aside {
            background-color: var(--aside-bg) !important; 
            border-left: 4px solid var(--aside-border) !important;
            color: var(--aside-text) !important;
            padding: 16px 20px; margin: 1.5em 0; border-radius: 0 8px 8px 0;
            display: block; box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        
        @media print {
            @page { margin: 15mm; } 
            body { background: white; }
            .sidebar { display: none !important; }
            .preview-container { padding: 0; display: block; overflow: visible; align-items: stretch; }
            .markdown-body { box-shadow: none; padding: 0; border-radius: 0; max-width: 100%; border: none;}
            h1, h2, h3, h4, h5 { page-break-after: avoid; }
            img, pre, blockquote { page-break-inside: avoid; }
            .markdown-body aside { 
                page-break-inside: avoid; 
                -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;
                background-color: var(--aside-bg) !important; border-left: 4px solid var(--aside-border) !important; color: var(--aside-text) !important;
            }
            table { page-break-inside: auto; }
            tr { page-break-inside: avoid; }
            thead { display: table-header-group; } 
        }
    </style>
</head>
<body>

    <div class="sidebar no-print">
        <div class="sidebar-header">
            <h2>Markdownè½¬PDFç¼–è¾‘å™¨</h2>
        </div>

        <div>
            <div class="section-title">1 / å¯¼å…¥ä¸ç”Ÿæˆ</div>
            <div class="control-group">
                <textarea id="mdInput" placeholder="åœ¨æ­¤ç²˜è´´ä½ çš„ Markdown å†…å®¹..."></textarea>
                <div class="top-actions">
                    <label class="custom-upload-btn">
                        <input type="file" id="fileInput" accept=".md,.txt" />
                        ğŸ“ å¯¼å…¥æœ¬åœ°æ–‡ä»¶
                    </label>
                    <button class="btn-clear" onclick="clearContent()" title="æ¸…ç©ºå†…å®¹">ğŸ—‘ï¸ æ¸…ç©º</button>
                </div>
            </div>
        </div>

        <div>
            <div class="section-title collapse-toggle" onclick="toggleSection('findReplaceContent', 'toggleIconFR')">
                <span>2 / æŸ¥æ‰¾ä¸æ›¿æ¢</span>
                <span id="toggleIconFR" style="font-size: 10px; color: #6b7280;">â–¼</span>
            </div>
            <div class="control-group collapse-content" id="findReplaceContent">
                <input type="text" id="findText" placeholder="æŸ¥æ‰¾å†…å®¹...">
                <input type="text" id="replaceText" placeholder="æ›¿æ¢ä¸º...">
                <div style="display: flex; gap: 6px; margin-top: 2px;">
                    <button class="btn-primary" style="flex:1; padding: 8px; font-size:13px; background:#f3f4f6; color:#374151; box-shadow: none;" onclick="findNext()">æŸ¥æ‰¾</button>
                    <button class="btn-primary" style="flex:1; padding: 8px; font-size:13px; background:#f3f4f6; color:#374151; box-shadow: none;" onclick="replaceCurrent()">æ›¿æ¢</button>
                    <button class="btn-primary" style="flex:1; padding: 8px; font-size:13px; background:#f3f4f6; color:#374151; box-shadow: none;" onclick="replaceAll()">å…¨æ›¿</button>
                </div>
            </div>
        </div>

        <div>
            <div class="section-title">3 / å±€éƒ¨ç¼–è¾‘ (é€‰ä¸­å³ä¾§æ–‡å­—)</div>
            <div class="toolbar">
                <div class="toolbar-group">
                    <button class="toolbar-btn" onclick="execCmd('bold')" title="åŠ ç²—">B</button>
                    <button class="toolbar-btn" onclick="execCmd('italic')" title="æ–œä½“" style="font-style: italic;">I</button>
                    <button class="toolbar-btn" onclick="execCmd('underline')" title="ä¸‹åˆ’çº¿" style="text-decoration: underline;">U</button>
                    <button class="toolbar-btn" onclick="execCmd('strikeThrough')" title="åˆ é™¤çº¿" style="text-decoration: line-through;">S</button>
                </div>
                
                <div class="toolbar-divider"></div>

                <div class="toolbar-group">
                    <button class="toolbar-btn" onclick="execCmd('justifyLeft')" title="å±…å·¦">â†</button>
                    <button class="toolbar-btn" onclick="execCmd('justifyCenter')" title="å±…ä¸­">â†”</button>
                    <button class="toolbar-btn" onclick="execCmd('justifyRight')" title="å±…å³">â†’</button>
                </div>

                <div class="toolbar-divider"></div>

                <div class="toolbar-group">
                    <select class="toolbar-btn" onchange="execCmd('fontSize', this.value); this.selectedIndex=0;" title="å­—å·">
                        <option value="" disabled selected>å­—</option>
                        <option value="1">æå°</option>
                        <option value="2">å°</option>
                        <option value="3">æ­£å¸¸</option>
                        <option value="4">åå¤§</option>
                        <option value="5">å¤§</option>
                        <option value="6">ç‰¹å¤§</option>
                    </select>
                    
                    <div class="split-color-btn" title="å­—ä½“é¢œè‰²">
                        <button class="split-color-main" onclick="applySavedColor('foreColor', 'foreColorPicker')" title="åº”ç”¨å½“å‰é¢œè‰²">
                            <span id="foreColorIndicator" style="color:#ef4444;">A</span>
                        </button>
                        <div class="split-color-drop" title="é€‰æ‹©æ–°é¢œè‰²">
                            <span style="font-size: 8px; color: #9ca3af;">â–¼</span>
                            <input type="color" id="foreColorPicker" value="#ef4444" onchange="updateAndApplyColor('foreColor', 'foreColorPicker', this.value)">
                        </div>
                    </div>

                    <div class="split-color-btn" title="é«˜äº®åº•è‰²">
                        <button class="split-color-main" onclick="applySavedColor('hiliteColor', 'hiliteColorPicker')" title="åº”ç”¨å½“å‰åº•è‰²">
                            <span id="hiliteColorIndicator" style="border-bottom: 3px solid #facc15; line-height: 1.2;">A</span>
                        </button>
                        <div class="split-color-drop" title="é€‰æ‹©æ–°é¢œè‰²">
                            <span style="font-size: 8px; color: #9ca3af;">â–¼</span>
                            <input type="color" id="hiliteColorPicker" value="#fef08a" onchange="updateAndApplyColor('hiliteColor', 'hiliteColorPicker', this.value)">
                        </div>
                    </div>
                </div>

                <button class="btn-aside" onclick="makeAside()" title="å°†é€‰ä¸­çš„æ–‡å­—å˜æˆæç¤ºå—">
                    ğŸ’¡ è®¾ä¸ºæç¤ºå—
                </button>
            </div>
        </div>

        <div>
            <div class="section-title collapse-toggle" onclick="toggleSection('globalContent', 'toggleIconGlobal')">
                <span>4 / å…¨å±€è®¾ç½®</span>
                <span id="toggleIconGlobal" style="font-size: 10px; color: #6b7280;">â–¼</span>
            </div>
            <div class="control-group collapse-content" id="globalContent">
                <div class="slider-row"><span>æ­£æ–‡å­—å·</span><span id="fontSizeVal">16px</span></div>
                <input type="range" id="fontSize" min="12" max="24" value="16">
                
                <div class="slider-row" style="margin-top: 8px;"><span>æ•´ä½“è¡Œè·</span><span id="lineHeightVal">1.8</span></div>
                <input type="range" id="lineHeight" min="1.0" max="3.0" step="0.1" value="1.8">
                
                <div class="section-title" style="margin-top: 16px; color: #d97706; font-size: 13px;">ğŸ’¡ æç¤ºå—æ ·å¼</div>
                <div class="aside-color-settings">
                    <div class="color-control">
                        <span>èƒŒæ™¯è‰²</span>
                        <input type="color" id="asideBgColor" value="#fffbeb">
                    </div>
                    <div class="color-control">
                        <span>è¾¹æ¡†è‰²</span>
                        <input type="color" id="asideBorderColor" value="#f59e0b">
                    </div>
                    <div class="color-control">
                        <span>æ–‡å­—è‰²</span>
                        <input type="color" id="asideTextColor" value="#451a03">
                    </div>
                </div>
            </div>
        </div>
        
        <button class="btn-primary" onclick="exportPDF()" style="margin-top: auto;">å¯¼å‡º PDF æ–‡æ¡£</button>
    </div>

    <div class="preview-container">
        <div class="markdown-body" id="preview" contenteditable="true"></div>
    </div>

    <script>
        const mdInput = document.getElementById('mdInput');
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('preview');
        const root = document.documentElement;

        marked.setOptions({ breaks: true, gfm: true });

        window.addEventListener('DOMContentLoaded', () => {
            const savedData = localStorage.getItem('mdAutoSave');
            if (savedData) {
                mdInput.value = savedData;
            } else {
                mdInput.value = "## å®Œç¾ä½“éªŒè¾¾æˆï¼\n\nç°åœ¨ä½ ç‚¹å‡»é¢œè‰²æŒ‰é’®å·¦ä¾§çš„â€œAâ€ï¼Œå°±å¯ä»¥ç›´æ¥**å¤ç”¨ä¸Šä¸€æ¬¡**çš„é¢œè‰²äº†ï¼\n\nè¯•è¯•é€‰æˆ‘åŠ ä¸ªåº•è‰²å§ï¼";
            }
            loadColors();
            renderMD();
        });

        // --- æ ¸å¿ƒæ›´æ–°ï¼šåˆ†ç¦»å¼æŒ‰é’®çš„é¢œè‰²å¤„ç†é€»è¾‘ ---
        
        // 1. ç‚¹å‡»â€œå°ä¸‰è§’â€é€‰æ‹©æ–°é¢œè‰²æ—¶ï¼ŒåŒæ—¶åº”ç”¨å¹¶æ›´æ–°æ˜¾ç¤ºçŠ¶æ€
        function updateAndApplyColor(cmd, pickerId, value) {
            execCmd(cmd, value);            // ç»™é€‰ä¸­çš„æ–‡å­—ä¸Šè‰²
            saveColor(pickerId, value);     // ä¿å­˜åˆ°æœ¬åœ°è®°å¿†

            // å®æ—¶æ›´æ–°æŒ‰é’® A å­—æ¯çš„åº•éƒ¨é¢œè‰²ï¼Œè®©ä½ çŸ¥é“â€œå½“å‰å­˜çš„æ˜¯ä»€ä¹ˆé¢œè‰²â€
            if (cmd === 'foreColor') {
                document.getElementById('foreColorIndicator').style.color = value;
            } else if (cmd === 'hiliteColor') {
                document.getElementById('hiliteColorIndicator').style.borderBottomColor = value;
            }
        }

        // 2. ç‚¹å‡»â€œAå­—æ¯â€æ—¶ï¼Œç›´æ¥è¯»å–å¹¶åº”ç”¨ä¿å­˜çš„é¢œè‰²ï¼Œä¸éœ€è¦æ‰“å¼€è°ƒè‰²æ¿
        function applySavedColor(cmd, pickerId) {
            const savedValue = document.getElementById(pickerId).value;
            execCmd(cmd, savedValue);
        }

        function saveColor(id, value) {
            localStorage.setItem(id, value);
        }

        function loadColors() {
            const colorInputs = ['foreColorPicker', 'hiliteColorPicker', 'asideBgColor', 'asideBorderColor', 'asideTextColor'];
            colorInputs.forEach(id => {
                const saved = localStorage.getItem(id);
                if (saved) {
                    const el = document.getElementById(id);
                    if(el) el.value = saved;
                    
                    if(id === 'asideBgColor') root.style.setProperty('--aside-bg', saved);
                    if(id === 'asideBorderColor') root.style.setProperty('--aside-border', saved);
                    if(id === 'asideTextColor') root.style.setProperty('--aside-text', saved);
                    
                    // æ¢å¤æ—¶ä¹Ÿè¦åŒæ­¥æ›´æ–° A å­—æ¯çš„æ˜¾ç¤ºé¢œè‰²
                    if(id === 'foreColorPicker') document.getElementById('foreColorIndicator').style.color = saved;
                    if(id === 'hiliteColorPicker') document.getElementById('hiliteColorIndicator').style.borderBottomColor = saved;
                }
            });
        }

        function renderMD() {
            let rawText = mdInput.value;
            localStorage.setItem('mdAutoSave', rawText);

            if (rawText.trim() === '') {
                preview.innerHTML = '<p style="color:#9ca3af; text-align:center; margin-top:100px; font-weight:300;">æš‚æ— å†…å®¹ï¼Œè¯·åœ¨å·¦ä¾§è¾“å…¥ Markdown</p>';
                return;
            }

            rawText = rawText.replace(/<aside>([\s\S]*?)<\/aside>/gi, function(match, content) {
                return '<aside>' + marked.parseInline(content) + '</aside>';
            });

            preview.innerHTML = marked.parse(rawText);
            makeTablesResizable();
        }

        mdInput.addEventListener('input', renderMD);

        function makeTablesResizable() {
            const tables = preview.querySelectorAll('table');
            tables.forEach(table => {
                const ths = table.querySelectorAll('th');
                ths.forEach(th => {
                    const resizer = document.createElement('div');
                    resizer.style.width = '8px'; resizer.style.background = 'transparent';
                    resizer.style.position = 'absolute'; resizer.style.right = '0'; resizer.style.top = '0'; resizer.style.bottom = '0';
                    resizer.style.cursor = 'col-resize'; resizer.style.userSelect = 'none';
                    
                    resizer.addEventListener('mouseenter', () => resizer.style.background = 'rgba(7, 193, 96, 0.4)');
                    resizer.addEventListener('mouseleave', () => resizer.style.background = 'transparent');
                    th.appendChild(resizer);

                    let startX, startWidth;
                    resizer.addEventListener('mousedown', function(e) {
                        startX = e.clientX; startWidth = th.offsetWidth;
                        const onMouseMove = (e) => {
                            const newWidth = startWidth + (e.clientX - startX);
                            th.style.width = newWidth + 'px'; th.style.minWidth = newWidth + 'px'; 
                        };
                        const onMouseUp = () => {
                            document.removeEventListener('mousemove', onMouseMove);
                            document.removeEventListener('mouseup', onMouseUp);
                        };
                        document.addEventListener('mousemove', onMouseMove); document.addEventListener('mouseup', onMouseUp);
                    });
                });
            });
        }

        function clearContent() {
            if(confirm("ç¡®å®šè¦æ¸…ç©ºå…¨éƒ¨å†…å®¹å—ï¼Ÿæ— æ³•æ’¤é”€å“¦ã€‚")) {
                mdInput.value = ''; localStorage.removeItem('mdAutoSave'); renderMD();
            }
        }

        fileInput.addEventListener('click', function() { this.value = null; });
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { mdInput.value = e.target.result; renderMD(); };
            reader.readAsText(file);
        });

        function toggleSection(contentId, iconId) {
            const content = document.getElementById(contentId);
            const icon = document.getElementById(iconId);
            if (content.style.display === 'flex') {
                content.style.display = 'none'; icon.innerText = 'â–¼';
            } else {
                content.style.display = 'flex'; icon.innerText = 'â–²';
            }
        }

        function execCmd(command, value = null) {
            preview.focus(); document.execCommand(command, false, value);
        }

        function makeAside() {
            preview.focus(); const selection = window.getSelection();
            if (!selection.rangeCount || selection.isCollapsed) { alert("è¯·å…ˆåœ¨å³ä¾§é¢„è§ˆåŒºé€‰ä¸­ä¸€æ®µæ–‡å­—ï¼"); return; }
            const range = selection.getRangeAt(0); const div = document.createElement('div');
            div.appendChild(range.cloneContents()); const html = div.innerHTML;
            document.execCommand('insertHTML', false, `<aside>${html}</aside><br>`);
        }

        function findNext() {
            const text = document.getElementById('findText').value;
            if (!text) return; preview.focus();
            const found = window.find(text, false, false, true);
            if (!found) alert('å·²æŸ¥æ‰¾åˆ°æ–‡æ¡£æœ«å°¾ã€‚');
        }

        function replaceCurrent() {
            const replaceStr = document.getElementById('replaceText').value;
            const selection = window.getSelection();
            if (!selection.isCollapsed) { document.execCommand('insertText', false, replaceStr); } else { findNext(); }
        }

        function replaceAll() {
            const findStr = document.getElementById('findText').value;
            const replaceStr = document.getElementById('replaceText').value;
            if (!findStr) return; preview.focus();
            const selection = window.getSelection(); selection.collapse(preview, 0);
            let count = 0;
            while (window.find(findStr, false, false, false)) { document.execCommand('insertText', false, replaceStr); count++; }
            if(count > 0) alert(`âœ… å…±æ›¿æ¢äº† ${count} å¤„ã€‚`); else alert('æœªæ‰¾åˆ°éœ€è¦æ›¿æ¢çš„å†…å®¹ã€‚');
        }

        document.getElementById('fontSize').addEventListener('input', function(e) {
            root.style.setProperty('--font-size', e.target.value + 'px'); document.getElementById('fontSizeVal').innerText = e.target.value + 'px';
        });
        document.getElementById('lineHeight').addEventListener('input', function(e) {
            root.style.setProperty('--line-height', e.target.value); document.getElementById('lineHeightVal').innerText = e.target.value;
        });

        document.getElementById('asideBgColor').addEventListener('input', function(e) {
            root.style.setProperty('--aside-bg', e.target.value); saveColor('asideBgColor', e.target.value);
        });
        document.getElementById('asideBorderColor').addEventListener('input', function(e) {
            root.style.setProperty('--aside-border', e.target.value); saveColor('asideBorderColor', e.target.value);
        });
        document.getElementById('asideTextColor').addEventListener('input', function(e) {
            root.style.setProperty('--aside-text', e.target.value); saveColor('asideTextColor', e.target.value);
        });

        function exportPDF() {
            const rawText = mdInput.value.trim(); let fileName = "Markdown_Export"; 
            if (rawText) {
                let firstLine = rawText.split('\n')[0]; firstLine = firstLine.replace(/^#+\s*/, '').trim(); firstLine = firstLine.substring(0, 15);
                const now = new Date(); const year = now.getFullYear(); const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0'); const hour = String(now.getHours()).padStart(2, '0');
                const minute = String(now.getMinutes()).padStart(2, '0'); const timestamp = `${year}${month}${day}_${hour}${minute}`;
                if (firstLine) { fileName = `${firstLine}_${timestamp}`; } else { fileName = `Document_${timestamp}`; }
            }
            const originalTitle = document.title; document.title = fileName; window.print();
            setTimeout(() => { document.title = originalTitle; }, 1000);
        }
    </script>
</body>
</html>