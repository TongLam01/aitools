<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI çµæ„Ÿæ’ç‰ˆå¤§å¸ˆ v16.0 - å®Œç¾åƒç´ ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #3b82f6; } /* é»˜è®¤æ”¹ä¸ºæ›´é€šç”¨çš„å¾®ä¿¡è“ */
        body { background-color: #f3f4f6; }
        
        #preview-container { 
            background: #fff; min-height: 600px; border-radius: 8px; /* æ”¹ä¸ºæ–¹å½¢åœ†è§’ï¼Œæ›´åƒç¼–è¾‘å™¨ */
            padding: 0; border: 1px solid #e5e7eb; max-width: 375px; margin: 0 auto 180px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden;
        }
        #preview-content {
            background: white; height: 100%; min-height: 600px;
            overflow-y: auto; padding: 20px 16px; outline: none;
        }

        /* äº¤äº’é€‰æ¡† */
        .block-wrapper {
            position: relative; margin-bottom: 0; cursor: pointer;
            transition: all 0.2s; border: 1px dashed transparent;
            padding: 2px; /* ç»™é€‰æ¡†ä¸€ç‚¹å‘¼å¸ç©ºé—´ */
        }
        .block-wrapper:hover { border-color: #cbd5e1; }
        .block-wrapper.selected { 
            border-color: #3b82f6 !important; 
            background-color: rgba(59, 130, 246, 0.05);
        }
        /* é€‰ä¸­æ ‡è®° */
        .block-wrapper.selected::after {
            content: ''; position: absolute; top: 0; right: 0;
            width: 0; height: 0; 
            border-style: solid; border-width: 0 10px 10px 0; 
            border-color: transparent #3b82f6 transparent transparent;
        }

        .bottom-workbench {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.98); border-top: 1px solid #e5e7eb;
            z-index: 999; padding: 12px 16px calc(12px + env(safe-area-inset-bottom));
            box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.05);
        }
        .style-btn { 
            padding: 6px 12px; background: white; border: 1px solid #e2e8f0; 
            border-radius: 6px; font-size: 12px; font-weight: 600; color: #475569;
            white-space: nowrap; cursor: pointer; transition: 0.1s;
        }
        .style-btn:hover { background: #f8fafc; border-color: #cbd5e1; color: #1e293b; }
        .style-btn:active { background: #f1f5f9; transform: translateY(1px); }
        .color-dot { width: 22px; height: 22px; border-radius: 4px; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="pb-48 text-slate-800">

    <div class="max-w-7xl mx-auto py-6 px-4">
        <header class="mb-6 flex justify-between items-center">
            <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                <span>ğŸ¨</span> AI æ’ç‰ˆå¤§å¸ˆ <span class="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded-full">v16.0 Pro</span>
            </h1>
            <div class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded-lg border hover:shadow-sm transition" onclick="toggleSettings()">
                <span class="text-xs font-medium text-slate-600">ğŸ”‘ API è®¾ç½®</span>
            </div>
        </header>

        <div id="settings-panel" class="hidden fixed inset-0 bg-slate-900/20 backdrop-blur-sm z-[2000] flex items-center justify-center p-4">
            <div class="bg-white p-6 rounded-xl w-full max-w-sm shadow-2xl border border-slate-100">
                <h3 class="font-bold text-base mb-1">DeepSeek API Key</h3>
                <p class="text-xs text-slate-400 mb-4">Key ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼Œå®‰å…¨æ— å¿§ã€‚</p>
                <input type="password" id="api-key" oninput="saveConfig()" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg outline-none text-sm focus:border-blue-500 transition mb-4" placeholder="sk-...">
                <button onclick="toggleSettings()" class="w-full py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold text-sm transition">ä¿å­˜</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-140px)]">
            <div class="lg:col-span-7 h-full">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 h-full flex flex-col">
                    <textarea id="user-input" class="w-full flex-1 p-2 bg-transparent outline-none resize-none text-base leading-relaxed text-slate-700 placeholder:text-slate-300" placeholder="åœ¨æ­¤ç²˜è´´æ–‡ç« å†…å®¹...&#10;&#10;AI å°†è‡ªåŠ¨è¯†åˆ«æ®µè½ã€æ ‡é¢˜å’Œåˆ—è¡¨ã€‚"></textarea>
                    <div class="pt-4 border-t border-slate-100 flex gap-3">
                        <button onclick="generateArticle()" id="btn-run" class="flex-1 py-3 bg-slate-900 hover:bg-slate-800 text-white rounded-lg font-bold text-sm shadow-md transition-all flex justify-center items-center gap-2">
                            <span>âœ¨</span> ä¸€é”®æ™ºèƒ½æ’ç‰ˆ
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-5 h-full flex flex-col">
                <div class="flex justify-between items-center px-1 mb-2">
                    <span class="text-xs font-bold text-slate-400">å®æ—¶é¢„è§ˆ (WeChat)</span>
                    <button onclick="copyHtml()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-1.5 rounded-md font-bold text-xs shadow-sm transition flex items-center gap-1">
                        ğŸ“‹ å¤åˆ¶åˆ°å…¬ä¼—å·
                    </button>
                </div>
                <div id="preview-container" class="w-full flex-1">
                    <div id="preview-content" contenteditable="true">
                        <div style="padding-top: 40%; text-align: center; color: #cbd5e1; font-size: 14px;">
                            <p>ç­‰å¾…æ’ç‰ˆ...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-workbench">
        <div class="max-w-7xl mx-auto space-y-3">
            <div class="flex items-center gap-3">
                <span class="text-xs font-bold text-slate-400 w-10">ä¸»é¢˜è‰²</span>
                <div class="flex gap-2" id="color-palette"></div>
                <div class="w-[1px] h-4 bg-slate-200"></div>
                <input type="color" id="custom-color" oninput="updateColor(this.value)" class="w-6 h-6 rounded cursor-pointer border-0 bg-transparent p-0">
            </div>

            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                <button onclick="applyVariant('normal')" class="style-btn text-red-500 border-red-100 bg-red-50">è¿˜åŸ</button>
                <div class="w-[1px] h-6 bg-slate-200 mx-1 self-center"></div>
                <button onclick="applyVariant('big_title')" class="style-btn">å¤§æ ‡é¢˜</button>
                <button onclick="applyVariant('sub_title')" class="style-btn">å°æ ‡é¢˜</button>
                <button onclick="applyVariant('num_title')" class="style-btn text-blue-600">åºå·æ ‡</button>
                <button onclick="applyVariant('grad_title')" class="style-btn">æ¸å˜æ ‡</button>
                <button onclick="applyVariant('key_point')" class="style-btn">é‡ç‚¹å¡</button>
                <button onclick="applyVariant('quote')" class="style-btn">å¼•ç”¨</button>
                <button onclick="applyVariant('bg_card')" class="style-btn">åº•è‰²å¡</button>
                <div class="w-[1px] h-6 bg-slate-200 mx-1 self-center"></div>
                <button onclick="mergeSelected()" class="style-btn bg-slate-800 text-white border-slate-800">åˆå¹¶</button>
            </div>
        </div>
    </div>

    <script>
        let currentColor = '#3b82f6'; // å¾®ä¿¡è“
        let recentColors = ['#3b82f6', '#07c160', '#ff6b6b', '#f59e0b', '#8b5cf6'];
        
        // ==========================================
        // æ ¸å¿ƒæ¨¡æ¿åº“ (CSS Reset + Inline Block)
        // é‡ç‚¹ï¼špadding:0, margin:0, box-sizing:border-box
        // ==========================================
        
        // è¾…åŠ©ï¼šæ™ºèƒ½åˆ†ç¦»åºå·å’Œæ ‡é¢˜ "1. å¸‚åœºè°ƒç ”" -> {num: "1", text: "å¸‚åœºè°ƒç ”"}
        function parseNumTitle(text) {
            const match = text.match(/^(\d+)[.ã€\s]\s*(.*)$/);
            if (match) return { num: match[1], text: match[2] };
            // å°è¯•åŒ¹é…ä¸­æ–‡åºå· "ä¸€ã€å¸‚åœº"
            const matchCN = text.match(/^([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)[.ã€\s]\s*(.*)$/);
            if (matchCN) return { num: matchCN[1], text: matchCN[2] };
            return { num: 'â€¢', text: text }; // é»˜è®¤ç‚¹å·
        }

        const VARIANTS = {
            big_title: [
                (t, c) => `<section style="text-align: center; margin: 25px 0 15px; line-height: 1.4;"><span style="display: block; font-size: 20px; color: ${c}; margin-bottom: 4px;">âœ¦</span><strong style="font-size: 22px; color: #333; border-bottom: 2px solid ${c}; padding-bottom: 8px; display: inline-block;">${t}</strong></section>`,
                (t, c) => `<section style="text-align: center; margin: 25px 0 15px; line-height: 1.4;"><strong style="font-size: 18px; color: #fff; background: ${c}; padding: 8px 24px; border-radius: 4px; display: inline-block; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">${t}</strong></section>`
            ],
            sub_title: [
                (t, c) => `<section style="margin: 20px 0 10px; line-height: 1.4;"><span style="display: inline-block; width: 4px; height: 18px; background: ${c}; vertical-align: middle; margin-right: 8px; border-radius: 2px;"></span><strong style="font-size: 18px; color: #333; vertical-align: middle;">${t}</strong></section>`,
                (t, c) => `<section style="margin: 20px 0 10px; border-bottom: 1px solid #eee; padding-bottom: 8px; line-height: 1.4;"><span style="color: ${c}; font-weight: bold; font-size: 18px; margin-right: 6px;">#</span><strong style="font-size: 18px; color: #333;">${t}</strong></section>`
            ],
            num_title: [
                // æ–¹æ¡ˆAï¼šåœ†åœˆæ•°å­—+æ–‡å­—ï¼ˆInline-Block å®Œç¾å¯¹é½ç‰ˆï¼‰
                (t, c) => {
                    const { num, text } = parseNumTitle(t);
                    return `<section style="margin: 20px 0 10px; line-height: 1.5;"><span style="display: inline-block; width: 22px; height: 22px; background: ${c}; color: #fff; text-align: center; line-height: 22px; border-radius: 50%; font-size: 13px; font-weight: bold; vertical-align: middle; margin-right: 8px;">${num}</span><strong style="font-size: 17px; color: #333; vertical-align: middle;">${text}</strong></section>`;
                },
                // æ–¹æ¡ˆBï¼šå¤§æ•°å­—+æ–‡å­—
                (t, c) => {
                    const { num, text } = parseNumTitle(t);
                    return `<section style="margin: 20px 0 10px; line-height: 1.4; border-bottom: 2px solid ${c}; padding-bottom: 8px;"><span style="font-size: 24px; font-weight: 900; color: ${c}20; vertical-align: bottom; margin-right: 4px; font-family: Arial;">${num}</span><strong style="font-size: 18px; color: #333; vertical-align: bottom;">${text}</strong></section>`;
                }
            ],
            grad_title: [
                (t, c) => `<section style="margin: 20px 0 10px;"><span style="display: inline-block; background: linear-gradient(90deg, ${c}, #fff); color: #fff; padding: 4px 12px; font-size: 16px; font-weight: bold; border-radius: 4px;">${t}</span></section>`,
            ],
            key_point: [
                (t, c) => `<section style="margin: 15px 0; padding: 15px; background: ${c}0C; border: 1px solid ${c}40; border-radius: 6px; font-size: 15px; color: #333; line-height: 1.6;">${format(t)}</section>`,
                (t, c) => `<section style="margin: 15px 0; padding: 15px; border-left: 4px solid ${c}; background: #f9fafb; font-size: 15px; color: #333; line-height: 1.6;">${format(t)}</section>`
            ],
            quote: [
                (t, c) => `<section style="margin: 15px 0; padding: 12px 16px; background: #f8f8f8; color: #64748b; border-radius: 4px; font-size: 14px; line-height: 1.6; border-left: 3px solid #cbd5e1;">${format(t)}</section>`
            ],
            bg_card: [
                (t, c) => `<section style="margin: 15px 0; padding: 16px; background: ${c}15; border-radius: 8px; color: #333; line-height: 1.6;">${format(t)}</section>`
            ],
            normal: [
                // æç®€æ­£æ–‡ï¼šmargin-bottom: 0, line-height: 1.75
                (t, c) => `<section style="margin-bottom: 12px; line-height: 1.75; font-size: 16px; color: #333; text-align: justify;">${format(t)}</section>`
            ]
        };

        // æ–‡æœ¬æ ¼å¼åŒ–ï¼šå»é™¤æ‰€æœ‰ marginï¼Œä½¿ç”¨ <br> æˆ–æå° margin
        function format(t) { 
            return t.split('\n').filter(l=>l.trim()).map(l=>`<p style="margin: 0 0 6px 0; padding: 0;">${l}</p>`).join(''); 
        }

        // ==========================================
        // é€»è¾‘æ§åˆ¶
        // ==========================================
        window.onload = () => {
            if(localStorage.getItem('ds_key')) document.getElementById('api-key').value = localStorage.getItem('ds_key');
            renderColors();
        };

        function toggleSettings() { document.getElementById('settings-panel').classList.toggle('hidden'); }
        function saveConfig() { localStorage.setItem('ds_key', document.getElementById('api-key').value); }

        function renderColors() {
            const el = document.getElementById('color-palette');
            el.innerHTML = '';
            recentColors.forEach(c => {
                const dot = document.createElement('div');
                dot.className = 'color-dot'; dot.style.background = c;
                dot.onclick = () => updateColor(c);
                el.appendChild(dot);
            });
        }

        function updateColor(c) {
            currentColor = c;
            document.getElementById('custom-color').value = c;
            document.querySelectorAll('.block-wrapper.selected').forEach(el => applyVariant(el.dataset.type, true));
        }

        function renderArticle(blocks) {
            const container = document.getElementById('preview-content');
            container.innerHTML = ''; // æ¸…ç©º
            // å¤–å±‚åŒ…è£¹ä¸€ä¸ªå‡€åŒ– divï¼Œé˜²æ­¢å¾®ä¿¡æ ·å¼æ±¡æŸ“
            const root = document.createElement('div');
            root.style.fontSize = "16px";
            root.style.lineHeight = "1.6";
            root.style.color = "#333";
            
            blocks.forEach(b => {
                const wrapper = document.createElement('div');
                wrapper.className = 'block-wrapper';
                wrapper.dataset.type = b.type;
                wrapper.dataset.variant = 0;
                wrapper.dataset.raw = b.content;
                const renderer = VARIANTS[b.type] ? VARIANTS[b.type][0] : VARIANTS.normal[0];
                wrapper.innerHTML = renderer(b.content, currentColor);
                root.appendChild(wrapper);
            });
            container.appendChild(root);
        }

        async function generateArticle() {
            const key = document.getElementById('api-key').value;
            const text = document.getElementById('user-input').value;
            if(!key || !text) return alert('è¯·å…ˆè®¾ç½® Key å¹¶è¾“å…¥æ–‡ç« ');
            
            const btn = document.getElementById('btn-run');
            btn.disabled = true; btn.innerHTML = "â³ æ­£åœ¨æ’ç‰ˆ...";

            try {
                // æ¸…æ´—æ–‡æœ¬ï¼šå»é™¤å¤šä½™ç©ºè¡Œ
                const cleanText = text.replace(/\n\s*\n/g, '\n').trim();
                
                const res = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            {role: "system", content: "ä½ æ˜¯ä¸€ä¸ªæ’ç‰ˆè¾…åŠ©å·¥å…·ã€‚å°†è¾“å…¥æ–‡æœ¬æŒ‰é€»è¾‘æ®µè½æ‹†åˆ†ã€‚å¦‚æœæŸæ®µæ–‡æœ¬çœ‹èµ·æ¥åƒæ ‡é¢˜ï¼ˆçŸ­å°ç²¾æ‚ï¼‰ï¼Œæ ‡è®°ä¸º big_title, sub_title æˆ– num_titleã€‚å¦‚æœæ˜¯é‡ç‚¹å†…å®¹æ ‡è®°ä¸º key_pointã€‚è¿”å›JSONæ•°ç»„[{type, content}]ã€‚ä¸¥ç¦æ”¹åŠ¨åŸæ–‡ã€‚"},
                            {role: "user", content: cleanText}
                        ],
                        temperature: 0.1
                    })
                });
                
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                const jsonStr = data.choices[0].message.content.match(/\[[\s\S]*\]/);
                if(!jsonStr) throw new Error("AI è¿”å›æ ¼å¼æœ‰è¯¯ï¼Œè¯·é‡è¯•");
                
                renderArticle(JSON.parse(jsonStr[0]));
                
            } catch(e) { alert("é”™è¯¯ï¼š" + e.message); }
            finally { btn.disabled = false; btn.innerHTML = "âœ¨ ä¸€é”®æ™ºèƒ½æ’ç‰ˆ"; }
        }

        // äº¤äº’
        document.getElementById('preview-content').addEventListener('click', e => {
            const w = e.target.closest('.block-wrapper');
            if(w) w.classList.toggle('selected');
        });

        function applyVariant(type, keepVariant = false) {
            const selected = document.querySelectorAll('.block-wrapper.selected');
            if(selected.length === 0 && !keepVariant) return alert("è¯·å…ˆç‚¹å‡»é¢„è§ˆåŒºé€‰æ‹©æ®µè½");
            
            selected.forEach(el => {
                const raw = el.dataset.raw;
                const oldType = el.dataset.type;
                let vIdx = parseInt(el.dataset.variant);
                if(!keepVariant) vIdx = (oldType === type) ? (vIdx + 1) % VARIANTS[type].length : 0;

                const renderer = VARIANTS[type][vIdx];
                el.innerHTML = renderer(raw, currentColor);
                el.dataset.type = type;
                el.dataset.variant = vIdx;
            });
        }

        function mergeSelected() {
            const selected = Array.from(document.querySelectorAll('.block-wrapper.selected'))
                .sort((a,b) => a.offsetTop - b.offsetTop);
            if(selected.length < 2) return alert("è¯·è‡³å°‘é€‰ä¸­ä¸¤å—");
            
            const mergedText = selected.map(el => el.dataset.raw).join('\n');
            const wrapper = document.createElement('div');
            wrapper.className = 'block-wrapper selected';
            wrapper.dataset.type = 'normal';
            wrapper.dataset.variant = 0;
            wrapper.dataset.raw = mergedText;
            wrapper.innerHTML = VARIANTS.normal[0](mergedText, currentColor);
            
            selected[0].replaceWith(wrapper);
            selected.slice(1).forEach(el => el.remove());
        }

        async function copyHtml() {
            const clone = document.getElementById('preview-content').cloneNode(true);
            // æ¸…ç†äº¤äº’å±‚
            clone.querySelectorAll('.block-wrapper').forEach(el => {
                el.classList.remove('selected', 'block-wrapper');
                // ä»…ä¿ç•™ style
                while(el.attributes.length > 0) {
                   if(el.attributes[0].name !== 'style') el.removeAttribute(el.attributes[0].name);
                   else break; // ç®€å•å¤„ç†ï¼Œå®é™…åº”éå†åˆ é™¤é style
                }
            });
            // é¢å¤–æ¸…ç†ï¼šå»é™¤æ‰€æœ‰ data å±æ€§ (å…¼å®¹æ€§å¤„ç†)
            const html = clone.innerHTML.replace(/data-[a-z]+="[^"]*"/g, '').replace(/class=""/g, '');
            
            const blob = new Blob([html], {type: 'text/html'});
            await navigator.clipboard.write([new ClipboardItem({'text/html': blob})]);
            alert("âœ… å·²å¤åˆ¶ï¼é—´è·å’Œæ ¼å¼å·²ä¼˜åŒ–ï¼Œè¯·ç²˜è´´æµ‹è¯•ã€‚");
        }
    </script>
</body>
</html>
