<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI çµæ„Ÿæ’ç‰ˆå¤§å¸ˆ v25.0 - å†…ç¼©å¼é›¶è¾¹è·ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #3b82f6; }
        body { background-color: #f8fafc; color: #334155; height: 100vh; overflow: hidden; }
        
        #preview-container { 
            background: #fff; height: 100%; border-radius: 4px;
            padding: 0; border: 1px solid #cbd5e1; max-width: 375px; margin: 0 auto;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden;
        }
        #preview-content {
            background: white; height: 100%;
            overflow-y: auto; padding: 30px 20px; outline: none;
        }

        /* äº¤äº’é€‰æ¡† */
        .block-wrapper {
            position: relative; margin-bottom: 0; cursor: pointer;
            transition: all 0.1s; border: 1px solid transparent; padding: 2px;
        }
        .block-wrapper:hover { border-color: #94a3b8; border-style: dashed; z-index: 10; }
        .block-wrapper.selected { 
            border: 2px solid #3b82f6 !important; 
            background-color: rgba(59, 130, 246, 0.05);
            z-index: 20;
        }
        .block-wrapper.selected::after {
            content: 'âœ“'; position: absolute; top: 0; right: 0;
            background: #3b82f6; color: white; font-size: 10px; width: 16px; height: 16px;
            display: flex; align-items: center; justify-content: center;
            border-bottom-left-radius: 4px; pointer-events: none;
        }

        .bottom-workbench {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.98); border-top: 1px solid #e2e8f0;
            z-index: 999; padding: 10px 16px calc(10px + env(safe-area-inset-bottom));
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
        }
        .style-btn { 
            padding: 6px 10px; background: white; border: 1px solid #cbd5e1; 
            border-radius: 6px; font-size: 12px; font-weight: 600; color: #475569;
            white-space: nowrap; cursor: pointer; transition: 0.1s;
        }
        .style-btn:hover { background: #f8fafc; border-color: #64748b; color: #0f172a; }
        .style-btn:active { background: #e2e8f0; transform: translateY(1px); }
        
        .color-dot { width: 20px; height: 20px; border-radius: 4px; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div class="max-w-7xl mx-auto w-full py-4 px-4 flex-shrink-0">
        <header class="flex justify-between items-center mb-4">
            <h1 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <span>ğŸ¨</span> AI æ’ç‰ˆå¤§å¸ˆ <span class="bg-blue-100 text-blue-700 text-[10px] px-2 py-0.5 rounded border border-blue-200">v25.0 ZeroMargin</span>
            </h1>
            <div class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded border border-slate-200 hover:border-blue-400 transition" onclick="toggleSettings()">
                <span class="text-xs font-medium text-slate-600">ğŸ”‘ API è®¾ç½®</span>
            </div>
        </header>
    </div>

    <div id="settings-panel" class="hidden fixed inset-0 bg-slate-900/20 backdrop-blur-[2px] z-[2000] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg w-full max-w-sm shadow-2xl border border-slate-100">
            <h3 class="font-bold text-sm mb-4 text-slate-800">DeepSeek API Key</h3>
            <input type="password" id="api-key" oninput="saveConfig()" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded text-sm outline-none focus:border-blue-500 mb-4" placeholder="sk-...">
            <button onclick="toggleSettings()" class="w-full py-2.5 bg-slate-900 hover:bg-slate-800 text-white rounded font-medium text-sm">ç¡®è®¤ä¿å­˜</button>
        </div>
    </div>

    <div class="flex-1 overflow-hidden max-w-7xl mx-auto w-full px-4 pb-32">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
            <div class="lg:col-span-7 h-full flex flex-col">
                <div class="bg-white p-2 rounded-lg shadow-sm border border-slate-200 flex-1 flex flex-col overflow-hidden">
                    <textarea id="user-input" class="w-full flex-1 p-3 bg-transparent outline-none resize-none text-base leading-relaxed text-slate-700 placeholder:text-slate-300 font-mono overflow-y-auto" placeholder="è¯·ç²˜è´´æ–‡ç« ...&#10;&#10;v25.0 ç»ˆæä¿®å¤ï¼š&#10;1. å¼ºåˆ¶æ‰€æœ‰ Margin ä¸º 0&#10;2. ä½¿ç”¨ Padding æ’‘å¼€é—´è·ï¼ˆå¾®ä¿¡æ— æ³•æŠ˜å  Paddingï¼‰&#10;3. å®Œç¾ä¿ç•™é¢œè‰²å’Œå¡ç‰‡æ ·å¼"></textarea>
                    <div class="p-2 border-t border-slate-100 bg-white flex-shrink-0 z-10">
                        <button onclick="generateArticle()" id="btn-run" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded font-bold text-sm shadow-sm transition flex justify-center items-center gap-2">
                            <span>ğŸš€</span> ä¸€é”®æ™ºèƒ½æ’ç‰ˆ
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-5 h-full flex flex-col items-center overflow-hidden">
                <div class="w-full flex justify-between items-center px-1 mb-2 max-w-[375px] flex-shrink-0">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">WECHAT PREVIEW</span>
                    <button onclick="copyHtml()" class="bg-green-600 hover:bg-green-700 text-white px-5 py-1.5 rounded font-bold text-xs shadow-sm transition">
                        å¤åˆ¶åˆ°å…¬ä¼—å·
                    </button>
                </div>
                <div id="preview-container" class="w-full flex-1">
                    <div id="preview-content" contenteditable="true">
                        <div style="padding-top: 50%; text-align: center; color: #cbd5e1; font-size: 13px;">ç­‰å¾…ç”Ÿæˆ...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-workbench">
        <div class="max-w-7xl mx-auto space-y-3">
            <div class="flex items-center gap-3">
                <span class="text-[10px] font-bold text-slate-400 uppercase w-8">Color</span>
                <div class="flex gap-1.5" id="color-palette"></div>
                <input type="color" id="custom-color" oninput="updateColor(this.value)" class="w-5 h-5 rounded cursor-pointer border-0 bg-transparent p-0">
            </div>

            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                <button onclick="applyVariant('normal')" class="style-btn text-red-500 bg-red-50 border-red-100">è¿˜åŸ</button>
                <div class="w-[1px] h-4 bg-slate-300 mx-1 self-center"></div>
                <button onclick="applyVariant('big_title')" class="style-btn">å¤§æ ‡é¢˜</button>
                <button onclick="applyVariant('sub_title')" class="style-btn">å°æ ‡é¢˜</button>
                <button onclick="applyVariant('num_title')" class="style-btn text-blue-600">åºå·æ ‡</button>
                <button onclick="applyVariant('grad_title')" class="style-btn">æ¸å˜æ ‡</button>
                <button onclick="applyVariant('key_point')" class="style-btn">é‡ç‚¹å¡</button>
                <button onclick="applyVariant('quote')" class="style-btn">å¼•ç”¨</button>
                <button onclick="applyVariant('bg_card')" class="style-btn">åº•è‰²å¡</button>
                <button onclick="applyVariant('code_block')" class="style-btn">ä»£ç </button>
                <div class="w-[1px] h-4 bg-slate-300 mx-1 self-center"></div>
                <button onclick="mergeSelected()" class="style-btn bg-slate-800 text-white border-slate-800">åˆå¹¶</button>
            </div>
        </div>
    </div>

    <script>
        let currentColor = '#3b82f6';
        let recentColors = ['#3b82f6', '#07c160', '#f59e0b', '#ef4444', '#8b5cf6'];
        
        function hexToRgba(hex, alpha) {
            let r = 0, g = 0, b = 0;
            if (hex.length === 4) {
                r = parseInt(hex[1] + hex[1], 16);
                g = parseInt(hex[2] + hex[2], 16);
                b = parseInt(hex[3] + hex[3], 16);
            } else if (hex.length === 7) {
                r = parseInt(hex.slice(1, 3), 16);
                g = parseInt(hex.slice(3, 5), 16);
                b = parseInt(hex.slice(5, 7), 16);
            }
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function parseNumTitle(text) {
            const match = text.match(/^(\d+|[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)[.ã€\s]\s*(.*)$/);
            if (match) return { num: match[1], text: match[2] };
            return { num: '', text: text };
        }

        // ==========================================
        // æ ¸å¿ƒæ¨¡æ¿åº“ v25.0 (Padding-Only Strategy)
        // æ ¸å¿ƒåŸåˆ™ï¼šMargin æ°¸è¿œä¸º 0ï¼Œé—´è·å…¨é  Padding
        // ==========================================
        const VARIANTS = {
            big_title: [
                // æ ‡é¢˜ä¸Šæ–¹ï¼špadding-top: 30px (ä¸æŠ˜å )
                // æ ‡é¢˜ä¸‹æ–¹ï¼špadding-bottom: 10px
                (t, c) => `<section style="margin: 0; padding: 30px 0 10px 0; text-align: center; line-height: 1.4;"><span style="display: block; font-size: 20px; color: ${c}; line-height: 1; margin-bottom: 5px;">âœ¦</span><strong style="font-size: 20px; color: #1f2937; border-bottom: 3px solid ${c}; padding: 0 10px 5px; display: inline-block;">${t}</strong></section>`,
                (t, c) => `<section style="margin: 0; padding: 30px 0 10px 0; text-align: center;"><strong style="font-size: 18px; color: #fff; background-color: ${c}; padding: 8px 20px; border-radius: 4px; display: inline-block;">${t}</strong></section>`,
                (t, c) => `<section style="margin: 0; padding: 30px 0 10px 0; text-align: center;"><strong style="font-size: 19px; color: ${c}; border: 2px solid ${c}; padding: 6px 20px; border-radius: 50px; display: inline-block;">${t}</strong></section>`
            ],
            sub_title: [
                (t, c) => `<section style="margin: 0; padding: 25px 0 10px 0; display: flex; align-items: center;"><span style="display: inline-block; width: 4px; height: 18px; background-color: ${c}; margin-right: 8px; border-radius: 2px;"></span><strong style="font-size: 17px; color: #1f2937;">${t}</strong></section>`,
                (t, c) => `<section style="margin: 0; padding: 25px 0 10px 0; border-bottom: 1px solid #e2e8f0;"><span style="color: ${c}; font-weight: bold; margin-right: 6px;">#</span><strong style="font-size: 17px; color: #1f2937;">${t}</strong></section>`
            ],
            num_title: [
                (t, c) => {
                    const { num, text } = parseNumTitle(t);
                    const n = num || '1';
                    return `<section style="margin: 0; padding: 25px 0 10px 0;"><span style="display: inline-block; width: 22px; height: 22px; background-color: ${c}; color: #fff; text-align: center; line-height: 22px; border-radius: 50%; font-size: 12px; font-weight: bold; vertical-align: 2px; margin-right: 8px;">${n}</span><strong style="font-size: 17px; color: #1f2937; vertical-align: middle;">${text}</strong></section>`;
                },
                (t, c) => {
                    const { num, text } = parseNumTitle(t);
                    const n = num || '01';
                    return `<section style="margin: 0; padding: 25px 0 10px 0;"><span style="font-size: 24px; font-weight: 900; color: ${hexToRgba(c, 0.4)}; margin-right: 4px; font-family: Arial; vertical-align: -3px;">${n}</span><strong style="font-size: 18px; color: #1f2937; vertical-align: middle;">${text}</strong></section>`;
                }
            ],
            grad_title: [
                (t, c) => `<section style="margin: 0; padding: 25px 0 10px 0;"><span style="display: inline-block; background-image: linear-gradient(90deg, ${c}, ${hexToRgba(c, 0.6)}); color: #fff; padding: 5px 15px; font-size: 15px; font-weight: bold; border-radius: 4px; max-width: 100%; box-sizing: border-box; word-break: break-all;">${t}</span></section>`,
                (t, c) => `<section style="margin: 0; padding: 25px 0 10px 0;"><div style="background-color: ${hexToRgba(c, 0.1)}; border-left: 4px solid ${c}; padding: 5px 12px; color: ${c}; font-weight: bold; font-size: 15px; border-radius: 0 4px 4px 0; display: inline-block; max-width: 100%; box-sizing: border-box;">${t}</div></section>`
            ],
            key_point: [
                // å¡ç‰‡ï¼špadding-top/bottom 15pxï¼Œç¡®ä¿å¡ç‰‡ä¹‹é—´æœ‰é—´éš™
                (t, c) => `<section style="margin: 0; padding: 15px 0; box-sizing: border-box;"><div style="padding: 15px; background-color: ${hexToRgba(c, 0.08)}; border: 1px solid ${hexToRgba(c, 0.3)}; border-radius: 6px; font-size: 15px; color: #334155; line-height: 2.0; text-align: justify; word-break: break-all;">${format(t)}</div></section>`,
                (t, c) => `<section style="margin: 0; padding: 15px 0; box-sizing: border-box;"><div style="padding: 15px; border-left: 4px solid ${c}; background-color: #f8fafc; font-size: 15px; color: #334155; line-height: 2.0; text-align: justify; word-break: break-all;">${format(t)}</div></section>`
            ],
            quote: [
                (t, c) => `<section style="margin: 0; padding: 15px 0; box-sizing: border-box;"><div style="padding: 12px 16px; background-color: #f8fafc; color: #64748b; border-radius: 4px; font-size: 14px; line-height: 2.0; border-left: 3px solid #cbd5e1; word-break: break-all;">${format(t)}</div></section>`
            ],
            bg_card: [
                (t, c) => `<section style="margin: 0; padding: 15px 0; box-sizing: border-box;"><div style="padding: 16px; background-color: ${c}; border-radius: 6px; color: #fff; font-size: 15px; line-height: 2.0; text-align: justify; word-break: break-all;">${format(t)}</div></section>`,
                (t, c) => `<section style="margin: 0; padding: 15px 0; box-sizing: border-box;"><div style="padding: 16px; background-color: ${hexToRgba(c, 0.1)}; border-radius: 6px; color: #334155; font-size: 15px; line-height: 2.0; text-align: justify; word-break: break-all;">${format(t)}</div></section>`
            ],
            code_block: [
                (t, c) => `<section style="margin: 0; padding: 15px 0; box-sizing: border-box;"><div style="padding: 12px; background-color: #1e293b; color: #e2e8f0; font-family: monospace; font-size: 13px; border-radius: 6px; overflow-x: auto; line-height: 1.6; word-break: break-all;">${t}</div></section>`
            ],
            normal: [
                // æ­£æ–‡ï¼šä¾é  padding-bottom: 10px æ’‘å¼€æ®µè½
                (t, c) => `<section style="margin: 0; padding: 0 0 10px 0; line-height: 2.0; font-size: 16px; color: #334155; text-align: justify;">${format(t)}</section>`
            ]
        };

        // æ–‡æœ¬æ ¼å¼åŒ–ï¼šp æ ‡ç­¾æ—  margin, æ—  padding
        function format(t) { 
            return t.split('\n').filter(l=>l.trim()).map(l=>`<p style="margin: 0; padding: 0;">${l}</p>`).join(''); 
        }

        window.onload = () => {
            if(localStorage.getItem('ds_key')) document.getElementById('api-key').value = localStorage.getItem('ds_key');
            renderColors();
        };

        function toggleSettings() { document.getElementById('settings-panel').classList.toggle('hidden'); }
        function saveConfig() { localStorage.setItem('ds_key', document.getElementById('api-key').value); }

        function renderColors() {
            const el = document.getElementById('color-palette');
            el.innerHTML = '';
            recentColors.forEach(c => {
                const dot = document.createElement('div');
                dot.className = 'color-dot'; dot.style.background = c;
                dot.onclick = () => updateColor(c);
                el.appendChild(dot);
            });
        }

        function updateColor(c) {
            currentColor = c;
            document.getElementById('custom-color').value = c;
            document.querySelectorAll('.block-wrapper.selected').forEach(el => applyVariant(el.dataset.type, true));
        }

        function renderArticle(blocks) {
            const container = document.getElementById('preview-content');
            container.innerHTML = '';
            
            blocks.forEach(b => {
                const wrapper = document.createElement('div');
                wrapper.className = 'block-wrapper';
                wrapper.dataset.type = b.type;
                wrapper.dataset.variant = 0;
                wrapper.dataset.raw = b.content;
                const renderer = VARIANTS[b.type] ? VARIANTS[b.type][0] : VARIANTS.normal[0];
                wrapper.innerHTML = renderer(b.content, currentColor);
                container.appendChild(wrapper);
            });
        }

        async function generateArticle() {
            const key = document.getElementById('api-key').value;
            const text = document.getElementById('user-input').value;
            if(!key || !text) return alert('è¯·å…ˆè®¾ç½® API Key å¹¶è¾“å…¥æ–‡ç« ');
            
            const btn = document.getElementById('btn-run');
            btn.disabled = true; btn.innerHTML = "â³ æ­£åœ¨æ’ç‰ˆ...";

            try {
                const cleanText = text.replace(/(\n\s*){2,}/g, '\n').trim();
                
                const res = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            {role: "system", content: "ä½ æ˜¯ä¸€ä¸ªæ’ç‰ˆè¾…åŠ©å·¥å…·ã€‚å°†è¾“å…¥æ–‡æœ¬æŒ‰é€»è¾‘æ®µè½æ‹†åˆ†ã€‚è¯†åˆ«æ ‡é¢˜(big_title, sub_title, num_title)å’Œé‡ç‚¹(key_point, quote)ã€‚ä¿æŒåŸæ–‡ã€‚è¿”å›JSONæ•°ç»„ã€‚"},
                            {role: "user", content: cleanText}
                        ],
                        temperature: 0.1
                    })
                });
                
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                const jsonStr = data.choices[0].message.content.match(/\[[\s\S]*\]/);
                
                if(!jsonStr) throw new Error("AI è¿”å›æ ¼å¼æœ‰è¯¯");
                
                renderArticle(JSON.parse(jsonStr[0]));
                
            } catch(e) { alert("é”™è¯¯ï¼š" + e.message); }
            finally { btn.disabled = false; btn.innerHTML = "ğŸš€ ä¸€é”®æ™ºèƒ½æ’ç‰ˆ"; }
        }

        document.getElementById('preview-content').addEventListener('click', e => {
            const w = e.target.closest('.block-wrapper');
            if(w) w.classList.toggle('selected');
        });

        function applyVariant(type, keepVariant = false) {
            const selected = document.querySelectorAll('.block-wrapper.selected');
            if(selected.length === 0 && !keepVariant) return alert("è¯·å…ˆé€‰ä¸­é¢„è§ˆåŒºçš„å†…å®¹");
            
            selected.forEach(el => {
                const raw = el.dataset.raw;
                const oldType = el.dataset.type;
                let vIdx = parseInt(el.dataset.variant);
                if(!keepVariant) vIdx = (oldType === type) ? (vIdx + 1) % VARIANTS[type].length : 0;

                const renderer = VARIANTS[type][vIdx];
                el.innerHTML = renderer(raw, currentColor);
                el.dataset.type = type;
                el.dataset.variant = vIdx;
            });
        }

        function mergeSelected() {
            const selected = Array.from(document.querySelectorAll('.block-wrapper.selected'))
                .sort((a,b) => a.offsetTop - b.offsetTop);
            if(selected.length < 2) return alert("è¯·è‡³å°‘é€‰ä¸­ä¸¤å—");
            
            const mergedText = selected.map(el => el.dataset.raw).join('\n');
            const wrapper = document.createElement('div');
            wrapper.className = 'block-wrapper selected';
            wrapper.dataset.type = 'normal';
            wrapper.dataset.variant = 0;
            wrapper.dataset.raw = mergedText;
            wrapper.innerHTML = VARIANTS.normal[0](mergedText, currentColor);
            
            selected[0].replaceWith(wrapper);
            selected.slice(1).forEach(el => el.remove());
        }

        // æ ¸å¿ƒä¿®æ”¹ï¼šå¤åˆ¶æ—¶å‹ç¼© HTMLï¼Œå»é™¤æ ‡ç­¾é—´çš„æ¢è¡Œç¬¦
        async function copyHtml() {
            const clone = document.getElementById('preview-content').cloneNode(true);
            clone.querySelectorAll('.block-wrapper').forEach(el => {
                el.classList.remove('selected', 'block-wrapper');
                // ä»…ä¿ç•™ style
                while(el.attributes.length > 0) {
                   if(el.attributes[0].name !== 'style') el.removeAttribute(el.attributes[0].name);
                   else break; 
                }
            });
            // å‹ç¼© HTMLï¼Œå»é™¤æ ‡ç­¾ä¹‹é—´çš„ç©ºæ ¼å’Œæ¢è¡Œ
            let html = clone.innerHTML.replace(/>\s+</g, '><'); 
            
            const blob = new Blob([html], {type: 'text/html'});
            await navigator.clipboard.write([new ClipboardItem({'text/html': blob})]);
            alert("âœ… å·²å¤åˆ¶ï¼é›¶ç©ºç™½æ¨¡å¼å·²å¯ç”¨ã€‚");
        }
    </script>
</body>
</html>
