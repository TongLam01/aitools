<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI çµæ„Ÿæ’ç‰ˆå¤§å¸ˆ v15.0 - å¾®ä¿¡åŸç”Ÿå†…æ ¸ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* UI ç•Œé¢æ ·å¼ (ä»…ç”¨äºç¼–è¾‘å™¨æœ¬èº«ï¼Œä¸å½±å“å¤åˆ¶å†…å®¹) */
        :root { --primary: #ff4d4f; }
        body { background-color: #f3f4f6; }
        
        #preview-container { 
            background: #222; min-height: 600px; border-radius: 40px;
            padding: 12px; border: 8px solid #333; max-width: 375px; margin: 0 auto 180px;
            box-shadow: 0 30px 60px -12px rgba(0,0,0,0.5); position: relative;
        }
        #preview-content {
            background: white; height: 100%; min-height: 580px;
            overflow-y: auto; padding: 20px 15px; outline: none; border-radius: 32px;
        }

        /* äº¤äº’é€‰æ¡† (è¿™äº›æ ·å¼ä¸ä¼šè¢«å¤åˆ¶) */
        .block-wrapper {
            position: relative; margin-bottom: 10px; cursor: pointer;
            transition: all 0.2s; border: 2px dashed transparent;
        }
        .block-wrapper:hover { border-color: #ddd; }
        .block-wrapper.selected { 
            border-color: #ff4d4f !important; 
            background-color: rgba(255, 77, 79, 0.05);
        }
        .block-wrapper.selected::after {
            content: 'âœ“ å·²é€‰ä¸­'; position: absolute; top: -10px; right: 0;
            background: #ff4d4f; color: white; font-size: 10px; padding: 2px 6px;
            border-radius: 4px; pointer-events: none;
        }

        /* åº•éƒ¨å·¥å…·æ  */
        .bottom-workbench {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-top: 1px solid #eee; z-index: 999;
            padding: 15px 20px calc(15px + env(safe-area-inset-bottom));
        }
        .style-btn { 
            padding: 8px 12px; background: white; border: 1px solid #e5e7eb; 
            border-radius: 8px; font-size: 12px; font-weight: bold; color: #374151;
            white-space: nowrap; cursor: pointer; transition: 0.1s;
        }
        .style-btn:hover { background: #f9fafb; border-color: #d1d5db; }
        .style-btn:active { transform: scale(0.95); }
        .color-dot { width: 26px; height: 26px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 0 0 1px #ccc; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="pb-48">

    <div class="max-w-7xl mx-auto py-8 px-4">
        <header class="mb-8 flex justify-between items-center">
            <h1 class="text-2xl font-black text-slate-800">AI Editor <span class="text-red-500 text-sm">v15.0 Native</span></h1>
            <div class="flex items-center gap-2 cursor-pointer" onclick="toggleSettings()">
                <span class="text-xs font-bold text-slate-500 bg-white px-3 py-1 rounded-full border">âš™ï¸ API Key</span>
            </div>
        </header>

        <div id="settings-panel" class="hidden fixed inset-0 bg-black/50 z-[2000] flex items-center justify-center p-4">
            <div class="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl">
                <h3 class="font-bold text-lg mb-4">è®¾ç½® API Key</h3>
                <input type="password" id="api-key" oninput="saveConfig()" class="w-full p-3 bg-slate-100 rounded-lg outline-none text-sm mb-4" placeholder="sk-...">
                <button onclick="toggleSettings()" class="w-full py-3 bg-slate-800 text-white rounded-lg font-bold">ä¿å­˜</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-7">
                <div class="bg-white p-4 rounded-3xl shadow-lg border border-slate-100 h-full flex flex-col gap-4">
                    <textarea id="user-input" class="w-full flex-1 p-4 bg-slate-50 rounded-2xl outline-none resize-none text-base leading-relaxed" placeholder="åœ¨æ­¤ç²˜è´´æ–‡ç« å†…å®¹..."></textarea>
                    <button onclick="generateArticle()" id="btn-run" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold text-lg shadow-md transition-all">
                        ğŸš€ ä¸€é”®ç”Ÿæˆå…¬ä¼—å·æ’ç‰ˆ
                    </button>
                </div>
            </div>

            <div class="lg:col-span-5 flex flex-col items-center">
                <div class="w-full flex justify-between items-center px-4 mb-2 max-w-[375px]">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">WeChat Preview</span>
                    <button onclick="copyHtml()" class="bg-green-600 text-white px-6 py-1.5 rounded-full font-bold text-xs hover:bg-green-700">å¤åˆ¶å…¨éƒ¨</button>
                </div>
                <div id="preview-container">
                    <div id="preview-content" contenteditable="true">
                        <div style="padding-top: 200px; text-align: center; color: #ccc; font-size: 14px;">æ’ç‰ˆç»“æœæ˜¾ç¤ºåŒº</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-workbench shadow-[0_-10px_30px_rgba(0,0,0,0.05)]">
        <div class="max-w-6xl mx-auto space-y-3">
            <div class="flex items-center gap-3 border-b pb-2">
                <span class="text-[10px] font-bold text-slate-400">é¢œè‰²:</span>
                <div class="flex gap-2" id="color-palette">
                    </div>
                <input type="color" id="custom-color" oninput="updateColor(this.value)" class="w-6 h-6 border-none p-0 bg-transparent cursor-pointer">
            </div>

            <div class="flex gap-2 overflow-x-auto no-scrollbar py-1">
                <button onclick="applyVariant('normal')" class="style-btn text-red-500">ğŸ—‘ï¸ è¿˜åŸ</button>
                <div class="w-[1px] bg-slate-200 mx-1"></div>
                <button onclick="applyVariant('big_title')" class="style-btn">âœ¦ å¤§æ ‡é¢˜</button>
                <button onclick="applyVariant('sub_title')" class="style-btn">â—ˆ å°æ ‡é¢˜</button>
                <button onclick="applyVariant('num_title')" class="style-btn">â¶ åºå·</button>
                <button onclick="applyVariant('grad_title')" class="style-btn">â–£ æ¸å˜</button>
                <button onclick="applyVariant('key_point')" class="style-btn">â˜… é‡ç‚¹</button>
                <button onclick="applyVariant('quote')" class="style-btn">â å¼•ç”¨</button>
                <button onclick="applyVariant('bg_card')" class="style-btn">â–§ åº•è‰²</button>
                <button onclick="applyVariant('code_block')" class="style-btn">âŒ¨ ä»£ç </button>
                <div class="w-[1px] bg-slate-200 mx-1"></div>
                <button onclick="mergeSelected()" class="style-btn bg-slate-800 text-white">ğŸ§© åˆå¹¶</button>
            </div>
        </div>
    </div>

    <script>
        let currentColor = '#3b82f6';
        let recentColors = ['#3b82f6', '#07c160', '#ff4d4f', '#f59e0b'];
        
        // ==========================================
        // æ ¸å¿ƒæ¨¡æ¿åº“ (WeChat Compatible)
        // æ³¨æ„ï¼šæ‰€æœ‰æ ·å¼å¿…é¡»æ˜¯ Inline Styleï¼Œä¸èƒ½ç”¨ class
        // ==========================================
        const VARIANTS = {
            big_title: [
                (t, c) => `<section style="text-align: center; margin: 30px 0 20px; box-sizing: border-box;"><span style="display: block; color: ${c}; font-size: 20px; margin-bottom: 5px;">âœ¦</span><strong style="display: inline-block; font-size: 22px; color: #333; border-bottom: 3px solid ${c}; padding: 0 10px 8px; line-height: 1.4;">${t}</strong></section>`,
                (t, c) => `<section style="text-align: center; margin: 30px 0 20px; box-sizing: border-box;"><strong style="display: inline-block; font-size: 20px; color: #fff; background-color: ${c}; padding: 8px 25px; border-radius: 4px; line-height: 1.4;">${t}</strong></section>`,
                (t, c) => `<section style="text-align: center; margin: 30px 0 20px; box-sizing: border-box;"><strong style="display: inline-block; font-size: 20px; color: ${c}; border: 2px solid ${c}; padding: 6px 25px; border-radius: 50px; line-height: 1.4;">${t}</strong></section>`
            ],
            sub_title: [
                (t, c) => `<section style="margin: 25px 0 15px; box-sizing: border-box;"><span style="display: inline-block; border-left: 5px solid ${c}; padding-left: 12px; font-size: 18px; font-weight: bold; color: #333; line-height: 1.4;">${t}</span></section>`,
                (t, c) => `<section style="margin: 25px 0 15px; box-sizing: border-box;"><table width="100%" cellpadding="0" cellspacing="0"><tr><td width="25" valign="middle"><span style="color: ${c}; font-size: 20px; font-weight: bold;">â—†</span></td><td valign="middle" style="border-bottom: 1px dashed ${c};"><span style="font-size: 18px; font-weight: bold; color: #333; line-height: 1.4;">${t}</span></td></tr></table></section>`
            ],
            num_title: [
                (t, c) => `<section style="margin: 20px 0; box-sizing: border-box;"><table cellpadding="0" cellspacing="0"><tr><td valign="middle" style="padding-right: 10px;"><span style="display: inline-block; width: 24px; height: 24px; background-color: ${c}; color: #fff; text-align: center; line-height: 24px; border-radius: 12px; font-size: 14px; font-weight: bold;">1</span></td><td valign="middle"><strong style="font-size: 17px; color: #333;">${t}</strong></td></tr></table></section>`,
                (t, c) => `<section style="margin: 20px 0; box-sizing: border-box;"><span style="font-family: Arial; font-weight: 900; font-size: 24px; color: ${c}; margin-right: 5px; vertical-align: middle;">01.</span><strong style="font-size: 17px; color: #333; vertical-align: middle;">${t}</strong></section>`
            ],
            grad_title: [
                (t, c) => `<section style="margin: 20px 0; box-sizing: border-box;"><span style="display: inline-block; background: linear-gradient(90deg, ${c}, #fff); padding: 5px 15px; border-radius: 4px; color: #fff; font-weight: bold; font-size: 16px;">${t}</span></section>`,
                (t, c) => `<section style="margin: 20px 0; box-sizing: border-box;"><div style="display: inline-block; background-color: ${c}15; border-left: 4px solid ${c}; padding: 6px 15px; color: ${c}; font-weight: bold; font-size: 16px;">${t}</div></section>`
            ],
            key_point: [
                (t, c) => `<section style="margin: 20px 0; padding: 20px; border: 1px solid ${c}; background-color: ${c}08; border-radius: 8px; box-sizing: border-box;">${format(t)}</section>`,
                (t, c) => `<section style="margin: 20px 0; padding: 20px; background-color: #fff; border-left: 5px solid ${c}; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-radius: 4px; box-sizing: border-box;">${format(t)}</section>`
            ],
            quote: [
                (t, c) => `<section style="margin: 20px 0; padding: 15px 18px; border-left: 4px solid ${c}; background-color: #f8f8f8; color: #666; font-size: 15px; line-height: 1.75; box-sizing: border-box;">${format(t)}</section>`,
                (t, c) => `<section style="margin: 20px 0; padding: 20px; background-color: #fcfcfc; text-align: center; border: 1px dashed ${c}; border-radius: 8px; box-sizing: border-box;"><span style="color:${c}; font-size:24px;">â€œ</span><div style="color: #555; font-size: 15px; margin: 5px 0;">${format(t)}</div><span style="color:${c}; font-size:24px;">â€</span></section>`
            ],
            bg_card: [
                (t, c) => `<section style="margin: 20px 0; padding: 18px; background-color: ${c}10; border-radius: 8px; font-size: 15px; line-height: 1.75; color: #333; box-sizing: border-box;">${format(t)}</section>`,
                (t, c) => `<section style="margin: 20px 0; padding: 2px 18px; border-top: 2px solid ${c}; border-bottom: 2px solid ${c}; background-color: #fcfcfc; color: #555; box-sizing: border-box;">${format(t)}</section>`
            ],
            code_block: [
                (t, c) => `<section style="margin: 20px 0; padding: 15px; background-color: #282c34; color: #abb2bf; font-family: Consolas, monospace; font-size: 13px; border-radius: 6px; overflow-x: auto; box-sizing: border-box; line-height: 1.5;">${t}</section>`
            ],
            normal: [
                (t, c) => `<section style="margin: 15px 0; line-height: 1.75; font-size: 16px; color: #333; text-align: justify; box-sizing: border-box;">${format(t)}</section>`
            ]
        };

        function format(t) { 
            return t.split('\n').filter(l=>l.trim()).map(l=>`<p style="margin: 0 0 10px 0; min-height: 1em;">${l}</p>`).join(''); 
        }

        // ==========================================
        // é€»è¾‘æ§åˆ¶å±‚
        // ==========================================
        window.onload = () => {
            if(localStorage.getItem('ds_key')) document.getElementById('api-key').value = localStorage.getItem('ds_key');
            renderColors();
        };

        function toggleSettings() { document.getElementById('settings-panel').classList.toggle('hidden'); }
        function saveConfig() { localStorage.setItem('ds_key', document.getElementById('api-key').value); }

        function renderColors() {
            const el = document.getElementById('color-palette');
            el.innerHTML = '';
            recentColors.forEach(c => {
                const dot = document.createElement('div');
                dot.className = 'color-dot'; dot.style.background = c;
                dot.onclick = () => updateColor(c);
                el.appendChild(dot);
            });
        }

        function updateColor(c) {
            currentColor = c;
            document.getElementById('custom-color').value = c;
            document.querySelectorAll('.block-wrapper.selected').forEach(el => applyVariant(el.dataset.type, true));
        }

        // æ ¸å¿ƒæ¸²æŸ“å™¨ï¼šAI å®Œæˆåç«‹å³è°ƒç”¨
        function renderArticle(blocks) {
            const container = document.getElementById('preview-content');
            container.innerHTML = '';
            blocks.forEach(b => {
                const wrapper = document.createElement('div');
                wrapper.className = 'block-wrapper';
                wrapper.dataset.type = b.type;
                wrapper.dataset.variant = 0;
                wrapper.dataset.raw = b.content;
                // ç«‹å³æ¸²æŸ“æ ·å¼
                const renderer = VARIANTS[b.type] ? VARIANTS[b.type][0] : VARIANTS.normal[0];
                wrapper.innerHTML = renderer(b.content, currentColor);
                container.appendChild(wrapper);
            });
        }

        async function generateArticle() {
            const key = document.getElementById('api-key').value;
            const text = document.getElementById('user-input').value;
            if(!key || !text) return alert('è¯·é…ç½® API Key å¹¶è¾“å…¥å†…å®¹');
            
            const btn = document.getElementById('btn-run');
            btn.disabled = true; btn.innerText = "â³ æ­£åœ¨æ’ç‰ˆ...";

            try {
                // 1. é¢„å¤„ç†æ–‡æœ¬
                const cleanText = text.replace(/\n\s*\n/g, '\n').trim();
                
                // 2. è°ƒç”¨ API
                const res = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            {role: "system", content: "ä½ æ˜¯ä¸€ä¸ªæ–‡æœ¬ç»“æ„åŒ–å·¥å…·ã€‚å°†è¾“å…¥æ–‡æœ¬æŒ‰é€»è¾‘æ‹†åˆ†ä¸ºJSONæ•°ç»„ï¼ŒåŒ…å«type(big_title, sub_title, num_title, key_point, quote, bg_card, normal)å’Œcontentã€‚ä¸¥ç¦ä¿®æ”¹åŸæ–‡ã€‚åªè¿”å›JSONã€‚"},
                            {role: "user", content: cleanText}
                        ],
                        temperature: 0.1
                    })
                });
                
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                
                const jsonStr = data.choices[0].message.content.match(/\[[\s\S]*\]/);
                if(!jsonStr) throw new Error("AI è¿”å›æ ¼å¼é”™è¯¯");
                
                // 3. æ¸²æŸ“
                renderArticle(JSON.parse(jsonStr[0]));
                
            } catch(e) { alert("é”™è¯¯ï¼š" + e.message); }
            finally { btn.disabled = false; btn.innerText = "ğŸš€ ä¸€é”®ç”Ÿæˆå…¬ä¼—å·æ’ç‰ˆ"; }
        }

        // äº¤äº’é€»è¾‘
        document.getElementById('preview-content').addEventListener('click', e => {
            const w = e.target.closest('.block-wrapper');
            if(w) w.classList.toggle('selected');
        });

        function applyVariant(type, keepVariant = false) {
            const selected = document.querySelectorAll('.block-wrapper.selected');
            if(selected.length === 0 && !keepVariant) return alert("è¯·å…ˆé€‰ä¸­é¢„è§ˆåŒºçš„å†…å®¹");
            
            selected.forEach(el => {
                const raw = el.dataset.raw;
                const oldType = el.dataset.type;
                let vIdx = parseInt(el.dataset.variant);

                if(!keepVariant) {
                    vIdx = (oldType === type) ? (vIdx + 1) % VARIANTS[type].length : 0;
                }

                const renderer = VARIANTS[type][vIdx];
                el.innerHTML = renderer(raw, currentColor);
                el.dataset.type = type;
                el.dataset.variant = vIdx;
            });
        }

        function mergeSelected() {
            const selected = Array.from(document.querySelectorAll('.block-wrapper.selected'))
                .sort((a,b) => a.offsetTop - b.offsetTop);
            if(selected.length < 2) return alert("è¯·è‡³å°‘é€‰ä¸­ä¸¤å—");
            
            const mergedText = selected.map(el => el.dataset.raw).join('\n\n');
            const wrapper = document.createElement('div');
            wrapper.className = 'block-wrapper selected';
            wrapper.dataset.type = 'normal';
            wrapper.dataset.variant = 0;
            wrapper.dataset.raw = mergedText;
            wrapper.innerHTML = VARIANTS.normal[0](mergedText, currentColor);
            
            selected[0].replaceWith(wrapper);
            selected.slice(1).forEach(el => el.remove());
        }

        async function copyHtml() {
            // å¤åˆ¶å‰å…ˆç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€ç±»ï¼Œé˜²æ­¢æŠŠçº¢è‰²è™šçº¿æ¡†å¤åˆ¶è¿‡å»
            const clone = document.getElementById('preview-content').cloneNode(true);
            clone.querySelectorAll('.block-wrapper').forEach(el => {
                el.classList.remove('selected', 'block-wrapper'); // ç§»é™¤äº¤äº’ç±»
                // ä¿ç•™ style å±æ€§ï¼Œç§»é™¤ data å±æ€§
                delete el.dataset.type; delete el.dataset.variant; delete el.dataset.raw;
            });
            
            const blob = new Blob([clone.innerHTML], {type: 'text/html'});
            await navigator.clipboard.write([new ClipboardItem({'text/html': blob})]);
            alert("âœ… å·²å¤åˆ¶ï¼è¯·ç›´æ¥ç²˜è´´åˆ°å…¬ä¼—å·ç¼–è¾‘å™¨ã€‚");
        }
    </script>
</body>
</html>
