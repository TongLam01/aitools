<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI çµæ„Ÿæ’ç‰ˆå¤§å¸ˆ v17.0 - åƒç´ çº§ä¿®æ­£ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #3b82f6; }
        body { background-color: #f8fafc; color: #334155; }
        
        #preview-container { 
            background: #fff; min-height: 600px; border-radius: 2px;
            padding: 0; border: 1px solid #e2e8f0; max-width: 375px; margin: 0 auto 180px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden;
        }
        #preview-content {
            background: white; height: 100%; min-height: 600px;
            overflow-y: auto; padding: 25px 16px; outline: none;
        }

        /* äº¤äº’é€‰æ¡† */
        .block-wrapper {
            position: relative; margin-bottom: 0; cursor: pointer;
            transition: all 0.15s; border: 1px solid transparent; padding: 2px;
        }
        .block-wrapper:hover { border-color: #94a3b8; border-style: dashed; }
        .block-wrapper.selected { 
            border: 2px solid #3b82f6 !important; 
            background-color: rgba(59, 130, 246, 0.03);
        }
        .block-wrapper.selected::after {
            content: 'âœ“'; position: absolute; top: 0; right: 0;
            background: #3b82f6; color: white; font-size: 10px; width: 16px; height: 16px;
            display: flex; alignItems: center; justify-content: center;
            border-bottom-left-radius: 4px; z-index: 10;
        }

        .bottom-workbench {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px);
            border-top: 1px solid #e2e8f0; z-index: 999;
            padding: 12px 16px calc(12px + env(safe-area-inset-bottom));
        }
        .style-btn { 
            padding: 6px 12px; background: white; border: 1px solid #cbd5e1; 
            border-radius: 6px; font-size: 12px; font-weight: 600; color: #475569;
            white-space: nowrap; cursor: pointer; transition: 0.1s;
        }
        .style-btn:hover { background: #f1f5f9; border-color: #94a3b8; color: #0f172a; }
        .style-btn:active { background: #e2e8f0; transform: translateY(1px); }
        .style-btn.active-style { background: #eff6ff; border-color: #3b82f6; color: #3b82f6; }
        
        .color-dot { width: 20px; height: 20px; border-radius: 4px; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); transition: transform 0.1s; }
        .color-dot:hover { transform: scale(1.1); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="pb-48">

    <div class="max-w-7xl mx-auto py-6 px-4">
        <header class="mb-6 flex justify-between items-center">
            <h1 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <span>âš¡ï¸</span> AI æ’ç‰ˆå¤§å¸ˆ <span class="bg-slate-100 text-slate-500 text-[10px] px-2 py-0.5 rounded border border-slate-200">v17.0 Clean</span>
            </h1>
            <div class="flex items-center gap-2 cursor-pointer hover:bg-white px-3 py-1.5 rounded-lg border border-transparent hover:border-slate-200 transition" onclick="toggleSettings()">
                <span class="text-xs font-medium text-slate-500">âš™ï¸ API Key</span>
            </div>
        </header>

        <div id="settings-panel" class="hidden fixed inset-0 bg-slate-900/10 backdrop-blur-[2px] z-[2000] flex items-center justify-center p-4">
            <div class="bg-white p-6 rounded-lg w-full max-w-sm shadow-xl border border-slate-100 ring-1 ring-slate-900/5">
                <h3 class="font-bold text-sm mb-4 text-slate-800">é…ç½® DeepSeek API</h3>
                <input type="password" id="api-key" oninput="saveConfig()" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded text-sm outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition mb-4" placeholder="sk-...">
                <button onclick="toggleSettings()" class="w-full py-2.5 bg-slate-900 hover:bg-slate-800 text-white rounded font-medium text-sm transition">ç¡®è®¤</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-140px)]">
            <div class="lg:col-span-7 h-full">
                <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 h-full flex flex-col">
                    <textarea id="user-input" class="w-full flex-1 p-2 bg-transparent outline-none resize-none text-base leading-relaxed text-slate-700 placeholder:text-slate-300 font-mono" placeholder="è¯·ç²˜è´´æ–‡ç« ...&#10;&#10;ç³»ç»Ÿå°†è‡ªåŠ¨ï¼š&#10;1. å»é™¤å¤šä½™ç©ºè¡Œ&#10;2. è¯†åˆ«å°æ ‡é¢˜å’Œåºå·&#10;3. é€‚é…å¾®ä¿¡é˜…è¯»ä½“éªŒ"></textarea>
                    <div class="pt-4 border-t border-slate-100 flex gap-3">
                        <button onclick="generateArticle()" id="btn-run" class="flex-1 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded font-bold text-sm shadow-sm transition flex justify-center items-center gap-2">
                            <span>ğŸš€</span> ä¸€é”®æ™ºèƒ½æ’ç‰ˆ
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-5 h-full flex flex-col items-center">
                <div class="w-full flex justify-between items-center px-1 mb-2 max-w-[375px]">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">WECHAT PREVIEW</span>
                    <button onclick="copyHtml()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-1.5 rounded font-bold text-xs shadow-sm transition flex items-center gap-1.5">
                        <span>ğŸ“‹</span> å¤åˆ¶
                    </button>
                </div>
                <div id="preview-container" class="w-full flex-1">
                    <div id="preview-content" contenteditable="true">
                        <div style="padding-top: 50%; text-align: center; color: #cbd5e1; font-size: 13px;">
                            <p>ç­‰å¾…å†…å®¹...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-workbench">
        <div class="max-w-7xl mx-auto space-y-3">
            <div class="flex items-center gap-3">
                <span class="text-[10px] font-bold text-slate-400 uppercase w-8">Color</span>
                <div class="flex gap-1.5" id="color-palette"></div>
                <div class="w-[1px] h-3 bg-slate-300 mx-1"></div>
                <input type="color" id="custom-color" oninput="updateColor(this.value)" class="w-5 h-5 rounded cursor-pointer border-0 bg-transparent p-0">
            </div>

            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                <button onclick="applyVariant('normal')" class="style-btn text-slate-500">è¿˜åŸæ­£æ–‡</button>
                <div class="w-[1px] h-4 bg-slate-300 mx-1 self-center"></div>
                <button onclick="applyVariant('big_title')" class="style-btn">å¤§æ ‡é¢˜</button>
                <button onclick="applyVariant('sub_title')" class="style-btn">å°æ ‡é¢˜</button>
                <button onclick="applyVariant('num_title')" class="style-btn text-blue-600">åºå·æ ‡</button>
                <button onclick="applyVariant('grad_title')" class="style-btn">æ¸å˜æ ‡</button>
                <button onclick="applyVariant('key_point')" class="style-btn">é‡ç‚¹å¡</button>
                <button onclick="applyVariant('quote')" class="style-btn">å¼•ç”¨</button>
                <button onclick="applyVariant('bg_card')" class="style-btn">åº•è‰²å¡</button>
                <button onclick="applyVariant('code_block')" class="style-btn">ä»£ç </button>
                <div class="w-[1px] h-4 bg-slate-300 mx-1 self-center"></div>
                <button onclick="mergeSelected()" class="style-btn bg-slate-800 text-white border-slate-800">åˆå¹¶</button>
            </div>
        </div>
    </div>

    <script>
        let currentColor = '#3b82f6';
        let recentColors = ['#3b82f6', '#07c160', '#f59e0b', '#ef4444', '#8b5cf6'];
        
        // ==========================================
        // æ ¸å¿ƒæ’ç‰ˆå¼•æ“ v17.0 (Zero-Gap Logic)
        // å…³é”®æ”¹åŠ¨ï¼šæ‰€æœ‰ margin-top = 0ï¼Œä»…ä½¿ç”¨ margin-bottom
        // ==========================================
        
        function parseNumTitle(text) {
            // æ™ºèƒ½åˆ†ç¦»åºå·ï¼Œç§»é™¤æœ«å°¾æ ‡ç‚¹
            const match = text.match(/^(\d+|[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)[.ã€\s]\s*(.*)$/);
            if (match) return { num: match[1], text: match[2] };
            return { num: '', text: text };
        }

        const VARIANTS = {
            big_title: [
                // æ ·å¼1ï¼šåº•éƒ¨ç²—çº¿æ¡
                (t, c) => `<section style="margin: 0 0 20px 0; text-align: center; line-height: 1.4;"><span style="display: block; font-size: 20px; color: ${c}; margin-bottom: 4px;">âœ¦</span><strong style="font-size: 22px; color: #1f2937; border-bottom: 3px solid ${c}; padding: 0 8px 6px; display: inline-block;">${t}</strong></section>`,
                // æ ·å¼2ï¼šå…¨è‰²å—èƒ¶å›Š
                (t, c) => `<section style="margin: 0 0 20px 0; text-align: center; line-height: 1.4;"><strong style="font-size: 18px; color: #fff; background: ${c}; padding: 8px 20px; border-radius: 4px; display: inline-block; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">${t}</strong></section>`,
                // æ ·å¼3ï¼šç©ºå¿ƒèƒ¶å›Š
                (t, c) => `<section style="margin: 0 0 20px 0; text-align: center; line-height: 1.4;"><strong style="font-size: 19px; color: ${c}; border: 2px solid ${c}; padding: 6px 20px; border-radius: 50px; display: inline-block;">${t}</strong></section>`
            ],
            sub_title: [
                // æ ·å¼1ï¼šå·¦ä¾§ç«–çº¿
                (t, c) => `<section style="margin: 0 0 15px 0; line-height: 1.4;"><span style="display: inline-block; width: 4px; height: 16px; background: ${c}; vertical-align: middle; margin-right: 8px; border-radius: 2px;"></span><strong style="font-size: 17px; color: #1f2937; vertical-align: middle;">${t}</strong></section>`,
                // æ ·å¼2ï¼šä¸‹åˆ’è™šçº¿
                (t, c) => `<section style="margin: 0 0 15px 0; border-bottom: 1px solid #e2e8f0; padding-bottom: 6px; line-height: 1.4;"><span style="color: ${c}; font-weight: bold; margin-right: 6px;">#</span><strong style="font-size: 17px; color: #1f2937;">${t}</strong></section>`
            ],
            num_title: [
                // æ ·å¼1ï¼šè“åœ†åœˆ (Flexæ¨¡æ‹Ÿï¼šinline-block)
                (t, c) => {
                    const { num, text } = parseNumTitle(t);
                    const n = num || '1';
                    return `<section style="margin: 0 0 15px 0; line-height: 1.5;"><span style="display: inline-block; width: 20px; height: 20px; background: ${c}; color: #fff; text-align: center; line-height: 20px; border-radius: 50%; font-size: 12px; font-weight: bold; vertical-align: 2px; margin-right: 8px;">${n}</span><strong style="font-size: 17px; color: #1f2937;">${text}</strong></section>`;
                },
                // æ ·å¼2ï¼šå¤§æ•°å­—èƒŒæ™¯
                (t, c) => {
                    const { num, text } = parseNumTitle(t);
                    const n = num || '01';
                    return `<section style="margin: 0 0 15px 0; line-height: 1.4;"><span style="font-size: 24px; font-weight: 900; color: ${c}30; margin-right: 2px; font-family: Arial; vertical-align: -2px;">${n}</span><strong style="font-size: 18px; color: #1f2937;">${text}</strong></section>`;
                }
            ],
            grad_title: [
                // æ ·å¼1ï¼šæ¸å˜èƒŒæ™¯ (display: block é€‚é…é•¿æ–‡)
                (t, c) => `<section style="margin: 0 0 15px 0;"><span style="display: inline-block; background: linear-gradient(90deg, ${c}, #fff); color: #fff; padding: 5px 12px; font-size: 15px; font-weight: bold; border-radius: 4px; max-width: 100%; box-sizing: border-box;">${t}</span></section>`,
                // æ ·å¼2ï¼šå·¦ä¾§æ¸å˜æ¡
                (t, c) => `<section style="margin: 0 0 15px 0;"><div style="background-color: ${c}10; border-left: 4px solid ${c}; padding: 6px 12px; color: ${c}; font-weight: bold; font-size: 15px; border-radius: 0 4px 4px 0; display: inline-block; max-width: 100%; box-sizing: border-box;">${t}</div></section>`
            ],
            key_point: [
                // æ ·å¼1ï¼šæµ…è‰²åº•æ¡†
                (t, c) => `<section style="margin: 0 0 15px 0; padding: 15px; background: ${c}0C; border: 1px solid ${c}30; border-radius: 6px; font-size: 15px; color: #334155; line-height: 1.6; text-align: justify;">${format(t)}</section>`,
                // æ ·å¼2ï¼šå·¦ä¾§å¼ºè°ƒ
                (t, c) => `<section style="margin: 0 0 15px 0; padding: 15px; background: #f8fafc; border-left: 4px solid ${c}; border-radius: 2px; font-size: 15px; color: #334155; line-height: 1.6; text-align: justify;">${format(t)}</section>`
            ],
            quote: [
                (t, c) => `<section style="margin: 0 0 15px 0; padding: 12px 16px; background: #f8fafc; color: #64748b; border-radius: 4px; font-size: 14px; line-height: 1.6; border-left: 3px solid #cbd5e1; text-align: justify;">${format(t)}</section>`
            ],
            bg_card: [
                // æ ·å¼1ï¼šå®å¿ƒæ·±è‰²å¡ (ç™½å­—)
                (t, c) => `<section style="margin: 0 0 15px 0; padding: 16px; background: ${c}; border-radius: 6px; color: #fff; font-size: 15px; line-height: 1.6; text-align: justify;">${format(t)}</section>`,
                // æ ·å¼2ï¼šæµ…è‰²å¡ (é»‘å­—)
                (t, c) => `<section style="margin: 0 0 15px 0; padding: 16px; background: ${c}15; border-radius: 6px; color: #334155; font-size: 15px; line-height: 1.6; text-align: justify;">${format(t)}</section>`
            ],
            code_block: [
                (t, c) => `<section style="margin: 0 0 15px 0; padding: 12px; background: #1e293b; color: #e2e8f0; font-family: monospace; font-size: 13px; border-radius: 6px; overflow-x: auto; line-height: 1.5;">${t}</section>`
            ],
            normal: [
                // æ­£æ–‡ï¼šçº¯å‡€æ—  Margin-Top
                (t, c) => `<section style="margin: 0 0 15px 0; line-height: 1.75; font-size: 16px; color: #334155; text-align: justify;">${format(t)}</section>`
            ]
        };

        // æ–‡æœ¬æ ¼å¼åŒ–ï¼šå»é™¤ç©ºè¡Œï¼Œæ®µè½é—´è·ç”± section ç»Ÿä¸€æ§åˆ¶ï¼Œå†…éƒ¨ p margin ä¸º 0
        function format(t) { 
            return t.split('\n').filter(l=>l.trim()).map(l=>`<p style="margin: 0; min-height: 1em;">${l}</p>`).join('<br>'); 
        }

        window.onload = () => {
            if(localStorage.getItem('ds_key')) document.getElementById('api-key').value = localStorage.getItem('ds_key');
            renderColors();
        };

        function toggleSettings() { document.getElementById('settings-panel').classList.toggle('hidden'); }
        function saveConfig() { localStorage.setItem('ds_key', document.getElementById('api-key').value); }

        function renderColors() {
            const el = document.getElementById('color-palette');
            el.innerHTML = '';
            recentColors.forEach(c => {
                const dot = document.createElement('div');
                dot.className = 'color-dot'; dot.style.background = c;
                dot.onclick = () => updateColor(c);
                el.appendChild(dot);
            });
        }

        function updateColor(c) {
            currentColor = c;
            document.getElementById('custom-color').value = c;
            document.querySelectorAll('.block-wrapper.selected').forEach(el => applyVariant(el.dataset.type, true));
        }

        function renderArticle(blocks) {
            const container = document.getElementById('preview-content');
            container.innerHTML = '';
            // å¾®ä¿¡å…¼å®¹å¤–å£³
            const root = document.createElement('div');
            root.style.fontSize = "16px";
            root.style.color = "#333";
            root.style.fontFamily = "-apple-system, BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif";
            
            blocks.forEach(b => {
                const wrapper = document.createElement('div');
                wrapper.className = 'block-wrapper';
                wrapper.dataset.type = b.type;
                wrapper.dataset.variant = 0;
                wrapper.dataset.raw = b.content;
                const renderer = VARIANTS[b.type] ? VARIANTS[b.type][0] : VARIANTS.normal[0];
                wrapper.innerHTML = renderer(b.content, currentColor);
                root.appendChild(wrapper);
            });
            container.appendChild(root);
        }

        async function generateArticle() {
            const key = document.getElementById('api-key').value;
            const text = document.getElementById('user-input').value;
            if(!key || !text) return alert('è¯·å…ˆè®¾ç½® API Key å¹¶è¾“å…¥æ–‡ç« ');
            
            const btn = document.getElementById('btn-run');
            btn.disabled = true; btn.innerHTML = "â³ æ­£åœ¨æ’ç‰ˆ...";

            try {
                // å¼ºåŠ›æ¸…æ´—ï¼šå»é™¤å¤šä½™ç©ºè¡Œï¼Œå»é™¤è¡Œé¦–è¡Œå°¾ç©ºç™½
                const cleanText = text.replace(/(\n\s*){2,}/g, '\n').trim();
                
                const res = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            {role: "system", content: "ä½ æ˜¯ä¸€ä¸ªæ’ç‰ˆè¾…åŠ©å·¥å…·ã€‚å°†è¾“å…¥æ–‡æœ¬æŒ‰é€»è¾‘æ®µè½æ‹†åˆ†ã€‚è¯†åˆ«æ ‡é¢˜(big_title, sub_title, num_title)å’Œé‡ç‚¹(key_point, quote)ã€‚ä¿æŒåŸæ–‡ã€‚è¿”å›JSONæ•°ç»„ã€‚"},
                            {role: "user", content: cleanText}
                        ],
                        temperature: 0.1
                    })
                });
                
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                const jsonStr = data.choices[0].message.content.match(/\[[\s\S]*\]/);
                
                if(!jsonStr) throw new Error("AI è¿”å›æ ¼å¼æœ‰è¯¯");
                
                renderArticle(JSON.parse(jsonStr[0]));
                
            } catch(e) { alert("é”™è¯¯ï¼š" + e.message); }
            finally { btn.disabled = false; btn.innerHTML = "ğŸš€ ä¸€é”®æ™ºèƒ½æ’ç‰ˆ"; }
        }

        document.getElementById('preview-content').addEventListener('click', e => {
            const w = e.target.closest('.block-wrapper');
            if(w) w.classList.toggle('selected');
        });

        function applyVariant(type, keepVariant = false) {
            const selected = document.querySelectorAll('.block-wrapper.selected');
            if(selected.length === 0 && !keepVariant) return alert("è¯·å…ˆé€‰ä¸­é¢„è§ˆåŒºçš„å†…å®¹");
            
            selected.forEach(el => {
                const raw = el.dataset.raw;
                const oldType = el.dataset.type;
                let vIdx = parseInt(el.dataset.variant);
                if(!keepVariant) vIdx = (oldType === type) ? (vIdx + 1) % VARIANTS[type].length : 0;

                const renderer = VARIANTS[type][vIdx];
                el.innerHTML = renderer(raw, currentColor);
                el.dataset.type = type;
                el.dataset.variant = vIdx;
            });
        }

        function mergeSelected() {
            const selected = Array.from(document.querySelectorAll('.block-wrapper.selected'))
                .sort((a,b) => a.offsetTop - b.offsetTop);
            if(selected.length < 2) return alert("è¯·è‡³å°‘é€‰ä¸­ä¸¤å—");
            
            const mergedText = selected.map(el => el.dataset.raw).join('\n');
            const wrapper = document.createElement('div');
            wrapper.className = 'block-wrapper selected';
            wrapper.dataset.type = 'normal';
            wrapper.dataset.variant = 0;
            wrapper.dataset.raw = mergedText;
            wrapper.innerHTML = VARIANTS.normal[0](mergedText, currentColor);
            
            selected[0].replaceWith(wrapper);
            selected.slice(1).forEach(el => el.remove());
        }

        async function copyHtml() {
            const clone = document.getElementById('preview-content').cloneNode(true);
            clone.querySelectorAll('.block-wrapper').forEach(el => {
                el.classList.remove('selected', 'block-wrapper');
                while(el.attributes.length > 0) {
                   if(el.attributes[0].name !== 'style') el.removeAttribute(el.attributes[0].name);
                   else break; 
                }
            });
            const html = clone.innerHTML.replace(/data-[a-z]+="[^"]*"/g, '').replace(/class=""/g, '');
            const blob = new Blob([html], {type: 'text/html'});
            await navigator.clipboard.write([new ClipboardItem({'text/html': blob})]);
            alert("âœ… å·²å¤åˆ¶ï¼ç²˜è´´åˆ°å…¬ä¼—å·çœ‹çœ‹æ•ˆæœå§ã€‚");
        }
    </script>
</body>
</html>
