<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI çµæ„Ÿæ’ç‰ˆå¤§å¸ˆ v4.0 - å…¨èƒ½ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #3b82f6; }
        #preview-container { 
            background: #f0f2f5; min-height: 650px; border-radius: 40px;
            padding: 12px; border: 10px solid #222; max-width: 380px; margin: 0 auto;
            position: relative;
        }
        #preview-content {
            background: white; height: 100%; min-height: 600px;
            overflow-y: auto; padding: 20px; outline: none; border-radius: 30px;
        }
        /* å¤šé€‰æ ·å¼ */
        .block-item { transition: all 0.2s; cursor: pointer; border: 2px solid transparent; border-radius: 8px; margin-bottom: 4px; }
        .block-item:hover { border-color: #e2e8f0; }
        .block-item.selected { border-color: var(--primary) !important; background-color: rgba(59, 130, 246, 0.05); box-shadow: 0 0 10px rgba(59, 130, 246, 0.2); }
        
        .style-btn { @apply px-3 py-1.5 bg-white hover:bg-slate-50 text-slate-700 text-xs rounded-lg border border-slate-200 shadow-sm transition-all font-medium; }
        .theme-card.active { border-color: var(--primary); background-color: white; ring: 2px; ring-color: var(--primary); }
        
        /* ä¾§è¾¹å·¥å…·æ å¸é¡¶ */
        .sticky-tools { position: sticky; top: 20px; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 pb-20">

    <div class="max-w-7xl mx-auto py-10 px-4">
        <header class="mb-8 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-black text-slate-800">ğŸš€ AI çµæ„Ÿæ’ç‰ˆ <span class="text-blue-600">v4.0</span></h1>
                <p class="text-slate-500">è‡ªåŠ¨è§£æ + å¤šé€‰ä¿®æ”¹ + ä¸»é¢˜åˆ‡æ¢</p>
            </div>
            <div class="flex gap-4">
                <input type="password" id="api-key" oninput="saveConfig()" class="p-2 border rounded-lg text-xs w-48 shadow-sm" placeholder="DeepSeek API Key">
                <button onclick="clearStorage()" class="text-xs text-slate-400">æ¸…ç©ºç¼“å­˜</button>
            </div>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">
            
            <div class="flex-1 space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm space-y-4">
                    <label class="block text-sm font-bold text-slate-700">ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©å…¨å±€è‰²è°ƒ</label>
                    <div class="grid grid-cols-3 gap-4">
                        <div onclick="selectTheme('tech')" id="theme-tech" class="theme-card active cursor-pointer p-4 border-2 rounded-xl text-center transition-all">
                            <span class="block text-xl">ğŸ”µ</span><span class="text-sm font-bold">ç§‘æŠ€è“</span>
                        </div>
                        <div onclick="selectTheme('fresh')" id="theme-fresh" class="theme-card cursor-pointer p-4 border-2 rounded-xl text-center transition-all">
                            <span class="block text-xl">ğŸŒ¿</span><span class="text-sm font-bold">æ¸…æ–°ç»¿</span>
                        </div>
                        <div onclick="selectTheme('festive')" id="theme-festive" class="theme-card cursor-pointer p-4 border-2 rounded-xl text-center transition-all">
                            <span class="block text-xl">ğŸ§§</span><span class="text-sm font-bold">æ·¡å–œåº†</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm space-y-4">
                    <label class="block text-sm font-bold text-slate-700">ç¬¬äºŒæ­¥ï¼šè¾“å…¥æ–‡å­—å†…å®¹</label>
                    <textarea id="user-input" class="w-full h-80 p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-600 outline-none transition-all" placeholder="ç²˜è´´å†…å®¹åˆ°è¿™é‡Œ..."></textarea>
                    <button id="btn-run" onclick="generateArticle()" class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold text-lg hover:bg-blue-700 shadow-lg transform active:scale-95 transition-all">
                        âœ¨ ä¸€é”® AI å…¨è‡ªåŠ¨æ™ºèƒ½æ’ç‰ˆ
                    </button>
                </div>
            </div>

            <div class="w-full lg:w-[450px] flex flex-col md:flex-row lg:flex-col gap-6">
                
                <div id="preview-container" class="shrink-0">
                    <div id="preview-content" onclick="toggleBlockSelection(event)">
                        <div style="margin-top:200px; text-align:center; color:#ccc;">ç­‰å¾…ç”Ÿæˆå†…å®¹...</div>
                    </div>
                </div>

                <div class="flex-1">
                    <div class="sticky-tools space-y-4">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-4">
                            <div class="flex justify-between items-center">
                                <h3 class="font-bold text-slate-700 italic">æ ·å¼å·¥ä½œå°</h3>
                                <button onclick="copyHtml()" class="px-4 py-1.5 bg-green-600 text-white text-xs font-bold rounded-full shadow-md">ä¸€é”®å¤åˆ¶</button>
                            </div>
                            
                            <hr>
                            
                            <div class="space-y-3">
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">é€‰ä¸­å—æ“ä½œ</p>
                                <div class="grid grid-cols-2 gap-2" id="template-options">
                                    </div>
                                <div class="pt-2 flex gap-2">
                                    <button onclick="selectAllBlocks()" class="text-[10px] text-blue-500 font-bold hover:underline">å…¨é€‰æ‰€æœ‰å—</button>
                                    <button onclick="clearSelection()" class="text-[10px] text-slate-400 font-bold hover:underline">å–æ¶ˆé€‰æ‹©</button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                            <p class="text-[11px] text-blue-600 leading-relaxed">
                                ğŸ’¡ <b>æŠ€å·§ï¼š</b><br>
                                1. å…ˆé€‰å…¨å±€è‰²è°ƒå†æ™ºèƒ½æ’ç‰ˆã€‚<br>
                                2. ç‚¹å‡»é¢„è§ˆåŒºå¯<b>å¤šé€‰</b>ï¼ˆæŒ‰ä½æ–‡å­—è¾¹ç¼˜ï¼‰ï¼Œç„¶åç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ‰¹é‡æ¢æ ·å¼ã€‚
                            </p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        let currentTheme = 'tech';
        let selectedElements = new Set();

        const THEME_COLORS = {
            tech: { main: '#3b82f6', bg: '#eff6ff', border: '#bfdbfe', text: '#1e40af' },
            fresh: { main: '#10b981', bg: '#f0fdf4', border: '#bbf7d0', text: '#065f46' },
            festive: { main: '#ef4444', bg: '#fef2f2', border: '#fecaca', text: '#991b1b' }
        };

        const STYLE_NAMES = {
            big_title: "å¤§æ ‡é¢˜", sub_title: "å°æ ‡é¢˜", num_title: "æ•°å­—æ ‡é¢˜",
            grad_title: "æ¸å˜èƒŒæ™¯", key_point: "é‡ç‚¹å¡ç‰‡", quote: "å¼•ç”¨å—",
            code_block: "æ·±è‰²ä»£ç ", bg_card: "æµ…è‰²åº•å›¾", normal: "æ™®é€šæ­£æ–‡"
        };

        // 1. åˆå§‹åŒ–
        window.onload = () => {
            const savedKey = localStorage.getItem('ds_api_key');
            if (savedKey) document.getElementById('api-key').value = savedKey;
            
            const btnContainer = document.getElementById('template-options');
            Object.keys(STYLE_NAMES).forEach(key => {
                const btn = document.createElement('button');
                btn.className = 'style-btn';
                btn.innerText = STYLE_NAMES[key];
                btn.onclick = () => applyTemplateToSelection(key);
                btnContainer.appendChild(btn);
            });
        };

        function selectTheme(t) {
            currentTheme = t;
            document.querySelectorAll('.theme-card').forEach(c => c.classList.remove('active'));
            document.getElementById(`theme-${t}`).classList.add('active');
            document.documentElement.style.setProperty('--primary', THEME_COLORS[t].main);
        }

        function saveConfig() { localStorage.setItem('ds_api_key', document.getElementById('api-key').value); }
        function clearStorage() { localStorage.clear(); location.reload(); }

        // 2. åŠ¨æ€ç”Ÿæˆæ¨¡æ¿ (æ ¹æ®å½“å‰ä¸»é¢˜è‰²)
        function getTemplate(type, text) {
            const c = THEME_COLORS[currentTheme];
            const tpls = {
                big_title: `<section class="block-item" style="margin: 2em 0 1em; text-align: center;"><h1 style="font-size: 24px; color: #333; border-bottom: 3px solid ${c.main}; display: inline-block; padding-bottom: 5px;">${text}</h1></section>`,
                sub_title: `<section class="block-item" style="margin: 1.5em 0 1em; padding-left: 12px; border-left: 5px solid ${c.main};"><h2 style="font-size: 19px; color: #1e293b; margin: 0;">${text}</h2></section>`,
                num_title: `<section class="block-item" style="margin: 1.5em 0; display: flex; align-items: center;"><span style="background: ${c.main}; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-weight: bold;">N</span><h3 style="font-size: 18px; color: #333; margin:0;">${text}</h3></section>`,
                grad_title: `<section class="block-item" style="margin: 1.5em 0; background: linear-gradient(90deg, ${c.bg} 0%, rgba(255,255,255,0) 100%); padding: 12px; border-radius: 6px;"><h2 style="font-size: 18px; color: ${c.main}; margin: 0;">${text}</h2></section>`,
                key_point: `<section class="block-item" style="margin: 1.5em 0; padding: 20px; border: 1px solid ${c.border}; background: ${c.bg}; border-radius: 12px; color: ${c.text};"><strong>ğŸ“ æ ¸å¿ƒæç¤º</strong><br>${text}</section>`,
                quote: `<section class="block-item" style="margin: 1.5em 0; padding: 15px; border-left: 4px solid #cbd5e1; color: #64748b; font-style: italic; background: #f8fafc;">${text}</section>`,
                code_block: `<section class="block-item" style="margin: 1.5em 0; padding: 15px; background: #1e293b; color: #e2e8f0; border-radius: 8px; font-family: monospace; font-size: 13px; white-space: pre-wrap;">${text}</section>`,
                bg_card: `<section class="block-item" style="margin: 1.5em 0; padding: 20px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0; color: #334155;">${text}</section>`,
                normal: `<section class="block-item" style="margin: 1.2em 0; line-height: 1.8; font-size: 16px; color: #374151; text-align: justify;">${text}</section>`
            };
            return tpls[type] || tpls.normal;
        }

        // 3. AI å…¨è‡ªåŠ¨æ’ç‰ˆ
        async function generateArticle() {
            const apiKey = document.getElementById('api-key').value;
            const text = document.getElementById('user-input').value;
            const btn = document.getElementById('btn-run');
            if (!apiKey || !text) return alert("è¯·è¾“å…¥ API Key å’Œå†…å®¹");

            btn.disabled = true;
            btn.innerText = "ğŸš€ AI æ­£åœ¨æ‹¼å‘½æ’ç‰ˆä¸­...";

            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªæ’ç‰ˆå¤§å¸ˆã€‚å°†ç”¨æˆ·æ–‡æœ¬æ‹†åˆ†ä¸ºé€»è¾‘å—ã€‚
            å¯é€‰æ ‡ç­¾ï¼šbig_title, sub_title, num_title, grad_title, key_point, quote, code_block, bg_card, normalã€‚
            è§„åˆ™ï¼šç›´æ¥è¾“å‡ºåŒ…å«è¿™äº›æ ‡ç­¾å†…å®¹çš„åˆ—è¡¨ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
            [TAG]å†…å®¹[/TAG]
            ä¸è¦è¾“å‡ºä»»ä½•å…¶ä»–æ–‡å­—æˆ–Markdownæ ‡è®°ã€‚`;

            try {
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [{ role: "system", content: systemPrompt }, { role: "user", content: text }],
                        temperature: 0.3
                    })
                });
                const data = await response.json();
                const content = data.choices[0].message.content;
                
                // è§£æè‡ªå®šä¹‰æ ‡ç­¾å¹¶æ¸²æŸ“
                renderParsedContent(content);
            } catch (error) { alert("ç”Ÿæˆå¤±è´¥: " + error.message); }
            finally { btn.disabled = false; btn.innerText = "âœ¨ ä¸€é”® AI å…¨è‡ªåŠ¨æ™ºèƒ½æ’ç‰ˆ"; }
        }

        function renderParsedContent(raw) {
            const container = document.getElementById('preview-content');
            container.innerHTML = '';
            
            // ä½¿ç”¨æ­£åˆ™åŒ¹é… [TAG]å†…å®¹[/TAG]
            const regex = /\[(\w+)\]([\s\S]*?)\[\/\1\]/g;
            let match;
            let found = false;

            while ((match = regex.exec(raw)) !== null) {
                found = true;
                const type = match[1].toLowerCase();
                const text = match[2].trim();
                const html = getTemplate(type, text);
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                const element = tempDiv.firstElementChild;
                element.setAttribute('data-raw', text);
                container.appendChild(element);
            }

            if (!found) {
                // å¦‚æœ AI æ²¡æŒ‰æ ¼å¼è¿”å›ï¼Œåˆ™ä½œä¸ºæ™®é€šæ–‡æœ¬å¤„ç†
                container.innerHTML = `<section class="block-item" data-raw="${raw}">${raw}</section>`;
            }
        }

        // 4. å¤šé€‰ä¸å±€éƒ¨å¾®è°ƒé€»è¾‘
        function toggleBlockSelection(e) {
            const block = e.target.closest('.block-item');
            if (!block) return;
            
            if (block.classList.contains('selected')) {
                block.classList.remove('selected');
                selectedElements.delete(block);
            } else {
                block.classList.add('selected');
                selectedElements.add(block);
            }
        }

        function selectAllBlocks() {
            document.querySelectorAll('.block-item').forEach(el => {
                el.classList.add('selected');
                selectedElements.add(el);
            });
        }

        function clearSelection() {
            selectedElements.forEach(el => el.classList.remove('selected'));
            selectedElements.clear();
        }

        function applyTemplateToSelection(type) {
            if (selectedElements.size === 0) return alert("è¯·å…ˆç‚¹å‡»é¢„è§ˆåŒºé€‰æ‹©æ®µè½");
            
            selectedElements.forEach(el => {
                const rawText = el.getAttribute('data-raw') || el.innerText;
                const newHtml = getTemplate(type, rawText);
                const temp = document.createElement('div');
                temp.innerHTML = newHtml;
                const newEl = temp.firstElementChild;
                newEl.setAttribute('data-raw', rawText);
                newEl.classList.add('selected'); // ä¿æŒé€‰ä¸­çŠ¶æ€
                
                el.replaceWith(newEl);
                selectedElements.delete(el);
                selectedElements.add(newEl);
            });
        }

        async function copyHtml() {
            const content = document.getElementById('preview-content').cloneNode(true);
            content.querySelectorAll('.block-item').forEach(el => {
                el.classList.remove('selected', 'block-item');
                el.removeAttribute('data-raw');
            });
            const blob = new Blob([content.innerHTML], { type: "text/html" });
            const data = [new ClipboardItem({ ["text/html"]: blob })];
            await navigator.clipboard.write(data);
            alert("âœ… å·²æˆåŠŸå¤åˆ¶ï¼è¯·å»å…¬ä¼—å·åå°ç²˜è´´ã€‚");
        }
    </script>
</body>
</html>
