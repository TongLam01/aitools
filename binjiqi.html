<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI çµæ„Ÿæ’ç‰ˆå¤§å¸ˆ v9.0 - äº¤äº’å¤§å¸ˆç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #preview-container { 
            background: #111; min-height: 600px; border-radius: 40px;
            padding: 10px; border: 6px solid #333; max-width: 375px; margin: 0 auto 180px;
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.4);
        }
        #preview-content {
            background: white; height: 100%; min-height: 580px;
            overflow-y: auto; padding: 20px 0; outline: none; border-radius: 32px;
        }

        /* é¢„è§ˆåŒºé€‰ä¸­æ€ï¼šçº¢è‰²è™šçº¿ + çŠ¶æ€æ ‡ç­¾ */
        .block-item { 
            position: relative; margin-bottom: 4px; padding: 10px 0;
            transition: all 0.2s ease; cursor: pointer; border: 2px solid transparent;
        }
        .block-item.selected { 
            border: 2px dashed #ff4d4f !important;
            background-color: rgba(255, 77, 79, 0.02);
        }
        .block-item.selected::after {
            content: 'âœ“ è¢«é€‰ä¸­';
            position: absolute; top: -12px; right: 10px;
            background: #ff4d4f; color: white; font-size: 10px;
            padding: 2px 8px; border-radius: 4px; font-weight: bold; z-index: 50;
        }

        /* åº•éƒ¨å·¥å…·æ å¸ƒå±€ */
        .bottom-workbench {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px); border-top: 1px solid #eee;
            z-index: 999; padding: 16px 20px calc(16px + env(safe-area-inset-bottom));
        }

        .style-btn { @apply px-3 py-2 bg-white hover:bg-slate-50 text-slate-700 text-xs rounded-xl border border-slate-200 shadow-sm transition-all font-bold whitespace-nowrap; }
        .style-btn:active { transform: scale(0.92); }
        
        /* é¢œè‰²çƒ */
        .color-dot { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 0 0 1px #ddd; transition: 0.2s; }
        .color-dot:hover { transform: scale(1.2); }
        .color-dot.active { box-shadow: 0 0 0 2px #ff4d4f; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 pb-48">

    <div class="max-w-7xl mx-auto py-8 px-4">
        <header class="mb-8 flex flex-col md:flex-row justify-between items-end gap-6">
            <div>
                <h1 class="text-3xl font-black text-slate-800 italic">AI Editor <span class="text-red-500">v9.0</span></h1>
                <p class="text-slate-400 text-[10px] font-bold tracking-[0.2em] uppercase">Interactive Master Edition</p>
            </div>
            <div class="flex items-center gap-3">
                <input type="password" id="api-key" oninput="saveConfig()" class="p-2 border rounded-xl text-xs w-48 shadow-inner outline-none focus:ring-1 focus:ring-red-400" placeholder="API Key">
                <button onclick="clearStorage()" class="text-[10px] text-slate-300">é‡ç½®</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
            <div class="lg:col-span-7 space-y-6">
                <div class="bg-white p-6 rounded-[2.5rem] shadow-xl border border-slate-100 space-y-4">
                    <textarea id="user-input" class="w-full h-[500px] p-6 bg-slate-50 border-none rounded-[1.5rem] outline-none focus:bg-white transition-all text-lg leading-relaxed" placeholder="åœ¨æ­¤ç²˜è´´åŸå§‹å†…å®¹..."></textarea>
                    <button id="btn-run" onclick="generateArticle()" class="w-full py-5 bg-slate-900 text-white rounded-2xl font-black text-xl hover:shadow-2xl active:scale-[0.98] transition-all">
                        ğŸš€ ä¸€é”® AI è§£æ
                    </button>
                </div>
            </div>

            <div class="lg:col-span-5">
                <div class="sticky top-6">
                    <div class="flex justify-between mb-4 items-center px-4">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Phone Frame Preview</span>
                        <button onclick="copyHtml()" class="bg-green-600 text-white px-8 py-2 rounded-full font-bold text-xs shadow-lg hover:bg-green-700">ä¸€é”®å¤åˆ¶å†…å®¹</button>
                    </div>
                    <div id="preview-container">
                        <div id="preview-content" contenteditable="true" onclick="handleBlockClick(event)">
                            <div class="flex items-center justify-center h-full text-slate-200 italic pt-56">ç»“æœæ˜¾ç¤ºåŒºåŸŸ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-workbench shadow-[0_-20px_50px_rgba(0,0,0,0.1)]">
        <div class="max-w-6xl mx-auto space-y-4">
            
            <div class="flex flex-wrap items-center gap-4 border-b pb-3">
                <span class="text-[10px] font-black text-slate-400 uppercase">é¢œè‰²å®éªŒå®¤:</span>
                <div class="flex items-center gap-2" id="color-palette">
                    <div class="color-dot" style="background:#3b82f6" onclick="updateColor('#3b82f6')"></div>
                    <div class="color-dot" style="background:#10b981" onclick="updateColor('#10b981')"></div>
                    <div class="color-dot" style="background:#ef4444" onclick="updateColor('#ef4444')"></div>
                    <div class="color-dot" style="background:#f59e0b" onclick="updateColor('#f59e0b')"></div>
                    <div class="color-dot" style="background:#8b5cf6" onclick="updateColor('#8b5cf6')"></div>
                </div>
                <div class="h-6 w-[1px] bg-slate-200"></div>
                <div class="flex items-center gap-2">
                    <span class="text-[10px] text-slate-400">è‡ªå®šä¹‰:</span>
                    <input type="color" id="custom-color" oninput="updateColor(this.value)" class="w-6 h-6 border-none cursor-pointer p-0 bg-transparent">
                </div>
                <div id="recent-colors" class="flex gap-2"></div>
            </div>

            <div class="flex justify-between items-center px-1">
                <div class="flex gap-4">
                    <button onclick="selectAll()" class="text-[10px] text-slate-800 font-bold">å…¨é€‰</button>
                    <button onclick="clearSelection()" class="text-[10px] text-slate-400 font-bold">å–æ¶ˆ</button>
                </div>
                <span id="current-style-name" class="text-[10px] font-bold text-red-500 uppercase"></span>
            </div>
            
            <div class="flex gap-3 overflow-x-auto no-scrollbar pb-1">
                <button onclick="applyTemplate('normal')" class="style-btn text-red-500">ğŸ—‘ï¸ æ¸…é™¤æ ¼å¼</button>
                <div class="w-[1px] bg-slate-200 mx-1"></div>
                <button onclick="applyTemplate('big_title')" class="style-btn">âœ¦ å¤§æ ‡é¢˜</button>
                <button onclick="applyTemplate('sub_title')" class="style-btn">â—ˆ å°æ ‡é¢˜</button>
                <button onclick="applyTemplate('num_title')" class="style-btn">â¶ åºå·æ ‡é¢˜</button>
                <button onclick="applyTemplate('grad_title')" class="style-btn">â–£ æ¸å˜æ ‡</button>
                <button onclick="applyTemplate('key_point')" class="style-btn">â˜… é‡ç‚¹å¡</button>
                <button onclick="applyTemplate('quote')" class="style-btn">â å¼•ç”¨å—</button>
                <button onclick="applyTemplate('code_block')" class="style-btn">âŒ¨ ä»£ç å—</button>
                <button onclick="applyTemplate('bg_card')" class="style-btn">â–§ åº•è‰²å¡</button>
                <div class="w-[1px] bg-slate-200 mx-1"></div>
                <button onclick="mergeSelected()" class="style-btn bg-slate-800 text-white border-none">ğŸ§© åˆå¹¶æ®µè½</button>
            </div>
        </div>
    </div>

    <script>
        let selectedElements = new Set();
        let currentColor = '#3b82f6';
        let recentColors = JSON.parse(localStorage.getItem('recent_colors') || '[]');
        let lastAppliedType = 'normal';

        window.onload = () => {
            const savedKey = localStorage.getItem('ds_api_key');
            if (savedKey) document.getElementById('api-key').value = savedKey;
            renderRecentColors();
        };

        function saveConfig() { localStorage.setItem('ds_api_key', document.getElementById('api-key').value); }
        function clearStorage() { localStorage.clear(); location.reload(); }

        // é¢œè‰²å®éªŒå®¤é€»è¾‘
        function updateColor(color) {
            currentColor = color;
            document.getElementById('custom-color').value = color;
            // å¦‚æœå·²ç»æœ‰é€‰ä¸­çš„ï¼Œå³æ—¶å˜æ¢é¢œè‰²
            if (selectedElements.size > 0) {
                applyTemplate(lastAppliedType);
            }
            addToRecent(color);
        }

        function addToRecent(color) {
            recentColors = [color, ...recentColors.filter(c => c !== color)].slice(0, 5);
            localStorage.setItem('recent_colors', JSON.stringify(recentColors));
            renderRecentColors();
        }

        function renderRecentColors() {
            const container = document.getElementById('recent-colors');
            container.innerHTML = recentColors.length ? '<span class="text-[10px] text-slate-300 ml-2">æœ€è¿‘:</span>' : '';
            recentColors.forEach(c => {
                const dot = document.createElement('div');
                dot.className = 'color-dot';
                dot.style.background = c;
                dot.onclick = () => updateColor(c);
                container.appendChild(dot);
            });
        }

        // æ ¸å¿ƒæ’ç‰ˆå¼•æ“ v9.0
        function getTemplate(type, text, color) {
            const baseStyle = `padding: 0 10px; box-sizing: border-box;`;
            const formattedText = text.split('\n').filter(l => l.trim()).map(line => `<p style="margin-bottom:0.8em; line-height:1.8;">${line}</p>`).join('');
            const lightBg = color + '15'; // çº¦10%é€æ˜åº¦

            const tpls = {
                big_title: `<section class="block-item" style="${baseStyle} margin: 2em 0; text-align: center;">
                    <div style="font-size: 24px; color: ${color}; margin-bottom: 5px;">âœ¦</div>
                    <h1 style="font-size: 22px; color: #111; border-bottom: 2px solid ${color}; display: inline-block; padding: 0 15px 8px; font-weight:bold; margin: 0;">${text}</h1>
                </section>`,
                
                sub_title: `<section class="block-item" style="${baseStyle} margin: 1.5em 0; text-align:left;">
                    <div style="display: flex; align-items: center; border-left: 5px solid ${color}; padding-left: 12px; background: linear-gradient(to right, ${lightBg}, transparent);">
                        <h2 style="font-size: 19px; color: #1e293b; margin: 0; font-weight:bold;">${text}</h2>
                    </div>
                </section>`,
                
                num_title: `<section class="block-item" style="${baseStyle} margin: 1.5em 0; text-align:left; display: flex; align-items: center;">
                    <span style="background: ${color}; color: white; min-width: 24px; height: 24px; border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold; font-size: 13px;">1</span>
                    <h3 style="font-size: 18px; color: #333; margin:0; font-weight:bold;">${text}</h3>
                </section>`,
                
                grad_title: `<section class="block-item" style="${baseStyle} margin: 1.5em 0; text-align:left;">
                    <div style="background: ${color}; padding: 8px 15px; border-radius: 0 20px 20px 0; display: inline-block;">
                        <h2 style="font-size: 17px; color: white; margin: 0; font-weight:bold;">${text}</h2>
                    </div>
                </section>`,
                
                key_point: `<section class="block-item" style="${baseStyle} margin: 1.5em 0;">
                    <div style="padding: 20px; border-radius: 12px; border: 2px solid ${color}; background: ${lightBg}; text-align:left;">
                        <div style="font-size: 16px; color: #333;">${formattedText}</div>
                    </div>
                </section>`,
                
                quote: `<section class="block-item" style="${baseStyle} margin: 1.5em 0;">
                    <div style="padding: 15px 20px; border-left: 4px solid ${color}; color: #555; background: #f9f9f9; text-align:left;">
                        <div style="font-size: 24px; color: ${color}; line-height: 10px; height: 15px; font-family: Georgia;">â€œ</div>
                        ${formattedText}
                    </div>
                </section>`,
                
                code_block: `<section class="block-item" style="${baseStyle} margin: 1.5em 0;">
                    <div style="padding: 15px; background: #2d3436; color: #dfe6e9; border-radius: 8px; font-family: monospace; font-size: 13px; border-top: 4px solid ${color}; text-align:left;">
                        ${text}
                    </div>
                </section>`,
                
                bg_card: `<section class="block-item" style="${baseStyle} margin: 1.5em 0;">
                    <div style="padding: 20px; background: ${lightBg}; border-radius: 15px; text-align:left; border-right: 4px solid ${color};">
                        ${formattedText}
                    </div>
                </section>`,
                
                normal: `<section class="block-item" style="${baseStyle} margin: 1.2em 0; line-height: 1.8; font-size: 16px; color: #374151; text-align: justify;">
                    ${formattedText}
                </section>`
            };
            return tpls[type] || tpls.normal;
        }

        // äº¤äº’é€»è¾‘
        function handleBlockClick(e) {
            const block = e.target.closest('.block-item');
            if (!block) return;
            if (block.classList.contains('selected')) {
                block.classList.remove('selected');
                selectedElements.delete(block);
            } else {
                block.classList.add('selected');
                selectedElements.add(block);
            }
        }

        function applyTemplate(type) {
            lastAppliedType = type;
            if (selectedElements.size === 0) return;
            
            const currentSelected = Array.from(selectedElements);
            currentSelected.forEach(el => {
                const rawText = el.getAttribute('data-raw') || el.innerText;
                const newHtml = getTemplate(type, rawText, currentColor);
                const temp = document.createElement('div');
                temp.innerHTML = newHtml;
                const newEl = temp.firstElementChild;
                newEl.setAttribute('data-raw', rawText);
                newEl.classList.add('selected');
                el.replaceWith(newEl);
                selectedElements.delete(el);
                selectedElements.add(newEl);
            });
            document.getElementById('current-style-name').innerText = STYLE_NAMES[type] || '';
        }

        // AI è§£æé€»è¾‘
        async function generateArticle() {
            const apiKey = document.getElementById('api-key').value;
            const text = document.getElementById('user-input').value;
            if (!apiKey || !text) return alert("ä¿¡æ¯ç¼ºå¤±");
            const btn = document.getElementById('btn-run');
            btn.innerText = "â³ AI æ­£åœ¨è§£æ...";

            try {
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªæ’ç‰ˆå¸ˆã€‚å°†æ–‡æœ¬æ‹†åˆ†ä¸ºJSONæ•°ç»„ï¼ŒåŒ…å«typeå’Œcontentã€‚typeé€‰ï¼šbig_title, sub_title, num_title, key_point, quote, bg_card, normalã€‚ä¿æŒåŸè¯ã€‚" },
                            { role: "user", content: text }
                        ]
                    })
                });
                const data = await response.json();
                const blocks = JSON.parse(data.choices[0].message.content.match(/\[[\s\S]*\]/)[0]);
                const container = document.getElementById('preview-content');
                container.innerHTML = '';
                blocks.forEach(b => {
                    const temp = document.createElement('div');
                    temp.innerHTML = getTemplate(b.type, b.content, currentColor);
                    const el = temp.firstElementChild;
                    el.setAttribute('data-raw', b.content);
                    container.appendChild(el);
                });
            } catch (e) { alert("è§£æå¤±è´¥"); } finally { btn.innerText = "ğŸš€ ä¸€é”® AI è§£æ"; }
        }

        function mergeSelected() {
            if (selectedElements.size < 2) return alert("è¯·è‡³å°‘é€‰ä¸­ä¸¤æ®µ");
            const sorted = Array.from(selectedElements).sort((a, b) => a.offsetTop - b.offsetTop);
            const mergedText = sorted.map(el => el.getAttribute('data-raw') || el.innerText).join('\n\n');
            const first = sorted[0];
            const newElMarkup = getTemplate('normal', mergedText, currentColor);
            const temp = document.createElement('div');
            temp.innerHTML = newElMarkup;
            const newEl = temp.firstElementChild;
            newEl.setAttribute('data-raw', mergedText);
            newEl.classList.add('selected');
            first.replaceWith(newEl);
            sorted.slice(1).forEach(el => el.remove());
            selectedElements.clear();
            selectedElements.add(newEl);
        }

        function selectAll() { document.querySelectorAll('.block-item').forEach(el => { el.classList.add('selected'); selectedElements.add(el); }); }
        function clearSelection() { selectedElements.forEach(el => el.classList.remove('selected')); selectedElements.clear(); }

        async function copyHtml() {
            const content = document.getElementById('preview-content').cloneNode(true);
            content.querySelectorAll('.block-item').forEach(el => { el.classList.remove('selected'); el.removeAttribute('data-raw'); });
            const blob = new Blob([content.innerHTML], { type: "text/html" });
            const data = [new ClipboardItem({ ["text/html"]: blob })];
            await navigator.clipboard.write(data);
            alert("âœ… æ’ç‰ˆå·²å¤åˆ¶ï¼");
        }
        
        const STYLE_NAMES = { big_title: "å¤§æ ‡é¢˜", sub_title: "å°æ ‡é¢˜", num_title: "åºå·æ ‡", grad_title: "æ¸å˜æ ‡", key_point: "é‡ç‚¹å¡", quote: "å¼•ç”¨å—", code_block: "ä»£ç å—", bg_card: "åº•è‰²å¡", normal: "æ­£æ–‡" };
    </script>
</body>
</html>
