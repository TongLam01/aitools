<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI çµæ„Ÿæ’ç‰ˆå¤§å¸ˆ v18.0 - é›¶é—´è·ç»ˆæç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #3b82f6; }
        body { background-color: #f1f5f9; color: #334155; }
        
        #preview-container { 
            background: #fff; min-height: 600px; border-radius: 4px;
            padding: 0; border: 1px solid #cbd5e1; max-width: 375px; margin: 0 auto 150px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden;
        }
        #preview-content {
            background: white; height: 100%; min-height: 600px;
            overflow-y: auto; padding: 20px 15px; outline: none;
        }

        /* äº¤äº’é€‰æ¡† */
        .block-wrapper {
            position: relative; margin-bottom: 0; cursor: pointer;
            transition: all 0.1s; border: 1px solid transparent; padding: 2px;
        }
        .block-wrapper:hover { border-color: #94a3b8; border-style: dashed; z-index: 10; }
        .block-wrapper.selected { 
            border: 2px solid #3b82f6 !important; 
            background-color: rgba(59, 130, 246, 0.05);
            z-index: 20;
        }
        .block-wrapper.selected::after {
            content: 'âœ“'; position: absolute; top: 0; right: 0;
            background: #3b82f6; color: white; font-size: 10px; width: 16px; height: 16px;
            display: flex; align-items: center; justify-content: center;
            border-bottom-left-radius: 4px; pointer-events: none;
        }

        .bottom-workbench {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.98); border-top: 1px solid #e2e8f0;
            z-index: 999; padding: 10px 16px calc(10px + env(safe-area-inset-bottom));
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
        }
        .style-btn { 
            padding: 6px 10px; background: white; border: 1px solid #cbd5e1; 
            border-radius: 6px; font-size: 12px; font-weight: 600; color: #475569;
            white-space: nowrap; cursor: pointer; transition: 0.1s;
        }
        .style-btn:hover { background: #f8fafc; border-color: #64748b; color: #0f172a; }
        .style-btn:active { background: #e2e8f0; transform: translateY(1px); }
        
        .color-dot { width: 20px; height: 20px; border-radius: 4px; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="pb-40">

    <div class="max-w-7xl mx-auto py-6 px-4">
        <header class="mb-6 flex justify-between items-center">
            <h1 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <span>âš¡ï¸</span> AI æ’ç‰ˆå¤§å¸ˆ <span class="bg-blue-100 text-blue-700 text-[10px] px-2 py-0.5 rounded border border-blue-200">v18.0 Zero-Gap</span>
            </h1>
            <div class="flex items-center gap-2 cursor-pointer bg-white px-3 py-1.5 rounded border border-slate-200 hover:border-blue-400 transition" onclick="toggleSettings()">
                <span class="text-xs font-medium text-slate-600">ğŸ”‘ API è®¾ç½®</span>
            </div>
        </header>

        <div id="settings-panel" class="hidden fixed inset-0 bg-slate-900/20 backdrop-blur-[2px] z-[2000] flex items-center justify-center p-4">
            <div class="bg-white p-6 rounded-lg w-full max-w-sm shadow-2xl border border-slate-100">
                <h3 class="font-bold text-sm mb-4 text-slate-800">DeepSeek API Key</h3>
                <input type="password" id="api-key" oninput="saveConfig()" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded text-sm outline-none focus:border-blue-500 mb-4" placeholder="sk-...">
                <button onclick="toggleSettings()" class="w-full py-2.5 bg-slate-900 hover:bg-slate-800 text-white rounded font-medium text-sm">ç¡®è®¤ä¿å­˜</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-140px)]">
            <div class="lg:col-span-7 h-full">
                <div class="bg-white p-2 rounded-lg shadow-sm border border-slate-200 h-full flex flex-col">
                    <textarea id="user-input" class="w-full flex-1 p-3 bg-transparent outline-none resize-none text-base leading-relaxed text-slate-700 placeholder:text-slate-300 font-mono" placeholder="è¯·ç²˜è´´æ–‡ç« ...&#10;&#10;ç³»ç»Ÿå°†è‡ªåŠ¨ï¼š&#10;1. æ¶ˆé™¤æ®µè½å¤§ç™½è¾¹&#10;2. ä¿®å¤æ–‡å­—æº¢å‡º&#10;3. æ™ºèƒ½è¯†åˆ«åºå·"></textarea>
                    <div class="p-2 border-t border-slate-100">
                        <button onclick="generateArticle()" id="btn-run" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded font-bold text-sm shadow-sm transition flex justify-center items-center gap-2">
                            <span>ğŸš€</span> ä¸€é”®æ™ºèƒ½æ’ç‰ˆ
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-5 h-full flex flex-col items-center">
                <div class="w-full flex justify-between items-center px-1 mb-2 max-w-[375px]">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">WECHAT PREVIEW</span>
                    <button onclick="copyHtml()" class="bg-green-600 hover:bg-green-700 text-white px-5 py-1.5 rounded font-bold text-xs shadow-sm transition">
                        å¤åˆ¶åˆ°å…¬ä¼—å·
                    </button>
                </div>
                <div id="preview-container" class="w-full flex-1">
                    <div id="preview-content" contenteditable="true">
                        <div style="padding-top: 50%; text-align: center; color: #cbd5e1; font-size: 13px;">ç­‰å¾…ç”Ÿæˆ...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-workbench">
        <div class="max-w-7xl mx-auto space-y-3">
            <div class="flex items-center gap-3">
                <span class="text-[10px] font-bold text-slate-400 uppercase w-8">Color</span>
                <div class="flex gap-1.5" id="color-palette"></div>
                <input type="color" id="custom-color" oninput="updateColor(this.value)" class="w-5 h-5 rounded cursor-pointer border-0 bg-transparent p-0">
            </div>

            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                <button onclick="applyVariant('normal')" class="style-btn text-red-500 bg-red-50 border-red-100">è¿˜åŸ</button>
                <div class="w-[1px] h-4 bg-slate-300 mx-1 self-center"></div>
                <button onclick="applyVariant('big_title')" class="style-btn">å¤§æ ‡é¢˜</button>
                <button onclick="applyVariant('sub_title')" class="style-btn">å°æ ‡é¢˜</button>
                <button onclick="applyVariant('num_title')" class="style-btn text-blue-600">åºå·æ ‡</button>
                <button onclick="applyVariant('grad_title')" class="style-btn">æ¸å˜æ ‡</button>
                <button onclick="applyVariant('key_point')" class="style-btn">é‡ç‚¹å¡</button>
                <button onclick="applyVariant('quote')" class="style-btn">å¼•ç”¨</button>
                <button onclick="applyVariant('bg_card')" class="style-btn">åº•è‰²å¡</button>
                <button onclick="applyVariant('code_block')" class="style-btn">ä»£ç </button>
                <div class="w-[1px] h-4 bg-slate-300 mx-1 self-center"></div>
                <button onclick="mergeSelected()" class="style-btn bg-slate-800 text-white border-slate-800">åˆå¹¶</button>
            </div>
        </div>
    </div>

    <script>
        let currentColor = '#3b82f6';
        let recentColors = ['#3b82f6', '#07c160', '#f59e0b', '#ef4444', '#8b5cf6'];
        
        // æ™ºèƒ½åºå·æå–
        function parseNumTitle(text) {
            const match = text.match(/^(\d+|[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)[.ã€\s]\s*(.*)$/);
            if (match) return { num: match[1], text: match[2] };
            return { num: '', text: text };
        }

        // ==========================================
        // æ ¸å¿ƒæ¨¡æ¿åº“ v18.0 (Zero-Gap Logic)
        // å…³é”®æ”¹åŠ¨ï¼špadding:0, margin:0, box-sizing:border-box, word-break:break-all
        // ==========================================
        const VARIANTS = {
            big_title: [
                (t, c) => `<section style="margin: 0 0 10px 0; text-align: center;"><span style="display: block; font-size: 20px; color: ${c}; line-height: 1;">âœ¦</span><strong style="font-size: 20px; color: #1f2937; border-bottom: 3px solid ${c}; padding: 0 10px 5px; display: inline-block;">${t}</strong></section>`,
                (t, c) => `<section style="margin: 0 0 10px 0; text-align: center;"><strong style="font-size: 18px; color: #fff; background: ${c}; padding: 8px 20px; border-radius: 4px; display: inline-block;">${t}</strong></section>`,
                (t, c) => `<section style="margin: 0 0 10px 0; text-align: center;"><strong style="font-size: 19px; color: ${c}; border: 2px solid ${c}; padding: 6px 20px; border-radius: 50px; display: inline-block;">${t}</strong></section>`
            ],
            sub_title: [
                (t, c) => `<section style="margin: 0 0 10px 0; display: flex; align-items: center;"><span style="display: inline-block; width: 4px; height: 18px; background: ${c}; margin-right: 8px; border-radius: 2px;"></span><strong style="font-size: 17px; color: #1f2937;">${t}</strong></section>`,
                (t, c) => `<section style="margin: 0 0 10px 0; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px;"><span style="color: ${c}; font-weight: bold; margin-right: 6px;">#</span><strong style="font-size: 17px; color: #1f2937;">${t}</strong></section>`
            ],
            num_title: [
                // è“åœ†åœˆ (ä½¿ç”¨ inline-block æ¨¡æ‹Ÿ flexï¼Œé¿å…å¾®ä¿¡å…¼å®¹é—®é¢˜)
                (t, c) => {
                    const { num, text } = parseNumTitle(t);
                    const n = num || '1';
                    return `<section style="margin: 0 0 10px 0;"><span style="display: inline-block; width: 22px; height: 22px; background: ${c}; color: #fff; text-align: center; line-height: 22px; border-radius: 50%; font-size: 12px; font-weight: bold; vertical-align: 2px; margin-right: 8px;">${n}</span><strong style="font-size: 17px; color: #1f2937; vertical-align: middle;">${text}</strong></section>`;
                },
                (t, c) => {
                    const { num, text } = parseNumTitle(t);
                    const n = num || '01';
                    return `<section style="margin: 0 0 10px 0;"><span style="font-size: 24px; font-weight: 900; color: ${c}40; margin-right: 4px; font-family: Arial; vertical-align: -3px;">${n}</span><strong style="font-size: 18px; color: #1f2937; vertical-align: middle;">${text}</strong></section>`;
                }
            ],
            grad_title: [
                // ä¿®å¤ï¼šmax-width: 100% é˜²æ­¢æº¢å‡º
                (t, c) => `<section style="margin: 0 0 10px 0;"><span style="display: inline-block; background: linear-gradient(90deg, ${c}, #fff); color: #fff; padding: 5px 15px; font-size: 15px; font-weight: bold; border-radius: 4px; max-width: 100%; box-sizing: border-box; word-break: break-all;">${t}</span></section>`,
                (t, c) => `<section style="margin: 0 0 10px 0;"><div style="background-color: ${c}15; border-left: 4px solid ${c}; padding: 5px 12px; color: ${c}; font-weight: bold; font-size: 15px; border-radius: 0 4px 4px 0; display: inline-block; max-width: 100%; box-sizing: border-box;">${t}</div></section>`
            ],
            key_point: [
                (t, c) => `<section style="margin: 0 0 15px 0; padding: 15px; background: ${c}0C; border: 1px solid ${c}30; border-radius: 6px; font-size: 15px; color: #334155; line-height: 1.6; text-align: justify; word-break: break-all;">${format(t)}</section>`,
                (t, c) => `<section style="margin: 0 0 15px 0; padding: 15px; border-left: 4px solid ${c}; background: #f8fafc; font-size: 15px; color: #334155; line-height: 1.6; text-align: justify; word-break: break-all;">${format(t)}</section>`
            ],
            quote: [
                (t, c) => `<section style="margin: 0 0 15px 0; padding: 12px 16px; background: #f8fafc; color: #64748b; border-radius: 4px; font-size: 14px; line-height: 1.6; border-left: 3px solid #cbd5e1; word-break: break-all;">${format(t)}</section>`
            ],
            bg_card: [
                (t, c) => `<section style="margin: 0 0 15px 0; padding: 16px; background: ${c}; border-radius: 6px; color: #fff; font-size: 15px; line-height: 1.6; text-align: justify; word-break: break-all;">${format(t)}</section>`,
                (t, c) => `<section style="margin: 0 0 15px 0; padding: 16px; background: ${c}15; border-radius: 6px; color: #334155; font-size: 15px; line-height: 1.6; text-align: justify; word-break: break-all;">${format(t)}</section>`
            ],
            code_block: [
                (t, c) => `<section style="margin: 0 0 15px 0; padding: 12px; background: #1e293b; color: #e2e8f0; font-family: monospace; font-size: 13px; border-radius: 6px; overflow-x: auto; line-height: 1.5; word-break: break-all;">${t}</section>`
            ],
            normal: [
                // æ ¸å¿ƒä¿®å¤ï¼šæ®µè½ margin: 0, ä»…é€šè¿‡ margin-bottom: 15px æ§åˆ¶å—é—´è·
                (t, c) => `<section style="margin: 0 0 15px 0; line-height: 1.75; font-size: 16px; color: #334155; text-align: justify;">${format(t)}</section>`
            ]
        };

        // æ–‡æœ¬æ ¼å¼åŒ–ï¼šå¼ºåˆ¶ P æ ‡ç­¾ margin ä¸º 0ï¼Œé¿å…å åŠ 
        function format(t) { 
            return t.split('\n').filter(l=>l.trim()).map(l=>`<p style="margin: 0; padding: 0;">${l}</p>`).join('<br>'); 
        }

        window.onload = () => {
            if(localStorage.getItem('ds_key')) document.getElementById('api-key').value = localStorage.getItem('ds_key');
            renderColors();
        };

        function toggleSettings() { document.getElementById('settings-panel').classList.toggle('hidden'); }
        function saveConfig() { localStorage.setItem('ds_key', document.getElementById('api-key').value); }

        function renderColors() {
            const el = document.getElementById('color-palette');
            el.innerHTML = '';
            recentColors.forEach(c => {
                const dot = document.createElement('div');
                dot.className = 'color-dot'; dot.style.background = c;
                dot.onclick = () => updateColor(c);
                el.appendChild(dot);
            });
        }

        function updateColor(c) {
            currentColor = c;
            document.getElementById('custom-color').value = c;
            document.querySelectorAll('.block-wrapper.selected').forEach(el => applyVariant(el.dataset.type, true));
        }

        function renderArticle(blocks) {
            const container = document.getElementById('preview-content');
            container.innerHTML = '';
            const root = document.createElement('div');
            // å…¨å±€å®¹å™¨é‡ç½®
            root.style.fontSize = "16px";
            root.style.lineHeight = "1.6";
            root.style.color = "#333";
            root.style.fontFamily = "-apple-system, BlinkMacSystemFont, Arial, sans-serif";
            
            blocks.forEach(b => {
                const wrapper = document.createElement('div');
                wrapper.className = 'block-wrapper';
                wrapper.dataset.type = b.type;
                wrapper.dataset.variant = 0;
                wrapper.dataset.raw = b.content;
                const renderer = VARIANTS[b.type] ? VARIANTS[b.type][0] : VARIANTS.normal[0];
                wrapper.innerHTML = renderer(b.content, currentColor);
                root.appendChild(wrapper);
            });
            container.appendChild(root);
        }

        async function generateArticle() {
            const key = document.getElementById('api-key').value;
            const text = document.getElementById('user-input').value;
            if(!key || !text) return alert('è¯·å…ˆè®¾ç½® API Key å¹¶è¾“å…¥æ–‡ç« ');
            
            const btn = document.getElementById('btn-run');
            btn.disabled = true; btn.innerHTML = "â³ æ­£åœ¨æ’ç‰ˆ...";

            try {
                // 1. å¼ºåŠ›å»é™¤å¤šä½™ç©ºè¡Œå’Œé¦–å°¾ç©ºæ ¼
                const cleanText = text.replace(/(\n\s*){2,}/g, '\n').trim();
                
                const res = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            {role: "system", content: "ä½ æ˜¯ä¸€ä¸ªæ’ç‰ˆè§£æå·¥å…·ã€‚å°†æ–‡æœ¬æ‹†åˆ†ä¸ºé€»è¾‘æ®µè½çš„JSONæ•°ç»„[{type, content}]ã€‚è¯†åˆ«æ ‡é¢˜(big_title, sub_title, num_title)å’Œé‡ç‚¹(key_point, quote)ã€‚ä¿æŒåŸæ–‡ã€‚"},
                            {role: "user", content: cleanText}
                        ],
                        temperature: 0.1
                    })
                });
                
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                const jsonStr = data.choices[0].message.content.match(/\[[\s\S]*\]/);
                
                if(!jsonStr) throw new Error("AI è¿”å›æ ¼å¼æœ‰è¯¯");
                
                renderArticle(JSON.parse(jsonStr[0]));
                
            } catch(e) { alert("é”™è¯¯ï¼š" + e.message); }
            finally { btn.disabled = false; btn.innerHTML = "ğŸš€ ä¸€é”®æ™ºèƒ½æ’ç‰ˆ"; }
        }

        document.getElementById('preview-content').addEventListener('click', e => {
            const w = e.target.closest('.block-wrapper');
            if(w) w.classList.toggle('selected');
        });

        function applyVariant(type, keepVariant = false) {
            const selected = document.querySelectorAll('.block-wrapper.selected');
            if(selected.length === 0 && !keepVariant) return alert("è¯·å…ˆé€‰ä¸­é¢„è§ˆåŒºçš„å†…å®¹");
            
            selected.forEach(el => {
                const raw = el.dataset.raw;
                const oldType = el.dataset.type;
                let vIdx = parseInt(el.dataset.variant);
                if(!keepVariant) vIdx = (oldType === type) ? (vIdx + 1) % VARIANTS[type].length : 0;

                const renderer = VARIANTS[type][vIdx];
                el.innerHTML = renderer(raw, currentColor);
                el.dataset.type = type;
                el.dataset.variant = vIdx;
            });
        }

        function mergeSelected() {
            const selected = Array.from(document.querySelectorAll('.block-wrapper.selected'))
                .sort((a,b) => a.offsetTop - b.offsetTop);
            if(selected.length < 2) return alert("è¯·è‡³å°‘é€‰ä¸­ä¸¤å—");
            
            const mergedText = selected.map(el => el.dataset.raw).join('\n');
            const wrapper = document.createElement('div');
            wrapper.className = 'block-wrapper selected';
            wrapper.dataset.type = 'normal';
            wrapper.dataset.variant = 0;
            wrapper.dataset.raw = mergedText;
            wrapper.innerHTML = VARIANTS.normal[0](mergedText, currentColor);
            
            selected[0].replaceWith(wrapper);
            selected.slice(1).forEach(el => el.remove());
        }

        async function copyHtml() {
            const clone = document.getElementById('preview-content').cloneNode(true);
            clone.querySelectorAll('.block-wrapper').forEach(el => {
                el.classList.remove('selected', 'block-wrapper');
                // ä»…ç§»é™¤äº¤äº’å±æ€§ï¼Œä¿ç•™ style
                delete el.dataset.type; delete el.dataset.variant; delete el.dataset.raw;
                // ç§»é™¤å¤–å±‚çš„äº¤äº’ wrapper divï¼Œåªä¿ç•™é‡Œé¢çš„ section
                const content = el.innerHTML;
                el.outerHTML = content; 
            });
            // æ­¤æ—¶ clone.innerHTML é‡Œåªæœ‰ section æ ‡ç­¾äº†ï¼Œæ²¡æœ‰ div wrapper
            
            const blob = new Blob([clone.innerHTML], {type: 'text/html'});
            await navigator.clipboard.write([new ClipboardItem({'text/html': blob})]);
            alert("âœ… å·²å¤åˆ¶ï¼æ ·å¼å·²ä¼˜åŒ–é˜²æº¢å‡ºã€‚");
        }
    </script>
</body>
</html>
