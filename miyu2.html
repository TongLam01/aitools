<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç®€åŠ å¯†æ–‡æœ¬åˆ†äº«</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
        }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }

        .container { width: 100%; max-width: 600px; margin-top: 40px; }

        .card {
            background: var(--card);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
        }

        h1 { font-size: 1.5rem; text-align: center; margin-bottom: 24px; color: var(--primary); }

        textarea, input {
            width: 100%;
            padding: 14px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 16px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: all 0.2s;
        }

        textarea:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        textarea { height: 180px; resize: none; }

        .btn-group { display: flex; gap: 10px; flex-direction: column; }

        button {
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-secondary { background: #f1f5f9; color: #475569; }

        /* ç»“æœæ˜¾ç¤ºåŒº */
        #result-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8fafc;
            border: 1px dashed var(--primary);
            border-radius: 12px;
            display: none;
        }

        .url-display {
            word-break: break-all;
            font-size: 0.85rem;
            color: var(--primary);
            margin: 10px 0;
            padding: 8px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
        }

        /* é˜…è¯»æ¨¡å¼ */
        .article { white-space: pre-wrap; line-height: 1.8; font-size: 1.1rem; padding: 10px 0; }
        .article-meta { font-size: 0.85rem; color: #94a3b8; border-bottom: 1px solid #f1f5f9; margin-bottom: 15px; padding-bottom: 5px; }

        .hidden { display: none; }
        #toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 10px 20px; border-radius: 50px;
            font-size: 0.9rem; display: none; z-index: 100;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div id="edit-ui">
            <h1>âœï¸ åˆ†äº«æ–°å†…å®¹</h1>
            <textarea id="text-input" placeholder="è¾“å…¥ä½ æƒ³åˆ†äº«çš„å†…å®¹..."></textarea>
            <input type="password" id="password-input" placeholder="è®¿é—®å¯†ç  (å¯é€‰)">
            <div class="btn-group">
                <button class="btn-primary" onclick="generate()">ç”Ÿæˆåˆ†äº«é“¾æ¥</button>
            </div>

            <div id="result-section">
                <p style="margin:0; font-size: 0.8rem; color: #64748b;">é“¾æ¥å·²ç”Ÿæˆ (ç‚¹å‡»æ¡†å†…å¤åˆ¶):</p>
                <div id="url-text" class="url-display" onclick="copyText(this.innerText)"></div>
                <button class="btn-secondary" id="shorten-btn" onclick="shorten()">âš¡ ç¼©çŸ­é“¾æ¥ (TinyURL)</button>
            </div>
        </div>

        <div id="unlock-ui" class="hidden">
            <h1>ğŸ”’ åŠ å¯†å†…å®¹</h1>
            <p style="text-align: center; color: #64748b;">è¯·è¾“å…¥å¯†ç ä»¥æŸ¥çœ‹æ­¤å†…å®¹</p>
            <input type="password" id="decrypt-pwd" placeholder="è¾“å…¥å¯†ç ">
            <button class="btn-primary" style="width:100%" onclick="unlock()">è§£é”é˜…è¯»</button>
        </div>

        <div id="view-ui" class="hidden">
            <div class="article-meta">ğŸ“– æ­£æ–‡è¯¦æƒ… | <span id="char-count">0</span> å­—</div>
            <div id="content-display" class="article"></div>
            <button class="btn-secondary" style="width:100%; margin-top: 30px;" onclick="location.href=location.pathname">æˆ‘ä¹Ÿè¦å†™</button>
        </div>
    </div>
</div>

<div id="toast">å·²å¤åˆ¶åˆ°å‰ªåˆ‡æ¿</div>

<script>
    const P_RAW = "r:"; // æ ‡è¯†æœªåŠ å¯†
    const P_ENC = "e:"; // æ ‡è¯†åŠ å¯†

    // 1. ç”Ÿæˆé“¾æ¥é€»è¾‘
    function generate() {
        const text = document.getElementById('text-input').value.trim();
        const pwd = document.getElementById('password-input').value;
        if (!text) return alert("å†…å®¹ä¸èƒ½ä¸ºç©º");

        let data = pwd ? P_ENC + CryptoJS.AES.encrypt(text, pwd).toString() : P_RAW + text;
        const compressed = LZString.compressToEncodedURIComponent(data);
        const fullUrl = window.location.origin + window.location.pathname + '#' + compressed;

        document.getElementById('result-section').style.display = 'block';
        document.getElementById('url-text').innerText = fullUrl;
        copyText(fullUrl);
    }

    // 2. ç¼©çŸ­é“¾æ¥é€»è¾‘ (è°ƒç”¨ TinyURL API)
    async function shorten() {
        const longUrl = document.getElementById('url-text').innerText;
        const btn = document.getElementById('shorten-btn');
        btn.innerText = "æ­£åœ¨ç¼©çŸ­...";
        btn.disabled = true;

        try {
            // é€šè¿‡ tinyurl æ¥å£è·å–çŸ­é“¾
            const res = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(longUrl)}`);
            if (res.ok) {
                const shortUrl = await res.text();
                document.getElementById('url-text').innerText = shortUrl;
                copyText(shortUrl);
                showToast("çŸ­é“¾æ¥å·²ç”Ÿæˆå¹¶å¤åˆ¶ï¼");
            } else { throw new Error(); }
        } catch (e) {
            showToast("ç¼©çŸ­å¤±è´¥ï¼Œå¯èƒ½å­˜åœ¨è·¨åŸŸé™åˆ¶ï¼Œè¯·ç›´æ¥ä½¿ç”¨é•¿é“¾æ¥");
        } finally {
            btn.innerText = "âš¡ ç¼©çŸ­é“¾æ¥ (TinyURL)";
            btn.disabled = false;
        }
    }

    // 3. é¡µé¢è§£æé€»è¾‘
    function init() {
        const hash = window.location.hash.substring(1);
        if (!hash) return;

        try {
            const data = LZString.decompressFromEncodedURIComponent(hash);
            if (data.startsWith(P_RAW)) {
                render(data.substring(2));
            } else {
                showSection('unlock');
            }
        } catch (e) { showToast("è§£æå¤±è´¥ï¼Œé“¾æ¥å¯èƒ½ä¸å®Œæ•´"); }
    }

    function unlock() {
        const hash = window.location.hash.substring(1);
        const pwd = document.getElementById('decrypt-pwd').value;
        try {
            const data = LZString.decompressFromEncodedURIComponent(hash).substring(2);
            const bytes = CryptoJS.AES.decrypt(data, pwd);
            const originalText = bytes.toString(CryptoJS.enc.Utf8);
            if (!originalText) throw new Error();
            render(originalText);
        } catch (e) { showToast("å¯†ç é”™è¯¯"); }
    }

    // è¾…åŠ©å‡½æ•°
    function render(text) {
        showSection('view');
        document.getElementById('content-display').textContent = text;
        document.getElementById('char-count').innerText = text.length;
    }

    function showSection(id) {
        ['edit', 'unlock', 'view'].forEach(s => document.getElementById(s+'-ui').classList.add('hidden'));
        document.getElementById(id+'-ui').classList.remove('hidden');
    }

    function copyText(text) {
        navigator.clipboard.writeText(text).then(() => showToast("å·²å¤åˆ¶åˆ°å‰ªåˆ‡æ¿"));
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2000);
    }

    window.onload = init;
</script>
</body>
</html>
